<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BottyOtty Quick Launch</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-content h1 {
        color: white;
        font-size: 32px;
        margin-bottom: 10px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
      }

      .nav-links {
        display: flex;
        gap: 10px;
      }

      .nav-link {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
      }

      .nav-link:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .panel h2 {
        color: white;
        font-size: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .icon {
        font-size: 24px;
      }

      textarea {
        width: 100%;
        min-height: 300px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        color: white;
        resize: vertical;
        transition: all 0.3s;
      }

      textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      textarea:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.8);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #e0e0e0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #d0d0d0;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
      }

      .btn-save {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        border: 2px solid #f59e0b;
      }

      .btn-save:hover {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
      }

      .preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 13px;
      }

      .preview-table th {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        font-weight: 600;
        color: white;
      }

      .preview-table td {
        padding: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
      }

      .preview-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }

      .status-success {
        background: #d1fae5;
        color: #065f46;
      }

      .status-error {
        background: #fee2e2;
        color: #991b1b;
      }

      .mapping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .column-map {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .column-map label {
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 5px;
        font-weight: 600;
      }

      .column-map select,
      .column-map input[type="text"] {
        width: 100%;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        font-size: 13px;
        color: white;
      }

      .column-map select option {
        background: #667eea;
        color: white;
      }

      .sample-value {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 5px;
        font-style: italic;
      }

      .mode-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .mode-btn {
        flex: 1;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
        color: rgba(255, 255, 255, 0.9);
      }

      .mode-btn.active {
        background: #667eea;
        color: white;
        border-color: rgba(102, 126, 234, 0.8);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .mode-btn:hover {
        border-color: rgba(102, 126, 234, 0.6);
        background: rgba(255, 255, 255, 0.15);
      }

      .mode-icon {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .mode-title {
        font-weight: 600;
        margin-bottom: 3px;
      }

      .mode-desc {
        font-size: 11px;
        opacity: 0.8;
      }

      /* Accordion Styles */
      .accordion {
        margin-bottom: 15px;
      }

      .accordion-header {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 20px 25px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
      }

      .accordion-header:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .accordion-header.active {
        background: #667eea;
        border-color: rgba(102, 126, 234, 0.8);
      }

      .accordion-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: 600;
        color: white;
      }

      .step-number {
        background: rgba(255, 255, 255, 0.2);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
      }

      .accordion-header.active .step-number {
        background: rgba(255, 255, 255, 0.3);
      }

      .accordion-header.completed .step-number {
        background: #10b981;
      }

      .accordion-arrow {
        font-size: 20px;
        transition: transform 0.3s;
      }

      .accordion-header.active .accordion-arrow {
        transform: rotate(180deg);
      }

      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .accordion-content.active {
        max-height: 5000px;
        padding-top: 20px;
      }

      .accordion-body {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 25px;
        margin-top: 10px;
      }

      select,
      input[type="text"],
      input[type="file"] {
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        cursor: pointer;
        transition: all 0.3s;
      }

      select option {
        background: #667eea;
        color: white;
      }

      select:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.8);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        backdrop-filter: blur(10px);
      }

      .alert-info {
        background: rgba(59, 130, 246, 0.2);
        color: #dbeafe;
        border-left: 4px solid #3b82f6;
      }

      .alert-success {
        background: rgba(16, 185, 129, 0.2);
        color: #d1fae5;
        border-left: 4px solid #10b981;
      }

      .alert-error {
        background: rgba(239, 68, 68, 0.2);
        color: #fee2e2;
        border-left: 4px solid #ef4444;
      }

      .alert-warning {
        background: rgba(245, 158, 11, 0.2);
        color: #fef3c7;
        border-left: 4px solid #f59e0b;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .scroll-container {
        max-height: 500px;
        overflow-y: auto;
      }

      .scroll-container::-webkit-scrollbar {
        width: 8px;
      }

      .scroll-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .scroll-container::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.8);
        border-radius: 4px;
      }

      .scroll-container::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 1);
      }

      .grouped-task {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
      }

      .grouped-task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .tech-name {
        font-weight: 600;
        font-size: 16px;
        color: #333;
      }

      .appointment-count {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
      }

      .appointment-list {
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #666;
        white-space: pre-line;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
        display: none;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s;
        width: 0%;
      }

      .template-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
      }

      .template-item:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .template-info {
        flex: 1;
      }

      .template-name {
        font-weight: 600;
        font-size: 14px;
        color: #333;
        margin-bottom: 5px;
      }

      .template-meta {
        font-size: 12px;
        color: #666;
      }

      .template-actions {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      .destination-selector {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        border: 2px solid #e0e0e0;
      }

      .destination-selector label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 600;
      }

      input[type="text"] {
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 13px;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
      }

      .permission-error {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
      }

      .permission-error h2 {
        color: #ef4444;
        font-size: 24px;
        margin-bottom: 15px;
      }

      .permission-error p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      /* ========================================
       ğŸ¨ CUSTOMIZATION PANEL
       ======================================== */

      #customizationPanel {
        position: fixed;
        top: 0;
        right: 0;
        width: 420px;
        height: 100vh;
        background: rgba(15, 15, 35, 0.98);
        backdrop-filter: blur(20px);
        border-left: 2px solid var(--border);
        z-index: 9999;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
        transition: transform 0.4s ease;
        overflow-y: auto;
      }

      #customizationPanel.minimized {
        transform: translateX(100%);
      }

      #customizeToggleBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        box-shadow: 0 2px 12px rgba(99, 102, 241, 0.3);
        transition: all 0.3s ease;
        opacity: 0.8;
      }

      #customizeToggleBtn:hover {
        transform: scale(1.15);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.5);
        opacity: 1;
      }

      #customizationPanel:not(.minimized) ~ #customizeToggleBtn {
        right: 440px;
      }

      .customize-inner {
        padding: 30px 24px;
      }

      .customize-header {
        margin-bottom: 30px;
      }

      .customize-header h1 {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 16px;
      }

      .user-mode-toggle {
        display: flex;
        gap: 10px;
        align-items: center;
        background: var(--surface);
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .user-mode-toggle label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: var(--surface);
        border-radius: 13px;
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-switch.active {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        border-color: var(--primary);
      }

      .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .toggle-switch.active .toggle-slider {
        transform: translateX(24px);
      }

      .mode-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--primary);
      }

      .customize-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .customize-section h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .preset-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .preset-btn {
        background: var(--surface);
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .preset-btn:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        transform: translateX(4px);
        box-shadow: var(--shadow-lg);
      }

      .preset-btn.active {
        border-color: var(--primary);
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.2) 0%,
          rgba(236, 72, 153, 0.2) 100%
        );
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
      }

      .preset-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .preset-desc {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .color-preview {
        display: flex;
        gap: 6px;
        margin-top: 10px;
      }

      .color-dot {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 2px solid var(--border);
      }

      .saved-indicator {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        font-weight: 600;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 10001;
      }

      .saved-indicator.show {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 1400px) {
        #customizationPanel {
          width: 360px;
        }

        #customizationPanel:not(.minimized) ~ #customizeToggleBtn {
          right: 380px;
        }
      }

      /* ========================================
       ğŸ“ LAYOUT STYLES
       ======================================== */

      :root {
        /* Layout Variables (dynamically updated) */
        --layout-spacing: 32px;
        --card-border-radius: 16px;
        --card-padding: 32px;
        --card-gap: 24px;
      }

      /* Apply layout variables to containers */
      #root > div {
        padding: var(--layout-spacing);
      }

      /* Minimalist Clean Layout */
      body.layout-minimalist .section-card,
      body.layout-minimalist .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
      }

      body.layout-minimalist .mb-4,
      body.layout-minimalist .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      /* Bold Card-Based Layout */
      body.layout-bold-card .section-card,
      body.layout-bold-card .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      body.layout-bold-card .mb-4,
      body.layout-bold-card .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      /* Dashboard Grid Layout */
      body.layout-dashboard-grid .section-card,
      body.layout-dashboard-grid .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
      }

      body.layout-dashboard-grid .mb-4,
      body.layout-dashboard-grid .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      body.layout-dashboard-grid #root > div {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--card-gap);
      }

      /* List View Clean Layout */
      body.layout-list-view .section-card,
      body.layout-list-view .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
      }

      body.layout-list-view .mb-4,
      body.layout-list-view .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      body.layout-list-view .section-card {
        display: flex;
        flex-direction: column;
        gap: calc(var(--card-gap) / 2);
      }

      /* ========================================
         ğŸ§­ SIDEBAR NAVIGATION
         ======================================== */

      #sidebarNav {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        background: rgba(15, 15, 35, 0.98);
        backdrop-filter: blur(20px);
        border-right: 2px solid rgba(255, 255, 255, 0.1);
        z-index: 9998;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        transition: all 0.4s ease;
        overflow-y: auto;
        overflow-x: hidden;
      }

      #sidebarNav:not(.collapsed) { width: 280px; }
      #sidebarNav.collapsed { width: 70px; }

      #sidebarNav.collapsed .nav-item-label,
      #sidebarNav.collapsed .sidebar-header-text,
      #sidebarNav.collapsed .sidebar-footer-text {
        opacity: 0;
        width: 0;
        overflow: hidden;
      }

      .sidebar-inner {
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .sidebar-header {
        padding: 0 20px 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .sidebar-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .sidebar-logo {
        font-size: 32px;
        flex-shrink: 0;
      }

      .sidebar-header-text {
        transition: all 0.4s ease;
        white-space: nowrap;
      }

      .sidebar-header-text h2 {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
      }

      .sidebar-header-text p {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        margin: 2px 0 0 0;
      }

      .sidebar-nav-items {
        flex: 1;
        padding: 0 12px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        margin-bottom: 8px;
        border-radius: 12px;
        text-decoration: none;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
        border: 1px solid transparent;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateX(4px);
      }

      .nav-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(236, 72, 153, 0.3) 100%);
        color: white;
        border-color: rgba(102, 126, 234, 0.5);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      /* When collapsed, show active state as left border only */
      #sidebarNav.collapsed .nav-item.active {
        background: transparent;
        border: 1px solid transparent;
        border-left: 4px solid #667eea;
        box-shadow: none;
        padding-left: 13px;
      }

      .nav-item-icon {
        font-size: 22px;
        flex-shrink: 0;
        width: 24px;
        text-align: center;
      }

      .nav-item-label {
        font-weight: 600;
        font-size: 15px;
        white-space: nowrap;
        transition: all 0.4s ease;
      }

      .sidebar-footer {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: auto;
      }

      .sidebar-toggle-btn {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
      }

      .sidebar-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .sidebar-footer-text {
        transition: all 0.4s ease;
        white-space: nowrap;
      }

      /* Adjust main content when sidebar is expanded */
      body:not(.sidebar-collapsed) .container {
        margin-left: 280px;
        transition: margin-left 0.4s ease;
      }

      body.sidebar-collapsed .container {
        margin-left: 70px;
        transition: margin-left 0.4s ease;
      }

      /* Responsive behavior */
      @media (max-width: 1024px) {
        #sidebarNav:not(.collapsed) { width: 280px; }
        body:not(.sidebar-collapsed) .container { margin-left: 0; }
        body.sidebar-collapsed .container { margin-left: 0; }
        #sidebarNav.collapsed { transform: translateX(-100%); }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar Navigation -->
    <div id="sidebarNav" class="">
      <div class="sidebar-inner">
        <div class="sidebar-header">
          <div class="sidebar-header-content">
            <div class="sidebar-logo">ğŸ¤–</div>
            <div class="sidebar-header-text">
              <h2>BottyOtty</h2>
              <p>Task Manager</p>
            </div>
          </div>
        </div>

        <div class="sidebar-nav-items">
          <!-- Dashboard - Mark as active on Dashboard page -->
          <a href="BottyOtty Dashboard v18.html" class="nav-item">
            <span class="nav-item-icon">ğŸ“Š</span>
            <span class="nav-item-label">Dashboard</span>
          </a>

          <!-- Admin Panel - Mark as active on Admin page -->
          <a href="Admin Panel v18.html" class="nav-item">
            <span class="nav-item-icon">âš™ï¸</span>
            <span class="nav-item-label">Admin Panel</span>
          </a>

          <!-- Quick Launch - Mark as active on Quick Launch page -->
          <a href="Quick Launch v18.html" class="nav-item active">
            <span class="nav-item-icon">ğŸš€</span>
            <span class="nav-item-label">Quick Launch</span>
          </a>

          <!-- Reports - Mark as active on Reports page -->
          <a href="BottyOtty Reports v18.html" class="nav-item">
            <span class="nav-item-icon">ğŸ“ˆ</span>
            <span class="nav-item-label">Reports</span>
          </a>

          <!-- Help - Mark as active on Help page -->
          <a href="BottyOtty Help & User Guide v18.html" class="nav-item">
            <span class="nav-item-icon">â“</span>
            <span class="nav-item-label">Help Guide</span>
          </a>
        </div>

        <div class="sidebar-footer">
          <button onclick="toggleSidebar()" class="sidebar-toggle-btn">
            <span id="sidebarToggleIcon">â†</span>
            <span class="sidebar-footer-text" id="sidebarToggleText">Collapse</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Customization Toggle Button -->
    <button id="customizeToggleBtn" onclick="toggleCustomizationPanel()">
      âš™ï¸
    </button>

    <!-- Customization Panel -->
    <div id="customizationPanel" class="minimized">
      <div class="customize-inner">
        <div class="customize-header">
          <h1>ğŸ¨ Customization</h1>
          <div class="user-mode-toggle">
            <label>View as:</label>
            <div
              class="toggle-switch"
              id="userModeToggle"
              onclick="toggleUserMode()"
            >
              <div class="toggle-slider"></div>
            </div>
            <span class="mode-label" id="modeLabel">Admin</span>
          </div>
        </div>

        <!-- Theme Presets -->
        <div class="customize-section">
          <h2>ğŸ¨ Theme Presets</h2>
          <div class="preset-grid">
            <div
              class="preset-btn active"
              onclick="applyTheme('dark-mode', true, event)"
            >
              <div class="preset-name">Dark Mode</div>
              <div class="preset-desc">Professional navy & orange</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #324973"></div>
                <div class="color-dot" style="background: #f37b28"></div>
                <div class="color-dot" style="background: #001541"></div>
              </div>
            </div>

            <div
              class="preset-btn"
              onclick="applyTheme('light-clean', true, event)"
            >
              <div class="preset-name">Light & Clean</div>
              <div class="preset-desc">White background, navy text</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #ffffff"></div>
                <div class="color-dot" style="background: #324973"></div>
                <div class="color-dot" style="background: #ff8b01"></div>
              </div>
            </div>

            <div
              class="preset-btn"
              onclick="applyTheme('warm-welcoming', true, event)"
            >
              <div class="preset-name">Warm & Welcoming</div>
              <div class="preset-desc">Light orange tints</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #fff5eb"></div>
                <div class="color-dot" style="background: #ffbc6c"></div>
                <div class="color-dot" style="background: #324973"></div>
              </div>
            </div>

            <div
              class="preset-btn"
              onclick="applyTheme('premium-dark', true, event)"
            >
              <div class="preset-name">Premium Dark</div>
              <div class="preset-desc">Dark navy with glows</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #001541"></div>
                <div class="color-dot" style="background: #ff8b01"></div>
                <div class="color-dot" style="background: #566685"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout Options -->
        <div class="customize-section">
          <h2>ğŸ“ Layout Options</h2>
          <div class="preset-grid">
            <div
              class="preset-btn active"
              onclick="applyLayout('minimalist', true, event)"
            >
              <div class="preset-name">Minimalist Clean</div>
              <div class="preset-desc">Spacious & simple</div>
            </div>

            <div
              class="preset-btn"
              onclick="applyLayout('bold-card', true, event)"
            >
              <div class="preset-name">Bold Card-Based</div>
              <div class="preset-desc">Strong visual cards</div>
            </div>

            <div
              class="preset-btn"
              onclick="applyLayout('dashboard-grid', true, event)"
            >
              <div class="preset-name">Dashboard Grid</div>
              <div class="preset-desc">Organized grid layout</div>
            </div>

            <div
              class="preset-btn"
              onclick="applyLayout('list-view', true, event)"
            >
              <div class="preset-name">List View Clean</div>
              <div class="preset-desc">Compact list format</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved Indicator -->
    <div class="saved-indicator" id="savedIndicator">âœ“ Preferences Saved</div>

    <div id="permissionError" style="display: none">
      <div class="permission-error">
        <h2>ğŸ”’ Access Denied</h2>
        <p>
          You don't have permission to access Quick Launch. This tool requires
          the <strong>canBulkImport</strong> permission.
        </p>
        <p>Please contact an administrator if you need access.</p>
        <a href="BottyOtty Dashboard v18.html" class="nav-link"
          >â† Back to Dashboard</a
        >
      </div>
    </div>

    <div class="container" id="mainContent" style="display: none">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <h1>ğŸš€ Quick Launch</h1>
          <p class="subtitle">
            Bulk Task Import & Assignment Tool â€¢ Logged in as:
            <strong id="currentUser">Loading...</strong>
          </p>
        </div>
        <div class="nav-links">
          <a href="BottyOtty Dashboard v18.html" class="nav-link"
            >â† Dashboard</a
          >
          <a
            href="Admin Panel v18.html"
            class="nav-link"
            id="adminLink"
            style="display: none"
            >âš™ï¸ Admin</a
          >
        </div>
      </div>

      <!-- Step-Based Accordion Workflow -->

      <!-- Step 1: Data Input -->
      <div class="accordion">
        <div
          class="accordion-header active"
          id="step1-header"
          onclick="toggleAccordion('step1')"
        >
          <div class="accordion-title">
            <span class="step-number">1</span>
            <span id="step1-title">Data Input</span>
          </div>
          <div class="accordion-arrow">â–¼</div>
        </div>
        <div class="accordion-content active" id="step1-content">
          <div class="accordion-body">
            <!-- Select Preset -->
            <div style="margin-bottom: 25px">
              <h3 style="color: white; font-size: 16px; margin-bottom: 10px">
                ğŸ¯ Select Preset (Optional)
              </h3>
              <div class="alert alert-info">
                <strong>Select a preset</strong> to auto-configure channel and
                user tags for recurring reports, or skip to import normally.
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 2fr 1fr;
                  gap: 15px;
                  align-items: start;
                "
              >
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 8px;
                      font-weight: 600;
                      color: white;
                    "
                    >Report Type</label
                  >
                  <select
                    id="reportPresetSelect"
                    onchange="selectReportPreset()"
                    style="
                      width: 100%;
                      padding: 12px;
                      font-size: 14px;
                      background: rgba(255, 255, 255, 0.1);
                      border: 1px solid rgba(255, 255, 255, 0.3);
                      color: white;
                      border-radius: 8px;
                    "
                  >
                    <option value="">-- No Preset (Normal Import) --</option>
                  </select>
                </div>
                <div
                  id="presetInfo"
                  style="
                    background: rgba(255, 255, 255, 0.1);
                    padding: 15px;
                    border-radius: 8px;
                    display: none;
                  "
                >
                  <div
                    style="font-size: 12px; color: white; margin-bottom: 8px"
                  >
                    <strong>Channel:</strong> <span id="presetChannel">-</span>
                  </div>
                  <div
                    style="font-size: 12px; color: white; margin-bottom: 8px"
                  >
                    <strong>Tags:</strong> <span id="presetTags">-</span>
                  </div>
                  <div style="font-size: 12px; color: white">
                    <strong>Priority:</strong>
                    <span id="presetPriority">-</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upload or Paste -->
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px"
            >
              <!-- File Upload -->
              <div>
                <h3 style="color: white; font-size: 16px; margin-bottom: 10px">
                  ğŸ“ Upload File
                </h3>
                <input
                  type="file"
                  id="fileInput"
                  accept=".csv,.xls,.xlsx"
                  onchange="handleFileUpload(event)"
                  style="
                    width: 100%;
                    padding: 10px;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 8px;
                    color: white;
                  "
                />
              </div>

              <!-- Paste Data -->
              <div>
                <h3 style="color: white; font-size: 16px; margin-bottom: 10px">
                  ğŸ“‹ Or Paste Data
                </h3>
                <textarea
                  id="csvInput"
                  placeholder="Paste your data here (tab or comma separated)..."
                  style="min-height: 200px"
                ></textarea>
              </div>
            </div>

            <div class="button-group" style="margin-top: 20px">
              <button class="btn-primary" onclick="parseData()">
                ğŸ” Parse & Preview Data
              </button>
              <button class="btn-secondary" onclick="loadSavedData()">
                ğŸ“‚ Load Saved Session
              </button>
              <button class="btn-secondary" onclick="clearAll()">
                ğŸ—‘ï¸ Clear All
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Preview & Column Mapping -->
      <div class="accordion">
        <div
          class="accordion-header"
          id="step2-header"
          onclick="toggleAccordion('step2')"
        >
          <div class="accordion-title">
            <span class="step-number">2</span>
            <span>Preview & Column Mapping</span>
          </div>
          <div class="accordion-arrow">â–¼</div>
        </div>
        <div class="accordion-content" id="step2-content">
          <div class="accordion-body">
            <!-- Grouping Mode -->
            <div style="margin-bottom: 20px">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  font-weight: 600;
                  color: white;
                  font-size: 13px;
                "
                >âš™ï¸ Grouping Mode</label
              >
              <div class="mode-toggle">
                <div
                  class="mode-btn"
                  onclick="selectMode('grouped-person')"
                  id="mode-grouped-person"
                >
                  <div class="mode-icon">ğŸ‘¤</div>
                  <div class="mode-title">Grouped by Person</div>
                  <div class="mode-desc">Group items per person</div>
                </div>
                <div
                  class="mode-btn"
                  onclick="selectMode('grouped-type')"
                  id="mode-grouped-type"
                >
                  <div class="mode-icon">ğŸ“¦</div>
                  <div class="mode-title">Grouped by Type</div>
                  <div class="mode-desc">Group by category/type</div>
                </div>
                <div
                  class="mode-btn active"
                  onclick="selectMode('individual')"
                  id="mode-individual"
                >
                  <div class="mode-icon">ğŸ“„</div>
                  <div class="mode-title">Individual Items</div>
                  <div class="mode-desc">1 row = 1 item</div>
                </div>
              </div>
            </div>

            <!-- Data Preview -->
            <div style="margin-bottom: 25px">
              <h3 style="color: white; font-size: 16px; margin-bottom: 10px">
                ğŸ‘ï¸ Data Preview
              </h3>
              <div id="previewContainer" class="scroll-container">
                <div
                  style="
                    text-align: center;
                    padding: 60px 20px;
                    color: rgba(255, 255, 255, 0.5);
                  "
                >
                  <div style="font-size: 48px; margin-bottom: 15px">ğŸ“„</div>
                  <p>Parse your data to see preview</p>
                </div>
              </div>
            </div>

            <!-- Row Filtering -->
            <div
              id="rowFilteringSection"
              style="display: none; margin-bottom: 25px"
            >
              <h3 style="color: white; font-size: 16px; margin-bottom: 10px">
                âœ“ Include/Exclude Rows
              </h3>
              <div class="alert alert-info">
                <strong>Filter data before sending.</strong> Uncheck rows you
                want to exclude from import.
              </div>
              <div id="rowFilteringContainer"></div>
            </div>

            <!-- Column Mapping -->
            <div id="columnMappingSection" style="display: none">
              <h3 style="color: white; font-size: 16px; margin-bottom: 10px">
                ğŸ¯ Column Mapping
              </h3>
              <div class="alert alert-info">
                <strong>Smart column detection active.</strong> Columns are
                automatically mapped - click any dropdown to override. Required
                fields are marked with *.
              </div>
              <div id="columnMappingContainer"></div>

              <div class="button-group" style="margin-top: 20px">
                <button class="btn-primary" onclick="proceedToAssignment()">
                  âœ¨ Generate Assignments
                </button>
                <button
                  class="btn-secondary"
                  onclick="toggleAccordion('step2b')"
                >
                  ğŸ’¾ Save Mapping Preset
                </button>
                <button class="btn-save" onclick="saveCurrentSession()">
                  ğŸ’¾ Save Session for Later
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2b: Preset Management -->
      <div class="accordion">
        <div
          class="accordion-header"
          id="step2b-header"
          onclick="toggleAccordion('step2b')"
        >
          <div class="accordion-title">
            <span class="step-number">2b</span>
            <span>Presets</span>
          </div>
          <div class="accordion-arrow">â–¼</div>
        </div>
        <div class="accordion-content" id="step2b-content">
          <div class="accordion-body">
            <div class="alert alert-info">
              <strong>Save time with presets!</strong> Create presets for
              recurring imports where column mapping is always the same.
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 20px;
                margin-top: 15px;
              "
            >
              <div>
                <h3
                  style="
                    font-size: 14px;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: white;
                  "
                >
                  Saved Presets
                </h3>
                <div id="templateList">
                  <div
                    style="
                      text-align: center;
                      padding: 40px;
                      color: rgba(255, 255, 255, 0.5);
                    "
                  >
                    <div style="font-size: 48px; margin-bottom: 10px">ğŸ“‹</div>
                    <p>No saved presets yet</p>
                  </div>
                </div>
              </div>
              <div>
                <h3
                  style="
                    font-size: 14px;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: white;
                  "
                >
                  Save Current Mapping
                </h3>
                <input
                  type="text"
                  id="templateName"
                  placeholder="Preset name..."
                  style="
                    width: 100%;
                    margin-bottom: 10px;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white;
                  "
                />
                <button
                  class="btn-primary"
                  onclick="saveTemplate()"
                  style="width: 100%"
                >
                  ğŸ’¾ Save Preset
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Assignments -->
      <div class="accordion">
        <div
          class="accordion-header"
          id="step3-header"
          onclick="toggleAccordion('step3')"
        >
          <div class="accordion-title">
            <span class="step-number">3</span>
            <span id="step3-title">Assignments</span>
          </div>
          <div class="accordion-arrow">â–¼</div>
        </div>
        <div class="accordion-content" id="step3-content">
          <div class="accordion-body">
            <div class="alert alert-warning">
              <strong>âš ï¸ Target Destination Override:</strong> Tasks will post
              to each assignee's default channel unless you override below.
            </div>

            <div id="assignmentContainer" class="scroll-container"></div>

            <div class="button-group" style="margin-top: 20px">
              <button class="btn-success" onclick="bulkAssign()">
                ğŸš€ Create & Assign All Tasks
              </button>
              <button class="btn-secondary" onclick="backToDataInput()">
                â—€ï¸ Need to edit? Go back to input
              </button>
              <button class="btn-save" onclick="saveCurrentSession()">
                ğŸ’¾ Save for Later
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Summary -->
      <div class="accordion">
        <div
          class="accordion-header"
          id="step4-header"
          onclick="toggleAccordion('step4')"
        >
          <div class="accordion-title">
            <span class="step-number">4</span>
            <span>Summary</span>
          </div>
          <div class="accordion-arrow">â–¼</div>
        </div>
        <div class="accordion-content" id="step4-content">
          <div class="accordion-body">
            <div class="progress-bar" id="progressBar" style="display: none">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="resultsContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const BOT_CONFIG = {
        apiUrl: "http://localhost:5000",
        apiKey: "",
      };

      const STORAGE_KEY_USER = "bottyotty-current-user";
      const STORAGE_KEY_TEMPLATES = "bottyotty-import-templates";

      // Team members (39 members - synced with Admin Panel and Dashboard)
      const TEAM_MEMBERS = [
        { name: "Dakota", discordId: "220326831524544513" },
        { name: "Preston", discordId: "1060679174945259520" },
        { name: "Dahlya", discordId: "367146081248608257" },
        { name: "Araceli", discordId: "343265486919958529" },
        { name: "Terry", discordId: "528700749555957771" },
        { name: "Cole", discordId: "1317654177412939799" },
        { name: "Devin", discordId: "680757425514479662" },
        { name: "Tony", discordId: "1351211310796242977" },
        { name: "Chase", discordId: "1297804315041333354" },
        { name: "Megan", discordId: "928725439059464222" },
        { name: "Adam", discordId: "353922166250799106" },
        { name: "Amanda", discordId: "1203398569575452745" },
        { name: "Ash", discordId: "289212918615244801" },
        { name: "Caleb", discordId: "423987581483483146" },
        { name: "Charles", discordId: "262990512506667009" },
        { name: "Dylan", discordId: "1229532562200723556" },
        { name: "Edward", discordId: "1277407641479548928" },
        { name: "Fernando", discordId: "1242209699135230012" },
        { name: "Hector", discordId: "1102917622443540511" },
        { name: "Isiac", discordId: "1167611497812340813" },
        { name: "Jeff", discordId: "1239615123765596291" },
        { name: "Joey", discordId: "1228184859772588042" },
        { name: "Jose", discordId: "1060679251235442719" },
        { name: "Matt Kiger", discordId: "792234508736135178" },
        { name: "Lauren", discordId: "931331954220101632" },
        { name: "Logan", discordId: "934632146134519820" },
        { name: "Nathaniel", discordId: "765857167290662913" },
        { name: "Presley", discordId: "1189283572100645005" },
        { name: "Rachel", discordId: "1363874133410189443" },
        { name: "Rafael", discordId: "1354099291177750690" },
        { name: "Raymond", discordId: "1281670710271410279" },
        { name: "Ric", discordId: "1363551896530587760" },
        { name: "Ryan M", discordId: "326967402606624769" },
        { name: "Ryan P", discordId: "1422223702040383529" },
        { name: "Sam", discordId: "883800050524905552" },
        { name: "Sean", discordId: "1385598726361583616" },
        { name: "Summer", discordId: "908784314056052748" },
        { name: "Trevor", discordId: "1127672956051525755" },
        { name: "Tyler", discordId: "1119490397626974280" },
      ];

      // Personal assignment channels (To-Dos and RoundTables)
      const PERSONAL_CHANNELS = {
        // To-Dos
        Ash: "1392524881723392040",
        Preston: "1378435914375757865",
        Presley: "1378435889507733655",
        Joey: "1378435818745499781",
        Jeff: "1378435776823562473",
        Dakota: "1378435732338643066",
        Adam: "1378435680555765841",
        // RoundTables
        Dahlya: "1364145512344981515",
        Araceli: "1364145395956977705",
        Terry: "1364146225959403520",
        Cole: "1427801942327038002",
        Devin: "1364145559119597638",
        Amanda: "1425968878848311326",
        Caleb: "1364145445017882634",
        Charles: "1437224826703056996",
        Dylan: "1364145584524759121",
        Edward: "1425939780025192498",
        Fernando: "1437224785632428062",
        Hector: "1364145633333739590",
        Isiac: "1364145675700273274",
        Jose: "1364145746693324830",
        "Matt Kiger": "1364145899839815690",
        Logan: "1387470240988008551",
        Nathaniel: "1364145942231519262",
        Rachel: "1364146051338211388",
        Rafael: "1364146128861528186",
        Raymond: "1387465577035202661",
        Ric: "1399765599542050816",
        "Ryan M": "1364146186658910259",
        "Ryan P": "1425941108889751712",
        Sam: "1364317982985031711",
        Sean: "1387465649772826664",
        Summer: "1364146209895223337",
        Tony: "1364146256292610110",
        Trevor: "1364146273191460934",
        Tyler: "1364146301805269063",
      };

      // Report Presets
      const REPORT_PRESETS = [
        {
          name: "Tech Collections",
          channelId: "1359911766594683093",
          tagUsers: [],
          category: "Collections",
          priority: "high",
          description: "Collection tasks for service techs",
        },
        {
          name: "Pending Appointments (Ryan)",
          channelId: "1364146186658910259",
          tagUsers: ["Ryan M"],
          category: "Appointments",
          priority: "medium",
          description: "Pending appointments for Ryan McGuire",
        },
      ];

      let currentUser = null;
      let currentMode = "individual";
      let parsedData = null;
      let columnMappings = {};
      let selectedPreset = null;
      let savedTemplates = [];
      let messagesHaveBeenSent = false;
      let assignmentLog = [];
      const STORAGE_KEY_SAVED_DATA = "bottyotty-quick-launch-saved-data";
      let rowInclusionMap = []; // Track which rows to include/exclude
      let dataSaved = false; // Track if current session has been saved

      // ===== ACCORDION CONTROL FUNCTIONS =====

      function toggleAccordion(step) {
        const header = document.getElementById(`${step}-header`);
        const content = document.getElementById(`${step}-content`);

        const isActive = header.classList.contains("active");

        if (isActive) {
          header.classList.remove("active");
          content.classList.remove("active");
        } else {
          header.classList.add("active");
          content.classList.add("active");
        }
      }

      function openStep(step) {
        const header = document.getElementById(`${step}-header`);
        const content = document.getElementById(`${step}-content`);
        header.classList.add("active");
        content.classList.add("active");

        // Mark as completed if opening a later step
        if (step === "step2" || step === "step3" || step === "step4") {
          document.getElementById("step1-header").classList.add("completed");
        }
        if (step === "step3" || step === "step4") {
          document.getElementById("step2-header").classList.add("completed");
        }
        if (step === "step4") {
          document.getElementById("step3-header").classList.add("completed");
        }
      }

      function closeStep(step) {
        const header = document.getElementById(`${step}-header`);
        const content = document.getElementById(`${step}-content`);
        header.classList.remove("active");
        content.classList.remove("active");
      }

      function updateStep1Title() {
        const titleElem = document.getElementById("step1-title");
        if (selectedPreset) {
          titleElem.textContent = `Data Input - ${selectedPreset.name}`;
        } else {
          titleElem.textContent = "Data Input";
        }
      }

      function backToDataInput() {
        // Keep step 3 open, go back to step 1
        openStep("step1");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Initialize page
      window.addEventListener("DOMContentLoaded", function () {
        loadUser();
        loadTemplates();
        populatePresetDropdown();
      });

      // Warn before leaving if data not saved and not sent
      window.addEventListener("beforeunload", function (e) {
        // Only prompt if: data exists AND not saved AND not sent
        if (
          parsedData &&
          parsedData.rows &&
          parsedData.rows.length > 0 &&
          !dataSaved &&
          !messagesHaveBeenSent
        ) {
          e.preventDefault();
          e.returnValue =
            "Changes you made may not be saved. Please save now at bottom of page or your data will be lost.";
          return e.returnValue;
        }
      });

      function loadUser() {
        const storedUser = localStorage.getItem(STORAGE_KEY_USER);

        if (!storedUser) {
          // No user logged in - show error
          document.getElementById("permissionError").style.display = "block";
          document.getElementById("mainContent").style.display = "none";
          return;
        }

        currentUser = JSON.parse(storedUser);

        // Load permissions from separate storage
        const storedPermissions = localStorage.getItem(
          "bottyotty-user-permissions",
        );
        let userPermissions = {};
        if (storedPermissions) {
          try {
            const allPermissions = JSON.parse(storedPermissions);
            userPermissions = allPermissions[currentUser.name] || {};
          } catch (e) {
            console.error("Failed to load permissions:", e);
          }
        }

        console.log("Quick Launch - User:", currentUser.name);
        console.log("Quick Launch - Permissions:", userPermissions);
        console.log(
          "Quick Launch - canBulkImport:",
          userPermissions.canBulkImport,
        );

        // Check permission from loaded permissions
        if (!userPermissions.canBulkImport) {
          console.error(
            "Access denied: canBulkImport is",
            userPermissions.canBulkImport,
          );
          document.getElementById("permissionError").style.display = "block";
          document.getElementById("mainContent").style.display = "none";
          return;
        }

        // User has permission
        document.getElementById("permissionError").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("currentUser").textContent =
          currentUser.name || "Unknown";

        // Show admin link if user is admin
        if (userPermissions.isAdmin) {
          document.getElementById("adminLink").style.display = "inline-block";
        }
      }

      function loadTemplates() {
        const stored = localStorage.getItem(STORAGE_KEY_TEMPLATES);
        if (stored) {
          savedTemplates = JSON.parse(stored);
          renderTemplates();
        }
      }

      function saveTemplate() {
        const templateName = document
          .getElementById("templateName")
          .value.trim();

        if (!templateName) {
          alert("Please enter a template name");
          return;
        }

        if (!parsedData || !columnMappings) {
          alert("Please parse and map data first");
          return;
        }

        const template = {
          id: Date.now(),
          name: templateName,
          mappings: { ...columnMappings },
          mode: currentMode,
          preset: selectedPreset ? { ...selectedPreset } : null,
          createdAt: new Date().toISOString(),
        };

        savedTemplates.push(template);
        localStorage.setItem(
          STORAGE_KEY_TEMPLATES,
          JSON.stringify(savedTemplates),
        );

        document.getElementById("templateName").value = "";
        renderTemplates();

        alert(`âœ… Template "${templateName}" saved!`);
      }

      function loadTemplate(templateId) {
        const template = savedTemplates.find((t) => t.id === templateId);
        if (!template) return;

        columnMappings = { ...template.mappings };

        // Migrate old "tech" field to "person" if needed
        if (
          columnMappings.tech !== undefined &&
          columnMappings.person === undefined
        ) {
          columnMappings.person = columnMappings.tech;
          delete columnMappings.tech;
        }

        currentMode = template.mode || "individual";

        // Migrate old mode names
        if (currentMode === "grouped") {
          currentMode = "grouped-person";
        }

        selectedPreset = template.preset;

        // Update mode buttons
        selectMode(currentMode);

        // Update preset dropdown
        if (selectedPreset) {
          const presetIndex = REPORT_PRESETS.findIndex(
            (p) => p.name === selectedPreset.name,
          );
          if (presetIndex >= 0) {
            document.getElementById("reportPresetSelect").value = presetIndex;
            selectReportPreset();
          }
        }

        alert(
          `âœ… Template "${template.name}" loaded! Parse your data to apply mappings.`,
        );
      }

      function deleteTemplate(templateId) {
        // Check if user has permission to delete presets
        const storedPermissions = localStorage.getItem(
          "bottyotty-user-permissions",
        );
        let canDelete = false;
        if (storedPermissions) {
          try {
            const allPermissions = JSON.parse(storedPermissions);
            const userPerms = allPermissions[currentUser.name] || {};
            // Check both canDeletePresets permission and isAdmin (admins always can delete)
            canDelete =
              userPerms.canDeletePresets || userPerms.isAdmin || false;
          } catch (e) {
            console.error("Failed to load permissions:", e);
          }
        }

        if (!canDelete) {
          alert(
            "âŒ You don't have permission to delete presets. Contact an admin if you need this access.",
          );
          return;
        }

        if (!confirm("Delete this template?")) return;

        savedTemplates = savedTemplates.filter((t) => t.id !== templateId);
        localStorage.setItem(
          STORAGE_KEY_TEMPLATES,
          JSON.stringify(savedTemplates),
        );
        renderTemplates();
      }

      function renderTemplates() {
        const container = document.getElementById("templateList");

        if (savedTemplates.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“‹</div>
                        <p>No saved templates yet</p>
                    </div>
                `;
          return;
        }

        let html = "";
        savedTemplates.forEach((template) => {
          html += `
                    <div class="template-item">
                        <div class="template-info">
                            <div class="template-name">${template.name}</div>
                            <div class="template-meta">
                                Mode: ${template.mode} |
                                Preset: ${template.preset ? template.preset.name : "None"} |
                                Saved: ${new Date(template.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-primary btn-small" onclick="loadTemplate(${template.id})">ğŸ“¥ Load</button>
                            <button class="btn-danger btn-small" onclick="deleteTemplate(${template.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      function populatePresetDropdown() {
        const presetSelect = document.getElementById("reportPresetSelect");
        REPORT_PRESETS.forEach((preset, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = preset.name;
          presetSelect.appendChild(option);
        });
      }

      function selectReportPreset() {
        const presetSelect = document.getElementById("reportPresetSelect");
        const presetIndex = presetSelect.value;

        if (presetIndex === "") {
          selectedPreset = null;
          document.getElementById("presetInfo").style.display = "none";
          updateStep1Title();
          return;
        }

        selectedPreset = REPORT_PRESETS[presetIndex];

        document.getElementById("presetInfo").style.display = "block";
        document.getElementById("presetChannel").textContent =
          selectedPreset.channelId;
        document.getElementById("presetTags").textContent =
          selectedPreset.tagUsers.length > 0
            ? selectedPreset.tagUsers.join(", ")
            : "None";
        document.getElementById("presetPriority").textContent =
          selectedPreset.priority.toUpperCase();

        // Update Step 1 title to show preset name
        updateStep1Title();
      }

      function selectMode(mode) {
        currentMode = mode;
        document
          .getElementById("mode-individual")
          .classList.toggle("active", mode === "individual");
        document
          .getElementById("mode-grouped-person")
          .classList.toggle("active", mode === "grouped-person");
        document
          .getElementById("mode-grouped-type")
          .classList.toggle("active", mode === "grouped-type");
      }

      // File upload handler
      async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();

        try {
          let text;
          if (fileName.endsWith(".csv")) {
            text = await file.text();
          } else if (fileName.endsWith(".xls") || fileName.endsWith(".xlsx")) {
            // For Excel files, read as text (simplified - assumes CSV export)
            // In production, you'd use a library like SheetJS
            text = await file.text();
          }

          document.getElementById("csvInput").value = text;
          parseData();
        } catch (error) {
          alert("Error reading file: " + error.message);
        }
      }

      // Save current session data
      function saveCurrentSession() {
        if (!parsedData) {
          alert("No data to save");
          return;
        }

        // Prompt for session name
        const sessionName = prompt(
          "Enter a name for this session:",
          selectedPreset ? selectedPreset.name : "Quick Launch Session",
        );
        if (!sessionName) return; // User cancelled

        const sessionData = {
          name: sessionName,
          parsedData,
          columnMappings,
          currentMode,
          selectedPreset,
          rowInclusionMap,
          timestamp: new Date().toISOString(),
        };

        localStorage.setItem(
          STORAGE_KEY_SAVED_DATA,
          JSON.stringify(sessionData),
        );
        dataSaved = true; // Mark as saved
        alert(
          `âœ… Session "${sessionName}" saved! You can load it later from Step 1.`,
        );
      }

      // Load saved session data
      function loadSavedData() {
        const saved = localStorage.getItem(STORAGE_KEY_SAVED_DATA);
        if (!saved) {
          alert("No saved data found");
          return;
        }

        try {
          const sessionData = JSON.parse(saved);
          parsedData = sessionData.parsedData;
          columnMappings = sessionData.columnMappings || {};
          currentMode = sessionData.currentMode || "individual";
          selectedPreset = sessionData.selectedPreset || null;
          rowInclusionMap =
            sessionData.rowInclusionMap || parsedData.rows.map(() => true);

          // Update UI
          selectMode(currentMode);
          displayPreview();
          showRowFiltering();
          showColumnMapping();

          // Open Step 2
          closeStep("step1");
          openStep("step2");

          const sessionName = sessionData.name || "Saved Session";
          const sessionDate = new Date(sessionData.timestamp).toLocaleString();
          alert(`âœ… Loaded "${sessionName}" from ${sessionDate}`);

          dataSaved = true; // Mark as saved since we just loaded it
        } catch (error) {
          alert("Error loading saved data: " + error.message);
        }
      }

      // Clear everything
      function clearAll() {
        if (!confirm("Clear all data and start over?")) return;

        document.getElementById("csvInput").value = "";
        document.getElementById("fileInput").value = "";
        parsedData = null;
        columnMappings = {};
        rowInclusionMap = [];
        messagesHaveBeenSent = false;
        dataSaved = false;
        updateStep1Title();

        document.getElementById("previewContainer").innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.5);">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“„</div>
                    <p>Upload a file or paste data to get started</p>
                </div>
            `;
        document.getElementById("rowFilteringSection").style.display = "none";
        document.getElementById("columnMappingSection").style.display = "none";
        document.getElementById("assignmentContainer").innerHTML = "";
        document.getElementById("resultsContainer").innerHTML = "";

        // Close all steps except Step 1
        closeStep("step2");
        closeStep("step2b");
        closeStep("step3");
        closeStep("step4");
        openStep("step1");

        // Remove completed markers
        document.getElementById("step1-header").classList.remove("completed");
        document.getElementById("step2-header").classList.remove("completed");
        document.getElementById("step3-header").classList.remove("completed");
      }

      // Renamed from parseCSV
      function parseData() {
        const csvText = document.getElementById("csvInput").value.trim();

        if (!csvText) {
          alert("Please paste data or upload a file first");
          return;
        }

        const firstLine = csvText.split("\n")[0];
        const delimiter = firstLine.includes("\t") ? "\t" : ",";

        const lines = csvText.split("\n").filter((line) => line.trim());
        if (lines.length < 1) {
          alert("No data found");
          return;
        }

        const allRows = lines.map((line) =>
          line.split(delimiter).map((v) => v.trim()),
        );

        const firstRowValues = allRows[0];
        const isHeader =
          firstRowValues.every((v) => isNaN(v)) && firstRowValues.length > 2;

        let headers, dataRows;
        if (isHeader) {
          headers = firstRowValues;
          dataRows = allRows.slice(1);
        } else {
          headers = firstRowValues.map((_, i) => `Column ${i + 1}`);
          dataRows = allRows;
        }

        // Filter out completely blank columns unless they have a header
        const nonBlankColumns = [];
        headers.forEach((header, colIndex) => {
          const hasHeader =
            header && header.trim() !== "" && !header.startsWith("Column");
          const hasData = dataRows.some(
            (row) => row[colIndex] && row[colIndex].trim() !== "",
          );

          if (hasHeader || hasData) {
            nonBlankColumns.push(colIndex);
          }
        });

        // Filter headers and data rows to only include non-blank columns
        const filteredHeaders = nonBlankColumns.map((i) => headers[i]);
        const filteredRows = dataRows.map((row) =>
          nonBlankColumns.map((i) => row[i] || ""),
        );

        const columnTypes = filteredHeaders.map((header, colIndex) => {
          const values = filteredRows
            .map((row) => row[colIndex])
            .filter((v) => v);
          return {
            header,
            type: detectColumnType(values),
            samples: values.slice(0, 3),
            originalIndex: nonBlankColumns[colIndex],
          };
        });

        parsedData = {
          headers: filteredHeaders,
          rows: filteredRows,
          columnTypes,
          delimiter,
        };

        // Initialize row inclusion map (all checked by default)
        rowInclusionMap = filteredRows.map(() => true);

        // Reset saved state since data has changed
        dataSaved = false;

        displayPreview();
        showRowFiltering();
        showColumnMapping();

        // Auto-open Step 2, close Step 1
        closeStep("step1");
        openStep("step2");

        // Scroll to Step 2
        setTimeout(() => {
          document
            .getElementById("step2-header")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }

      function detectColumnType(values) {
        const datePattern = /^\d{1,2}\/\d{1,2}\/\d{2,4}$/;
        if (values.some((v) => datePattern.test(v))) return "date";

        const dollarPattern = /^\$?\d+\.?\d*$/;
        if (values.some((v) => dollarPattern.test(v))) return "amount";

        if (values.every((v) => !isNaN(v) && v.trim() !== "")) return "number";

        const namePattern = /^[A-Z][a-z]+(\s[A-Z][a-z]+)?$/;
        if (values.some((v) => namePattern.test(v))) return "name";

        const techNames = TEAM_MEMBERS.map((t) => t.name);
        if (values.some((v) => techNames.includes(v))) return "tech";

        return "text";
      }

      function displayPreview() {
        const { headers, rows } = parsedData;

        let html = `<table class="preview-table">
                <thead><tr>${headers.map((h) => `<th>${h}</th>`).join("")}</tr></thead>
                <tbody>`;

        rows.slice(0, 10).forEach((row) => {
          html += `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`;
        });

        if (rows.length > 10) {
          html += `<tr><td colspan="${headers.length}" style="text-align: center; color: #999; padding: 20px;">
                    ...and ${rows.length - 10} more rows
                </td></tr>`;
        }

        html += "</tbody></table>";
        document.getElementById("previewContainer").innerHTML = html;
      }

      function showRowFiltering() {
        const { headers, rows } = parsedData;

        let html = `<div style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">`;
        html += `<table class="preview-table" style="font-size: 12px;">`;
        html += `<thead><tr><th style="width: 40px;">Include</th>${headers.map((h) => `<th>${h}</th>`).join("")}</tr></thead>`;
        html += `<tbody>`;

        rows.forEach((row, rowIndex) => {
          const checked = rowInclusionMap[rowIndex] ? "checked" : "";
          html += `<tr>`;
          html += `<td><input type="checkbox" ${checked} onchange="toggleRowInclusion(${rowIndex})" style="cursor: pointer;"></td>`;
          html += row.map((cell) => `<td>${cell}</td>`).join("");
          html += `</tr>`;
        });

        html += `</tbody></table></div>`;
        html += `<div style="margin-top: 10px; color: white; font-size: 13px;">`;
        html += `<strong>${rowInclusionMap.filter(Boolean).length}</strong> of ${rows.length} rows will be imported.`;
        html += `</div>`;

        document.getElementById("rowFilteringContainer").innerHTML = html;
        document.getElementById("rowFilteringSection").style.display = "block";
      }

      function toggleRowInclusion(rowIndex) {
        rowInclusionMap[rowIndex] = !rowInclusionMap[rowIndex];
        // Update count display
        const count = rowInclusionMap.filter(Boolean).length;
        const total = parsedData.rows.length;
        document.querySelector("#rowFilteringContainer + div").innerHTML =
          `<strong>${count}</strong> of ${total} rows will be imported.`;
      }

      function showColumnMapping() {
        const { columnTypes } = parsedData;

        // Only auto-map if no preset selected and mappings are empty (predictive)
        if (Object.keys(columnMappings).length === 0 && !selectedPreset) {
          // Predictive mapping based on column headers and content
          columnMappings = {
            person: columnTypes.findIndex(
              (c) =>
                c.header.toLowerCase().includes("tech") ||
                c.header.toLowerCase().includes("name") ||
                c.type === "tech",
            ),
            date: columnTypes.findIndex((c) => c.type === "date"),
            lastName: columnTypes.findIndex((c) =>
              c.header.toLowerCase().includes("last"),
            ),
            firstName: columnTypes.findIndex((c) =>
              c.header.toLowerCase().includes("first"),
            ),
            type: columnTypes.findIndex(
              (c) =>
                c.header.toLowerCase().includes("service") ||
                c.header.toLowerCase().includes("type") ||
                c.header.toLowerCase().includes("category"),
            ),
            amount: columnTypes.findIndex((c) => c.type === "amount"),
          };
        }

        let html =
          '<div style="margin-bottom: 20px;"><p style="color: white; margin-bottom: 10px;">Map your data columns to fields. Column numbers shown in dropdown.</p></div>';
        html += '<div class="mapping-grid">';

        const mappingFields = [
          { key: "person", label: "Person/Tech Name", required: true },
          { key: "type", label: "Type/Category", required: false },
          { key: "date", label: "Date", required: false },
          { key: "lastName", label: "Customer Last Name", required: false },
          { key: "firstName", label: "Customer First Name", required: false },
          { key: "amount", label: "Amount", required: false },
        ];

        mappingFields.forEach((field) => {
          const selectedIndex =
            columnMappings[field.key] >= 0 ? columnMappings[field.key] : -1;
          const sample =
            selectedIndex >= 0 ? columnTypes[selectedIndex].samples[0] : "";

          html += `
                    <div class="column-map">
                        <label>${field.label} ${field.required ? "*" : ""}</label>
                        <select onchange="updateMapping('${field.key}', this.value)">
                            <option value="-1">-- Skip --</option>
                            ${columnTypes
                              .map(
                                (col, i) => `
                                <option value="${i}" ${i === selectedIndex ? "selected" : ""}>
                                    ${col.header} (Column ${i + 1})
                                </option>
                            `,
                              )
                              .join("")}
                        </select>
                        ${sample ? `<div class="sample-value">e.g., ${sample}</div>` : ""}
                    </div>
                `;
        });

        html += "</div>";

        // Add custom category input if no preset selected
        if (!selectedPreset) {
          html += `
                    <div style="margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                        <h4 style="color: white; font-size: 14px; margin-bottom: 10px;">ğŸ“ Category Name</h4>
                        <div class="alert alert-info" style="margin-bottom: 15px;">
                            <strong>No preset selected.</strong> Enter a category name for these tasks (e.g., "Collections", "Appointments", "Follow-ups")
                        </div>
                        <input type="text" id="customCategoryInput" placeholder="Enter category name..." style="width: 100%; padding: 12px; font-size: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px;">
                    </div>
                `;
        }

        document.getElementById("columnMappingContainer").innerHTML = html;
        document.getElementById("columnMappingSection").style.display = "block";
      }

      function updateMapping(key, value) {
        columnMappings[key] = parseInt(value);
      }

      // Save current mapping as a template preset
      function saveCurrentMappingAsPreset() {
        const presetName = prompt("Enter a name for this mapping preset:");
        if (!presetName) return;

        const template = {
          id: Date.now(),
          name: presetName,
          mappings: { ...columnMappings },
          mode: currentMode,
          preset: selectedPreset ? { ...selectedPreset } : null,
          createdAt: new Date().toISOString(),
        };

        savedTemplates.push(template);
        localStorage.setItem(
          STORAGE_KEY_TEMPLATES,
          JSON.stringify(savedTemplates),
        );
        renderTemplates();

        alert(`âœ… Mapping preset "${presetName}" saved!`);
      }

      function proceedToAssignment() {
        if (columnMappings.person < 0) {
          alert("Person/Tech Name column is required");
          return;
        }

        // Filter parsedData to only include checked rows
        const includedRows = parsedData.rows.filter(
          (row, index) => rowInclusionMap[index],
        );

        if (includedRows.length === 0) {
          alert("No rows selected! Please check at least one row to import.");
          return;
        }

        // Update parsedData temporarily for generation
        const originalRows = parsedData.rows;
        parsedData.rows = includedRows;

        if (currentMode === "grouped-person") {
          generateGroupedByPersonAssignments();
        } else if (currentMode === "grouped-type") {
          generateGroupedByTypeAssignments();
        } else {
          generateIndividualAssignments();
        }

        // Restore original rows
        parsedData.rows = originalRows;

        // Close Step 2, open Step 3
        closeStep("step2");
        openStep("step3");

        // Scroll to Step 3
        setTimeout(() => {
          document
            .getElementById("step3-header")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }

      function generateGroupedByPersonAssignments() {
        const { rows } = parsedData;

        const grouped = {};

        rows.forEach((row) => {
          const person = row[columnMappings.person];
          if (!person) return;

          if (!grouped[person]) {
            grouped[person] = [];
          }

          let line = "";
          if (columnMappings.date >= 0) line += row[columnMappings.date] + "  ";
          if (columnMappings.type >= 0) line += row[columnMappings.type] + "  ";
          if (columnMappings.lastName >= 0)
            line += row[columnMappings.lastName];
          if (columnMappings.firstName >= 0)
            line += ", " + row[columnMappings.firstName];
          if (columnMappings.amount >= 0)
            line += "  " + row[columnMappings.amount];

          grouped[person].push(line.trim());
        });

        let html = "";
        Object.entries(grouped).forEach(([person, items]) => {
          const itemList = items.join("\n");
          const defaultChannel = PERSONAL_CHANNELS[person] || "";

          html += `
                    <div class="grouped-task" data-person="${person}">
                        <div class="grouped-task-header">
                            <div class="tech-name">${person}</div>
                            <div class="appointment-count">${items.length} item${items.length > 1 ? "s" : ""}</div>
                        </div>
                        <div class="appointment-list">${itemList}</div>
                        <div class="destination-selector">
                            <label>Target Channel ID (optional override):</label>
                            <input type="text" class="destination-override" placeholder="${defaultChannel || "Default channel"}" value="">
                        </div>
                        <input type="hidden" class="task-data" value="${encodeURIComponent(itemList)}">
                    </div>
                `;
        });

        document.getElementById("step3-title").textContent =
          `Assignments - Grouped by Person (${Object.keys(grouped).length})`;
        document.getElementById("assignmentContainer").innerHTML = html;
      }

      function generateGroupedByTypeAssignments() {
        const { rows } = parsedData;

        if (columnMappings.type < 0) {
          alert("Type/Category column is required for grouping by type");
          return;
        }

        const grouped = {};

        rows.forEach((row) => {
          const type = row[columnMappings.type] || "Uncategorized";
          const person = row[columnMappings.person];

          if (!grouped[type]) {
            grouped[type] = [];
          }

          let line = "";
          if (person) line += person + "  ";
          if (columnMappings.date >= 0) line += row[columnMappings.date] + "  ";
          if (columnMappings.lastName >= 0)
            line += row[columnMappings.lastName];
          if (columnMappings.firstName >= 0)
            line += ", " + row[columnMappings.firstName];
          if (columnMappings.amount >= 0)
            line += "  " + row[columnMappings.amount];

          grouped[type].push(line.trim());
        });

        let html = "";
        Object.entries(grouped).forEach(([type, items]) => {
          const itemList = items.join("\n");

          html += `
                    <div class="grouped-task" data-type="${type}">
                        <div class="grouped-task-header">
                            <div class="tech-name">${type}</div>
                            <div class="appointment-count">${items.length} item${items.length > 1 ? "s" : ""}</div>
                        </div>
                        <div class="appointment-list">${itemList}</div>
                        <div class="destination-selector">
                            <label>Target Channel ID (required for this grouping):</label>
                            <input type="text" class="destination-override" placeholder="Enter channel ID" value="">
                        </div>
                        <input type="hidden" class="task-data" value="${encodeURIComponent(itemList)}">
                    </div>
                `;
        });

        document.getElementById("step3-title").textContent =
          `Assignments - Grouped by Type (${Object.keys(grouped).length})`;
        document.getElementById("assignmentContainer").innerHTML = html;
      }

      function generateIndividualAssignments() {
        const { rows } = parsedData;

        let html = "";
        rows.forEach((row, index) => {
          const person = row[columnMappings.person] || "Unknown";
          const defaultChannel = PERSONAL_CHANNELS[person] || "";

          let taskTitle = "";
          if (columnMappings.date >= 0)
            taskTitle += row[columnMappings.date] + " - ";
          if (columnMappings.type >= 0)
            taskTitle += row[columnMappings.type] + " - ";
          if (columnMappings.lastName >= 0)
            taskTitle += row[columnMappings.lastName];
          if (columnMappings.firstName >= 0)
            taskTitle += ", " + row[columnMappings.firstName];

          let details = row.join(" | ");

          html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;" data-person="${person}" data-index="${index}">
                        <input type="text" class="task-title" value="${taskTitle}" style="width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <input type="hidden" class="task-data" value="${encodeURIComponent(details)}">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Assigned to: <strong>${person}</strong></div>
                        <div class="destination-selector">
                            <label>Target Channel ID (optional override):</label>
                            <input type="text" class="destination-override" placeholder="${defaultChannel || "Default channel"}" value="">
                        </div>
                    </div>
                `;
        });

        document.getElementById("step3-title").textContent =
          `Assignments - Individual Items (${rows.length})`;
        document.getElementById("assignmentContainer").innerHTML = html;
      }

      async function bulkAssign() {
        const tasks = document.querySelectorAll(
          currentMode.startsWith("grouped") ? ".grouped-task" : "[data-index]",
        );

        if (tasks.length === 0) {
          alert("No tasks to assign");
          return;
        }

        // Close Step 3, open Step 4
        closeStep("step3");
        openStep("step4");

        // Scroll to Step 4
        setTimeout(() => {
          document
            .getElementById("step4-header")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);

        const progressBar = document.getElementById("progressBar");
        const progressFill = document.getElementById("progressFill");
        const resultsContainer = document.getElementById("resultsContainer");

        progressBar.style.display = "block";
        resultsContainer.innerHTML = "";

        const total = tasks.length;
        let completed = 0;
        let results = [];
        assignmentLog = []; // Reset log for this batch

        for (const taskElem of tasks) {
          // Get person from correct data attribute based on mode
          const person =
            taskElem.dataset.person || taskElem.dataset.type || "Unknown";
          const taskDataElem = taskElem.querySelector(".task-data");
          const taskData = decodeURIComponent(taskDataElem.value);
          const destinationOverride = taskElem
            .querySelector(".destination-override")
            .value.trim();

          // For grouped-type, we need destination override
          if (currentMode === "grouped-type" && !destinationOverride) {
            results.push({
              success: false,
              person: person,
              error: "Channel ID required for type grouping",
            });
            completed++;
            continue;
          }

          // Smart team member matching: try exact match first, then first name match
          let teamMember = TEAM_MEMBERS.find((t) => t.name === person);

          if (!teamMember && currentMode !== "grouped-type") {
            // Try matching just the first name (e.g., "Hector Bermudez" -> "Hector")
            const firstName = person.split(" ")[0];
            teamMember = TEAM_MEMBERS.find((t) => t.name === firstName);
          }

          if (!teamMember && currentMode !== "grouped-type") {
            // Try case-insensitive partial match
            const personLower = person.toLowerCase();
            teamMember = TEAM_MEMBERS.find(
              (t) =>
                t.name.toLowerCase() === personLower ||
                personLower.startsWith(t.name.toLowerCase()),
            );
          }

          if (!teamMember && currentMode !== "grouped-type") {
            results.push({
              success: false,
              person: person,
              error: "Team member not found",
            });
            completed++;
            continue;
          }

          let title;
          if (currentMode === "grouped-person") {
            const count =
              taskElem.querySelector(".appointment-count").textContent;
            title = `Items for ${person} - ${count}`;
          } else if (currentMode === "grouped-type") {
            const count =
              taskElem.querySelector(".appointment-count").textContent;
            title = `${person} - ${count}`;
          } else {
            const titleElem = taskElem.querySelector(".task-title");
            title = titleElem ? titleElem.value : person;
          }

          const priority = selectedPreset ? selectedPreset.priority : "medium";

          // Get category from preset or custom input
          let category;
          if (selectedPreset) {
            category = selectedPreset.category;
          } else {
            const customCategoryInput = document.getElementById(
              "customCategoryInput",
            );
            category =
              customCategoryInput && customCategoryInput.value.trim()
                ? customCategoryInput.value.trim()
                : "Quick Launch";
          }

          // Destination priority: override > preset > personal channel > error
          let targetChannelId;
          if (destinationOverride) {
            targetChannelId = destinationOverride;
          } else if (selectedPreset) {
            targetChannelId = selectedPreset.channelId;
          } else if (
            currentMode !== "grouped-type" &&
            PERSONAL_CHANNELS[person]
          ) {
            targetChannelId = PERSONAL_CHANNELS[person];
          } else {
            results.push({
              success: false,
              person: person,
              error: "No target channel configured",
            });
            completed++;
            continue;
          }

          try {
            // Create task
            const response = await fetch(`${BOT_CONFIG.apiUrl}/api/tasks`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: title,
                notes: taskData,
                priority: priority,
                category: category,
                createdBy: currentUser.name,
                createdById: currentUser.discordId,
                importSource: "quick-launch",
              }),
            });

            if (!response.ok) throw new Error("Failed to create task");

            const taskResult = await response.json();
            const taskNumber = taskResult.task_number;

            // Assign task (for grouped-type, assign to first found member or skip assignment)
            let assignedTo = teamMember ? teamMember.name : null;
            let assignedToId = teamMember ? teamMember.discordId : null;

            if (assignedTo) {
              const assignResponse = await fetch(
                `${BOT_CONFIG.apiUrl}/api/tasks/${taskNumber}/assign`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    assignedTo: assignedTo,
                    assignedToId: assignedToId,
                    assigneeChannelId: targetChannelId,
                  }),
                },
              );

              if (!assignResponse.ok) throw new Error("Failed to assign task");
            }

            // Log assignment (without sensitive data)
            const logEntry = {
              timestamp: new Date().toISOString(),
              taskNumber: taskNumber,
              assignedTo: assignedTo || "Unassigned",
              category: category,
              mode: currentMode,
              user: currentUser.name,
            };
            assignmentLog.push(logEntry);

            results.push({
              success: true,
              person: person,
              taskNumber: taskNumber,
              title: title,
              channel: targetChannelId,
            });
          } catch (error) {
            results.push({
              success: false,
              person: person,
              error: error.message,
            });
          }

          completed++;
          progressFill.style.width = `${(completed / total) * 100}%`;
        }

        // Mark that messages have been sent
        messagesHaveBeenSent = true;

        displayResults(results);
      }

      function displayResults(results) {
        const successCount = results.filter((r) => r.success).length;
        const errorCount = results.filter((r) => !r.success).length;

        let html = "";

        if (successCount > 0) {
          html += `<div class="alert alert-success">
                    <strong>âœ… Success!</strong> Created and assigned ${successCount} task${successCount > 1 ? "s" : ""}<br>
                    <small>Logged ${assignmentLog.length} assignment${assignmentLog.length > 1 ? "s" : ""} for reporting.</small>
                </div>`;
        }

        if (errorCount > 0) {
          html += `<div class="alert alert-error">
                    <strong>âŒ Errors:</strong> ${errorCount} task${errorCount > 1 ? "s" : ""} failed
                </div>`;
        }

        html +=
          '<table class="preview-table"><thead><tr><th>Status</th><th>Person</th><th>Task</th><th>Task #</th><th>Channel</th></tr></thead><tbody>';

        results.forEach((result) => {
          const statusBadge = result.success
            ? '<span class="status-badge status-success">Success</span>'
            : '<span class="status-badge status-error">Failed</span>';

          html += `
                    <tr>
                        <td>${statusBadge}</td>
                        <td>${result.person}</td>
                        <td>${result.title || "-"}</td>
                        <td>${result.success ? `#${result.taskNumber}` : result.error}</td>
                        <td>${result.channel || "-"}</td>
                    </tr>
                `;
        });

        html += "</tbody></table>";

        // Add action buttons
        html += `
                <div class="button-group" style="margin-top: 20px;">
                    <a href="BottyOtty Dashboard v18.html" class="btn-success">âœ… All set? Go back to Dashboard!</a>
                    <button class="btn-primary" onclick="resetQuickLaunch()">ğŸ”„ Need to do another Quick Launch?</button>
                </div>
            `;

        document.getElementById("resultsContainer").innerHTML = html;

        setTimeout(() => {
          document.getElementById("progressBar").style.display = "none";
        }, 1000);
      }

      // Reset Quick Launch for another run
      function resetQuickLaunch() {
        if (
          confirm("Start a new Quick Launch? This will clear all current data.")
        ) {
          location.reload();
        }
      }
    </script>
    <!-- Customization System JavaScript -->
    <script>
      // Theme configurations (same as Admin Panel)
      const THEMES = {
        "dark-mode": {
          name: "Dark Mode",
          primary: "#324973",
          primaryLight: "#566685",
          primaryDark: "#001541",
          secondary: "#ec4899",
          secondaryLight: "#f472b6",
          secondaryDark: "#db2777",
          accent: "#f37b28",
          accentLight: "#ffbc6c",
          accentDark: "#ff8b01",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#0f0f23",
          bgSecondary: "#1a1a3e",
          bgTertiary: "#252554",
          surface: "rgba(255, 255, 255, 0.03)",
          surfaceHover: "rgba(255, 255, 255, 0.06)",
          surfaceActive: "rgba(255, 255, 255, 0.09)",
          textPrimary: "#ffffff",
          textSecondary: "rgba(255, 255, 255, 0.7)",
          textTertiary: "rgba(255, 255, 255, 0.4)",
          border: "rgba(255, 255, 255, 0.08)",
          borderFocus: "rgba(99, 102, 241, 0.4)",
        },
        "light-clean": {
          name: "Light & Clean",
          primary: "#324973",
          primaryLight: "#566685",
          primaryDark: "#001541",
          secondary: "#f37b28",
          secondaryLight: "#ffbc6c",
          secondaryDark: "#ff8b01",
          accent: "#ff8b01",
          accentLight: "#ffbc6c",
          accentDark: "#f37b28",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#ffffff",
          bgSecondary: "#f8f9fa",
          bgTertiary: "#e9ecef",
          surface: "rgba(50, 73, 115, 0.05)",
          surfaceHover: "rgba(50, 73, 115, 0.08)",
          surfaceActive: "rgba(50, 73, 115, 0.12)",
          textPrimary: "#001541",
          textSecondary: "#324973",
          textTertiary: "#566685",
          border: "rgba(50, 73, 115, 0.15)",
          borderFocus: "rgba(255, 139, 1, 0.4)",
        },
        "warm-welcoming": {
          name: "Warm & Welcoming",
          primary: "#324973",
          primaryLight: "#566685",
          primaryDark: "#001541",
          secondary: "#f37b28",
          secondaryLight: "#ff8b01",
          secondaryDark: "#cc6622",
          accent: "#f37b28",
          accentLight: "#ff8b01",
          accentDark: "#cc6622",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#fff5eb",
          bgSecondary: "#ffe5c7",
          bgTertiary: "#ffd9a3",
          surface: "rgba(255, 139, 1, 0.08)",
          surfaceHover: "rgba(255, 139, 1, 0.12)",
          surfaceActive: "rgba(255, 139, 1, 0.16)",
          textPrimary: "#001541",
          textSecondary: "#324973",
          textTertiary: "#566685",
          border: "rgba(243, 123, 40, 0.2)",
          borderFocus: "rgba(243, 123, 40, 0.4)",
        },
        "premium-dark": {
          name: "Premium Dark",
          primary: "#001541",
          primaryLight: "#324973",
          primaryDark: "#000a1f",
          secondary: "#ff8b01",
          secondaryLight: "#ffbc6c",
          secondaryDark: "#f37b28",
          accent: "#ff8b01",
          accentLight: "#ffbc6c",
          accentDark: "#f37b28",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#000a1f",
          bgSecondary: "#001541",
          bgTertiary: "#001d5a",
          surface: "rgba(255, 139, 1, 0.05)",
          surfaceHover: "rgba(255, 139, 1, 0.08)",
          surfaceActive: "rgba(255, 139, 1, 0.12)",
          textPrimary: "#ffffff",
          textSecondary: "rgba(255, 255, 255, 0.7)",
          textTertiary: "#566685",
          border: "rgba(255, 139, 1, 0.15)",
          borderFocus: "rgba(255, 139, 1, 0.4)",
        },
      };

      // Layout configurations
      const LAYOUTS = {
        minimalist: {
          name: "Minimalist Clean",
          spacing: "spacious",
          cardStyle: "minimal",
          borderRadius: "16px",
          cardPadding: "32px",
          gap: "24px",
        },
        "bold-card": {
          name: "Bold Card-Based",
          spacing: "comfortable",
          cardStyle: "bold",
          borderRadius: "20px",
          cardPadding: "28px",
          gap: "20px",
        },
        "dashboard-grid": {
          name: "Dashboard Grid",
          spacing: "compact",
          cardStyle: "grid",
          borderRadius: "12px",
          cardPadding: "20px",
          gap: "16px",
        },
        "list-view": {
          name: "List View Clean",
          spacing: "tight",
          cardStyle: "list",
          borderRadius: "8px",
          cardPadding: "16px",
          gap: "12px",
        },
      };

      let currentTheme = "dark-mode";
      let currentLayout = "minimalist";
      let isUserMode = false;
      let adminSettings = { theme: "dark-mode", layout: "minimalist" };
      let userSettings = { theme: null, layout: null };

      function initCustomization() {
        loadSettings();
        const effectiveTheme =
          isUserMode && userSettings.theme
            ? userSettings.theme
            : adminSettings.theme;
        const effectiveLayout =
          isUserMode && userSettings.layout
            ? userSettings.layout
            : adminSettings.layout;
        applyTheme(effectiveTheme, false);
        applyLayout(effectiveLayout, false);
      }

      function toggleCustomizationPanel() {
        const panel = document.getElementById("customizationPanel");
        const btn = document.getElementById("customizeToggleBtn");
        panel.classList.toggle("minimized");
        btn.textContent = panel.classList.contains("minimized") ? "âš™ï¸" : "âœ•";
      }

      function applyTheme(themeId, save = true, clickEvent = null) {
        const theme = THEMES[themeId];
        if (!theme) return;

        const root = document.documentElement;
        Object.keys(theme).forEach((key) => {
          if (key !== "name") {
            const cssVarName =
              "--" + key.replace(/([A-Z])/g, "-$1").toLowerCase();
            root.style.setProperty(cssVarName, theme[key]);
          }
        });

        if (themeId === "light-clean" || themeId === "warm-welcoming") {
          document.body.style.background = theme.bgPrimary;
        } else {
          document.body.style.background = `linear-gradient(135deg, ${theme.bgPrimary} 0%, ${theme.bgSecondary} 25%, ${theme.bgTertiary} 50%, ${theme.bgSecondary} 75%, ${theme.bgPrimary} 100%)`;
          document.body.style.backgroundSize = "200% 200%";
        }

        // Update active button state - only if we have a click event
        document
          .querySelectorAll(".preset-btn")
          .forEach((btn) => btn.classList.remove("active"));
        if (clickEvent) {
          const target = clickEvent.target.closest(".preset-btn");
          if (target) target.classList.add("active");
        } else {
          // Find and activate the button for the current theme
          document.querySelectorAll(".preset-btn").forEach((btn) => {
            if (btn.getAttribute("onclick")?.includes(themeId)) {
              btn.classList.add("active");
            }
          });
        }

        currentTheme = themeId;
        if (save) {
          saveSettings();
          showSavedIndicator();
        }
      }

      function applyLayout(layoutId, save = true, clickEvent = null) {
        const layout = LAYOUTS[layoutId];
        if (!layout) return;

        const root = document.documentElement;
        root.style.setProperty(
          "--layout-spacing",
          layout.spacing === "spacious"
            ? "32px"
            : layout.spacing === "comfortable"
              ? "24px"
              : layout.spacing === "compact"
                ? "16px"
                : "12px",
        );
        root.style.setProperty("--card-border-radius", layout.borderRadius);
        root.style.setProperty("--card-padding", layout.cardPadding);
        root.style.setProperty("--card-gap", layout.gap);

        document.body.className = document.body.className.replace(
          /layout-\w+/g,
          "",
        );
        document.body.classList.add(`layout-${layoutId}`);

        // Update active button state - only if we have a click event
        const allSections = document.querySelectorAll(".customize-section");
        allSections.forEach((section) => {
          const heading = section.querySelector("h2");
          if (heading && heading.textContent.includes("Layout")) {
            section
              .querySelectorAll(".preset-btn")
              .forEach((btn) => btn.classList.remove("active"));
            if (clickEvent) {
              const target = clickEvent.target.closest(".preset-btn");
              if (target) target.classList.add("active");
            } else {
              // Find and activate the button for the current layout
              section.querySelectorAll(".preset-btn").forEach((btn) => {
                if (btn.getAttribute("onclick")?.includes(layoutId)) {
                  btn.classList.add("active");
                }
              });
            }
          }
        });

        currentLayout = layoutId;
        if (save) {
          saveSettings();
          showSavedIndicator();
        }
      }

      function toggleUserMode() {
        isUserMode = !isUserMode;
        const toggle = document.getElementById("userModeToggle");
        const label = document.getElementById("modeLabel");
        toggle.classList.toggle("active");
        label.textContent = isUserMode ? "User" : "Admin";
        const effectiveTheme =
          isUserMode && userSettings.theme
            ? userSettings.theme
            : adminSettings.theme;
        const effectiveLayout =
          isUserMode && userSettings.layout
            ? userSettings.layout
            : adminSettings.layout;
        applyTheme(effectiveTheme, false);
        applyLayout(effectiveLayout, false);
      }

      function saveSettings() {
        if (isUserMode) {
          userSettings.theme = currentTheme;
          userSettings.layout = currentLayout;
          localStorage.setItem(
            "bottyotty_user_settings",
            JSON.stringify(userSettings),
          );
        } else {
          adminSettings.theme = currentTheme;
          adminSettings.layout = currentLayout;
          localStorage.setItem(
            "bottyotty_admin_settings",
            JSON.stringify(adminSettings),
          );
        }
      }

      function loadSettings() {
        const savedAdmin = localStorage.getItem("bottyotty_admin_settings");
        const savedUser = localStorage.getItem("bottyotty_user_settings");
        if (savedAdmin) {
          try {
            const parsed = JSON.parse(savedAdmin);
            adminSettings = {
              theme: parsed.theme || "dark-mode",
              layout: parsed.layout || "minimalist",
            };
          } catch (e) {
            console.error("Failed to parse admin settings", e);
          }
        }
        if (savedUser) {
          try {
            const parsed = JSON.parse(savedUser);
            userSettings = {
              theme: parsed.theme || null,
              layout: parsed.layout || null,
            };
          } catch (e) {
            console.error("Failed to parse user settings", e);
          }
        }
      }

      function showSavedIndicator() {
        const indicator = document.getElementById("savedIndicator");
        indicator.classList.add("show");
        setTimeout(() => {
          indicator.classList.remove("show");
        }, 2000);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCustomization);
      } else {
        initCustomization();
      }

      // ========================================
      // ğŸ§­ SIDEBAR NAVIGATION FUNCTIONS
      // ========================================

      function toggleSidebar() {
        const sidebar = document.getElementById('sidebarNav');
        const icon = document.getElementById('sidebarToggleIcon');
        const text = document.getElementById('sidebarToggleText');
        const isCollapsed = sidebar.classList.toggle('collapsed');

        if (isCollapsed) {
          document.body.classList.add('sidebar-collapsed');
          icon.textContent = 'â†’';
          text.textContent = 'Expand';
        } else {
          document.body.classList.remove('sidebar-collapsed');
          icon.textContent = 'â†';
          text.textContent = 'Collapse';
        }

        localStorage.setItem('bottyotty-sidebar-collapsed', isCollapsed);
      }

      function initSidebar() {
        const saved = localStorage.getItem('bottyotty-sidebar-collapsed');
        const isCollapsed = saved !== null ? saved === 'true' : true; // Default to true (collapsed)
        const sidebar = document.getElementById('sidebarNav');
        const icon = document.getElementById('sidebarToggleIcon');
        const text = document.getElementById('sidebarToggleText');

        if (isCollapsed) {
          sidebar.classList.add('collapsed');
          document.body.classList.add('sidebar-collapsed');
          icon.textContent = 'â†’';
          text.textContent = 'Expand';
          localStorage.setItem('bottyotty-sidebar-collapsed', 'true');
        }
      }

      // Initialize sidebar on page load
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initSidebar);
      } else {
        initSidebar();
      }
    </script>
  </body>
</html>
