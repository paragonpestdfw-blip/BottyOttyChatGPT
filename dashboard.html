<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BottyOtty Task Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      type="image/png"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root {
        /* Layout Variables (dynamically updated) */
        --layout-spacing: 32px;
        --card-border-radius: 16px;
        --card-padding: 32px;
        --card-gap: 24px;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        transition: background 0.5s ease;
      }

      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .glass-element {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      /* Fix select dropdown option visibility */
      select option {
        background: #1f2937;
        color: white;
        padding: 8px;
      }

      select option:hover {
        background: #374151;
      }

      .task-card {
        transition: all 0.3s ease;
        cursor: grab;
      }

      .task-card:active {
        cursor: grabbing;
      }

      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .task-card.dragging {
        opacity: 0.5;
        transform: rotate(3deg);
      }

      .drop-zone {
        min-height: 200px;
        transition: all 0.3s;
      }

      .drop-zone.drag-over {
        background: rgba(251, 191, 36, 0.2);
        border: 2px dashed #fbbf24;
        border-radius: 12px;
      }

      .priority-urgent {
        border-left: 4px solid #ef4444;
      }
      .priority-high {
        border-left: 4px solid #f59e0b;
      }
      .priority-medium {
        border-left: 4px solid #3b82f6;
      }
      .priority-low {
        border-left: 4px solid #10b981;
      }

      .overdue-badge {
        background: #dc2626;
        color: white;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        display: inline-block;
      }

      .category-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .notification-enter {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        min-height: 100px;
        background: rgba(255, 255, 255, 0.1);
      }

      .calendar-day:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        transform: scale(1.05);
      }

      .calendar-day.today {
        background: rgba(59, 130, 246, 0.3) !important;
        border: 2px solid #3b82f6;
      }

      .calendar-day-number {
        font-size: 18px;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
      }

      .task-count-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
      }

      .task-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin: 2px;
      }

      .bot-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      .bot-status.online {
        background: #10b981;
        color: white;
      }

      .bot-status.offline {
        background: #ef4444;
        color: white;
      }

      .bot-status.checking {
        background: #f59e0b;
        color: white;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .backup-toast,
      .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #fbbf24;
        color: #78350f;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 100;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
      }

      .toast-notification {
        background: rgba(59, 130, 246, 0.95);
        color: white;
        backdrop-filter: blur(10px);
      }

      .toast-notification.fade-out {
        animation: slideOut 0.3s ease-out forwards;
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .view-content {
        animation: fadeInContent 0.3s ease-out;
      }

      @keyframes fadeInContent {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .refresh-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(2px);
        z-index: 90;
        animation: fadeIn 0.2s ease-out;
        pointer-events: none;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-backdrop {
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* ========================================
       üé® CUSTOMIZATION PANEL
       ======================================== */

      #customizationPanel {
        position: fixed;
        top: 0;
        right: 0;
        width: 420px;
        height: 100vh;
        background: rgba(15, 15, 35, 0.98);
        backdrop-filter: blur(20px);
        border-left: 2px solid var(--border);
        z-index: 9999;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
        transition: transform 0.4s ease;
        overflow-y: auto;
      }

      #customizationPanel.minimized {
        transform: translateX(100%);
      }

      #customizeToggleBtn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
      }

      #customizeToggleBtn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(99, 102, 241, 0.6);
      }

      #customizationPanel:not(.minimized) ~ #customizeToggleBtn {
        right: 440px;
      }

      .customize-inner {
        padding: 30px 24px;
      }

      .customize-header {
        margin-bottom: 30px;
      }

      .customize-header h1 {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 16px;
      }

      .user-mode-toggle {
        display: flex;
        gap: 10px;
        align-items: center;
        background: var(--surface);
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .user-mode-toggle label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: var(--surface);
        border-radius: 13px;
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-switch.active {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        border-color: var(--primary);
      }

      .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .toggle-switch.active .toggle-slider {
        transform: translateX(24px);
      }

      .mode-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--primary);
      }

      .customize-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .customize-section h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .preset-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .preset-btn {
        background: var(--surface);
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .preset-btn:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        transform: translateX(4px);
        box-shadow: var(--shadow-lg);
      }

      .preset-btn.active {
        border-color: var(--primary);
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.2) 0%,
          rgba(236, 72, 153, 0.2) 100%
        );
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
      }

      .preset-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .preset-desc {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .color-preview {
        display: flex;
        gap: 6px;
        margin-top: 10px;
      }

      .color-dot {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 2px solid var(--border);
      }

      .saved-indicator {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        font-weight: 600;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 10001;
      }

      .saved-indicator.show {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 1400px) {
        #customizationPanel {
          width: 360px;
        }

        #customizationPanel:not(.minimized) ~ #customizeToggleBtn {
          right: 380px;
        }
      }

      /* ========================================
       üìê LAYOUT STYLES
       ======================================== */

      /* Apply layout variables to containers */
      #root > div {
        padding: var(--layout-spacing);
      }

      /* Minimalist Clean Layout */
      body.layout-minimalist .section-card,
      body.layout-minimalist .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
      }

      body.layout-minimalist .mb-4,
      body.layout-minimalist .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      /* Bold Card-Based Layout */
      body.layout-bold-card .section-card,
      body.layout-bold-card .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      body.layout-bold-card .mb-4,
      body.layout-bold-card .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      /* Dashboard Grid Layout */
      body.layout-dashboard-grid .section-card,
      body.layout-dashboard-grid .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
      }

      body.layout-dashboard-grid .mb-4,
      body.layout-dashboard-grid .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      /* Dashboard Grid: Show all task categories in a grid layout */
      body.layout-dashboard-grid .dashboard-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--card-gap);
        align-items: start;
      }

      body.layout-dashboard-grid .dashboard-grid-item {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      body.layout-dashboard-grid .dashboard-grid-item .view-content {
        flex: 1;
        overflow: auto;
        max-height: 600px;
      }

      /* List View Clean Layout */
      body.layout-list-view .section-card,
      body.layout-list-view .glass {
        border-radius: var(--card-border-radius);
        padding: var(--card-padding);
        margin-bottom: var(--card-gap);
      }

      body.layout-list-view .mb-4,
      body.layout-list-view .mb-6 {
        margin-bottom: var(--card-gap) !important;
      }

      body.layout-list-view .section-card {
        display: flex;
        flex-direction: column;
        gap: calc(var(--card-gap) / 2);
      }

      /* ========================================
         üìù STICKY NOTES
         ======================================== */

      /* Floating button */
      .sticky-notes-toggle {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        z-index: 9998;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sticky-notes-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
      }

      /* Slide-out panel */
      .sticky-notes-panel {
        position: fixed;
        top: 0;
        right: -450px;
        width: 400px;
        height: 100vh;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
        transition: right 0.3s ease;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sticky-notes-panel.open {
        right: 0;
      }

      /* Panel header */
      .sticky-notes-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .sticky-notes-header h2 {
        color: white;
        font-size: 24px;
        font-weight: bold;
        margin: 0;
      }

      .sticky-notes-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.2s;
      }

      .sticky-notes-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }

      /* Notes container */
      .sticky-notes-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        position: relative;
        min-height: 600px;
      }

      /* Individual sticky note */
      .sticky-note {
        position: absolute;
        width: 200px;
        min-height: 150px;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        cursor: move;
        transition: box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sticky-note:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }

      .sticky-note.dragging {
        opacity: 0.8;
        z-index: 1000;
      }

      /* Note colors */
      .sticky-note.yellow {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #333;
      }

      .sticky-note.pink {
        background: linear-gradient(135deg, #ff6b9d 0%, #ffc3d7 100%);
        color: #fff;
      }

      .sticky-note.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: #fff;
      }

      .sticky-note.green {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: #333;
      }

      .sticky-note.purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
      }

      .sticky-note.orange {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: #333;
      }

      /* Note header */
      .sticky-note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .sticky-note-drag-handle {
        cursor: grab;
        font-size: 16px;
        opacity: 0.6;
      }

      .sticky-note-drag-handle:active {
        cursor: grabbing;
      }

      .sticky-note-delete {
        background: rgba(0, 0, 0, 0.2);
        border: none;
        color: inherit;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .sticky-note-delete:hover {
        background: rgba(255, 0, 0, 0.6);
        color: white;
        transform: scale(1.1);
      }

      /* Note content */
      .sticky-note-content {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        resize: none;
        font-size: 14px;
        line-height: 1.4;
        color: inherit;
        font-family: inherit;
      }

      .sticky-note-content::placeholder {
        opacity: 0.5;
      }

      /* Note timestamp */
      .sticky-note-timestamp {
        font-size: 10px;
        opacity: 0.6;
        text-align: right;
      }

      /* Add note button */
      .sticky-notes-add {
        padding: 15px 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .sticky-notes-add button {
        flex: 1;
        min-width: 80px;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.2s;
      }

      .sticky-notes-add button:hover {
        transform: scale(1.05);
      }

      /* ========================================
         üß≠ SIDEBAR NAVIGATION
         ======================================== */

      #sidebarNav {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        background: rgba(15, 15, 35, 0.98);
        backdrop-filter: blur(20px);
        border-right: 2px solid rgba(255, 255, 255, 0.1);
        z-index: 9998;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        transition: all 0.4s ease;
        overflow-y: auto;
        overflow-x: hidden;
      }

      #sidebarNav:not(.collapsed) { width: 280px; }
      #sidebarNav.collapsed { width: 70px; }

      #sidebarNav.collapsed .nav-item-label,
      #sidebarNav.collapsed .sidebar-header-text,
      #sidebarNav.collapsed .sidebar-footer-text {
        opacity: 0;
        width: 0;
        overflow: hidden;
      }

      .sidebar-inner {
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .sidebar-header {
        padding: 0 20px 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .sidebar-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .sidebar-logo {
        font-size: 32px;
        flex-shrink: 0;
      }

      .sidebar-header-text {
        transition: all 0.4s ease;
        white-space: nowrap;
      }

      .sidebar-header-text h2 {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
      }

      .sidebar-header-text p {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        margin: 2px 0 0 0;
      }

      .sidebar-nav-items {
        flex: 1;
        padding: 0 12px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        margin-bottom: 8px;
        border-radius: 12px;
        text-decoration: none;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
        border: 1px solid transparent;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateX(4px);
      }

      .nav-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(236, 72, 153, 0.3) 100%);
        color: white;
        border-color: rgba(102, 126, 234, 0.5);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      /* When collapsed, show active state as left border only */
      #sidebarNav.collapsed .nav-item.active {
        background: transparent;
        border: 1px solid transparent;
        border-left: 4px solid #667eea;
        box-shadow: none;
        padding-left: 13px;
      }

      .nav-item-icon {
        font-size: 22px;
        flex-shrink: 0;
        width: 24px;
        text-align: center;
      }

      .nav-item-label {
        font-weight: 600;
        font-size: 15px;
        white-space: nowrap;
        transition: all 0.4s ease;
      }

      .sidebar-footer {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: auto;
      }

      .sidebar-toggle-btn {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
      }

      .sidebar-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .sidebar-footer-text {
        transition: all 0.4s ease;
        white-space: nowrap;
      }

      /* Adjust main content when sidebar is expanded */
      body:not(.sidebar-collapsed) #root {
        margin-left: 280px;
        transition: margin-left 0.4s ease;
      }

      body.sidebar-collapsed #root {
        margin-left: 70px;
        transition: margin-left 0.4s ease;
      }

      /* Responsive behavior */
      @media (max-width: 1024px) {
        #sidebarNav:not(.collapsed) { width: 280px; }
        body:not(.sidebar-collapsed) #root { margin-left: 0; }
        body.sidebar-collapsed #root { margin-left: 0; }
        #sidebarNav.collapsed { transform: translateX(-100%); }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar Navigation -->
    <div id="sidebarNav" class="">
      <div class="sidebar-inner">
        <div class="sidebar-header">
          <div class="sidebar-header-content">
            <div class="sidebar-logo">ü§ñ</div>
            <div class="sidebar-header-text">
              <h2>BottyOtty</h2>
              <p>Task Manager</p>
            </div>
          </div>
        </div>

        <div class="sidebar-nav-items">
          <!-- Dashboard - Mark as active on Dashboard page -->
          <a href="dashboard.html" class="nav-item active">
            <span class="nav-item-icon">üìä</span>
            <span class="nav-item-label">Dashboard</span>
          </a>

          <!-- Admin Panel - Mark as active on Admin page -->
          <a href="admin.html" class="nav-item">
            <span class="nav-item-icon">‚öôÔ∏è</span>
            <span class="nav-item-label">Admin Panel</span>
          </a>

          <!-- Quick Launch - Mark as active on Quick Launch page -->
          <a href="quick-launch.html" class="nav-item">
            <span class="nav-item-icon">üöÄ</span>
            <span class="nav-item-label">Quick Launch</span>
          </a>

          <!-- Reports - Mark as active on Reports page -->
          <a href="reports.html" class="nav-item">
            <span class="nav-item-icon">üìà</span>
            <span class="nav-item-label">Reports</span>
          </a>

          <!-- Help - Mark as active on Help page -->
          <a href="help.html" class="nav-item">
            <span class="nav-item-icon">‚ùì</span>
            <span class="nav-item-label">Help Guide</span>
          </a>

          <!-- Newsletter - Mark as active on Newsletter page -->
          <a href="newsletter.html" class="nav-item">
            <span class="nav-item-icon">üì∞</span>
            <span class="nav-item-label">Newsletter</span>
          </a>
        </div>

        <div class="sidebar-footer">
          <button onclick="toggleSidebar()" class="sidebar-toggle-btn">
            <span id="sidebarToggleIcon">‚Üê</span>
            <span class="sidebar-footer-text" id="sidebarToggleText">Collapse</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Sticky Notes Toggle Button (rendered by React) -->
    <div id="sticky-notes-root"></div>

    <!-- Customization Toggle Button -->
    <button id="customizeToggleBtn" onclick="toggleCustomizationPanel()">
      ‚öôÔ∏è
    </button>

    <!-- Customization Panel -->
    <div id="customizationPanel" class="minimized">
      <div class="customize-inner">
        <div class="customize-header">
          <h1>üé® Customization</h1>
          <div class="user-mode-toggle">
            <label>View as:</label>
            <div
              class="toggle-switch"
              id="userModeToggle"
              onclick="toggleUserMode()"
            >
              <div class="toggle-slider"></div>
            </div>
            <span class="mode-label" id="modeLabel">Admin</span>
          </div>
        </div>

        <!-- Theme Presets -->
        <div class="customize-section">
          <h2>üé® Theme Presets</h2>
          <div class="preset-grid">
            <div class="preset-btn active" onclick="applyTheme('dark-mode')">
              <div class="preset-name">Dark Mode</div>
              <div class="preset-desc">Professional navy & orange</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #324973"></div>
                <div class="color-dot" style="background: #f37b28"></div>
                <div class="color-dot" style="background: #001541"></div>
              </div>
            </div>

            <div class="preset-btn" onclick="applyTheme('light-clean')">
              <div class="preset-name">Light & Clean</div>
              <div class="preset-desc">White background, navy text</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #ffffff"></div>
                <div class="color-dot" style="background: #324973"></div>
                <div class="color-dot" style="background: #ff8b01"></div>
              </div>
            </div>

            <div class="preset-btn" onclick="applyTheme('warm-welcoming')">
              <div class="preset-name">Warm & Welcoming</div>
              <div class="preset-desc">Light orange tints</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #fff5eb"></div>
                <div class="color-dot" style="background: #ffbc6c"></div>
                <div class="color-dot" style="background: #324973"></div>
              </div>
            </div>

            <div class="preset-btn" onclick="applyTheme('premium-dark')">
              <div class="preset-name">Premium Dark</div>
              <div class="preset-desc">Dark navy with glows</div>
              <div class="color-preview">
                <div class="color-dot" style="background: #001541"></div>
                <div class="color-dot" style="background: #ff8b01"></div>
                <div class="color-dot" style="background: #566685"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout Options -->
        <div class="customize-section">
          <h2>üìê Layout Options</h2>
          <div class="preset-grid">
            <div class="preset-btn active" onclick="applyLayout('minimalist')">
              <div class="preset-name">Minimalist Clean</div>
              <div class="preset-desc">Spacious & simple</div>
            </div>

            <div class="preset-btn" onclick="applyLayout('bold-card')">
              <div class="preset-name">Bold Card-Based</div>
              <div class="preset-desc">Strong visual cards</div>
            </div>

            <div class="preset-btn" onclick="applyLayout('dashboard-grid')">
              <div class="preset-name">Dashboard Grid</div>
              <div class="preset-desc">Organized grid layout</div>
            </div>

            <div class="preset-btn" onclick="applyLayout('list-view')">
              <div class="preset-name">List View Clean</div>
              <div class="preset-desc">Compact list format</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved Indicator -->
    <div class="saved-indicator" id="savedIndicator">‚úì Preferences Saved</div>

    <div id="root"></div>

    <!-- Customization System JavaScript -->
    <script>
      // Theme configurations (same as Admin Panel)
      const THEMES = {
        "dark-mode": {
          name: "Dark Mode",
          primary: "#324973",
          primaryLight: "#566685",
          primaryDark: "#001541",
          secondary: "#ec4899",
          secondaryLight: "#f472b6",
          secondaryDark: "#db2777",
          accent: "#f37b28",
          accentLight: "#ffbc6c",
          accentDark: "#ff8b01",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#0f0f23",
          bgSecondary: "#1a1a3e",
          bgTertiary: "#252554",
          surface: "rgba(255, 255, 255, 0.03)",
          surfaceHover: "rgba(255, 255, 255, 0.06)",
          surfaceActive: "rgba(255, 255, 255, 0.09)",
          textPrimary: "#ffffff",
          textSecondary: "rgba(255, 255, 255, 0.7)",
          textTertiary: "rgba(255, 255, 255, 0.4)",
          border: "rgba(255, 255, 255, 0.08)",
          borderFocus: "rgba(99, 102, 241, 0.4)",
        },
        "light-clean": {
          name: "Light & Clean",
          primary: "#324973",
          primaryLight: "#566685",
          primaryDark: "#001541",
          secondary: "#f37b28",
          secondaryLight: "#ffbc6c",
          secondaryDark: "#ff8b01",
          accent: "#ff8b01",
          accentLight: "#ffbc6c",
          accentDark: "#f37b28",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#ffffff",
          bgSecondary: "#f8f9fa",
          bgTertiary: "#e9ecef",
          surface: "rgba(50, 73, 115, 0.05)",
          surfaceHover: "rgba(50, 73, 115, 0.08)",
          surfaceActive: "rgba(50, 73, 115, 0.12)",
          textPrimary: "#001541",
          textSecondary: "#324973",
          textTertiary: "#566685",
          border: "rgba(50, 73, 115, 0.15)",
          borderFocus: "rgba(255, 139, 1, 0.4)",
        },
        "warm-welcoming": {
          name: "Warm & Welcoming",
          primary: "#324973",
          primaryLight: "#566685",
          primaryDark: "#001541",
          secondary: "#f37b28",
          secondaryLight: "#ff8b01",
          secondaryDark: "#cc6622",
          accent: "#f37b28",
          accentLight: "#ff8b01",
          accentDark: "#cc6622",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#fff5eb",
          bgSecondary: "#ffe5c7",
          bgTertiary: "#ffd9a3",
          surface: "rgba(255, 139, 1, 0.08)",
          surfaceHover: "rgba(255, 139, 1, 0.12)",
          surfaceActive: "rgba(255, 139, 1, 0.16)",
          textPrimary: "#001541",
          textSecondary: "#324973",
          textTertiary: "#566685",
          border: "rgba(243, 123, 40, 0.2)",
          borderFocus: "rgba(243, 123, 40, 0.4)",
        },
        "premium-dark": {
          name: "Premium Dark",
          primary: "#001541",
          primaryLight: "#324973",
          primaryDark: "#000a1f",
          secondary: "#ff8b01",
          secondaryLight: "#ffbc6c",
          secondaryDark: "#f37b28",
          accent: "#ff8b01",
          accentLight: "#ffbc6c",
          accentDark: "#f37b28",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
          bgPrimary: "#000a1f",
          bgSecondary: "#001541",
          bgTertiary: "#001d5a",
          surface: "rgba(255, 139, 1, 0.05)",
          surfaceHover: "rgba(255, 139, 1, 0.08)",
          surfaceActive: "rgba(255, 139, 1, 0.12)",
          textPrimary: "#ffffff",
          textSecondary: "rgba(255, 255, 255, 0.7)",
          textTertiary: "#566685",
          border: "rgba(255, 139, 1, 0.15)",
          borderFocus: "rgba(255, 139, 1, 0.4)",
        },
      };

      // Layout configurations
      const LAYOUTS = {
        minimalist: {
          name: "Minimalist Clean",
          spacing: "spacious",
          cardStyle: "minimal",
          borderRadius: "16px",
          cardPadding: "32px",
          gap: "24px",
        },
        "bold-card": {
          name: "Bold Card-Based",
          spacing: "comfortable",
          cardStyle: "bold",
          borderRadius: "20px",
          cardPadding: "28px",
          gap: "20px",
        },
        "dashboard-grid": {
          name: "Dashboard Grid",
          spacing: "compact",
          cardStyle: "grid",
          borderRadius: "12px",
          cardPadding: "20px",
          gap: "16px",
        },
        "list-view": {
          name: "List View Clean",
          spacing: "tight",
          cardStyle: "list",
          borderRadius: "8px",
          cardPadding: "16px",
          gap: "12px",
        },
      };

      let currentTheme = "dark-mode";
      let currentLayout = "minimalist";
      let isUserMode = false;
      let adminSettings = { theme: "dark-mode", layout: "minimalist" };
      let userSettings = { theme: null, layout: null };

      function initCustomization() {
        loadSettings();
        const effectiveTheme =
          isUserMode && userSettings.theme
            ? userSettings.theme
            : adminSettings.theme;
        const effectiveLayout =
          isUserMode && userSettings.layout
            ? userSettings.layout
            : adminSettings.layout;
        applyTheme(effectiveTheme, false);
        applyLayout(effectiveLayout, false);
      }

      function toggleCustomizationPanel() {
        const panel = document.getElementById("customizationPanel");
        const btn = document.getElementById("customizeToggleBtn");
        panel.classList.toggle("minimized");
        btn.textContent = panel.classList.contains("minimized") ? "‚öôÔ∏è" : "‚úï";
      }

      function applyTheme(themeId, save = true) {
        const theme = THEMES[themeId];
        if (!theme) return;

        const root = document.documentElement;
        Object.keys(theme).forEach((key) => {
          if (key !== "name") {
            const cssVarName =
              "--" + key.replace(/([A-Z])/g, "-$1").toLowerCase();
            root.style.setProperty(cssVarName, theme[key]);
          }
        });

        if (themeId === "light-clean" || themeId === "warm-welcoming") {
          document.body.style.background = theme.bgPrimary;
        } else {
          document.body.style.background = `linear-gradient(135deg, ${theme.bgPrimary} 0%, ${theme.bgSecondary} 25%, ${theme.bgTertiary} 50%, ${theme.bgSecondary} 75%, ${theme.bgPrimary} 100%)`;
          document.body.style.backgroundSize = "200% 200%";
        }

        document
          .querySelectorAll(".preset-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event?.target?.closest(".preset-btn")?.classList.add("active");

        currentTheme = themeId;
        if (save) {
          saveSettings();
          showSavedIndicator();
        }
      }

      function applyLayout(layoutId, save = true) {
        const layout = LAYOUTS[layoutId];
        if (!layout) return;

        const root = document.documentElement;
        root.style.setProperty(
          "--layout-spacing",
          layout.spacing === "spacious"
            ? "32px"
            : layout.spacing === "comfortable"
              ? "24px"
              : layout.spacing === "compact"
                ? "16px"
                : "12px",
        );
        root.style.setProperty("--card-border-radius", layout.borderRadius);
        root.style.setProperty("--card-padding", layout.cardPadding);
        root.style.setProperty("--card-gap", layout.gap);

        document.body.className = document.body.className.replace(
          /layout-\w+/g,
          "",
        );
        document.body.classList.add(`layout-${layoutId}`);

        const allSections = document.querySelectorAll(".customize-section");
        allSections.forEach((section) => {
          const heading = section.querySelector("h2");
          if (heading && heading.textContent.includes("Layout")) {
            section
              .querySelectorAll(".preset-btn")
              .forEach((btn) => btn.classList.remove("active"));
            const clickedBtn = event?.target?.closest(".preset-btn");
            if (clickedBtn) clickedBtn.classList.add("active");
          }
        });

        currentLayout = layoutId;
        if (save) {
          saveSettings();
          showSavedIndicator();
        }
      }

      function toggleUserMode() {
        isUserMode = !isUserMode;
        const toggle = document.getElementById("userModeToggle");
        const label = document.getElementById("modeLabel");
        toggle.classList.toggle("active");
        label.textContent = isUserMode ? "User" : "Admin";
        const effectiveTheme =
          isUserMode && userSettings.theme
            ? userSettings.theme
            : adminSettings.theme;
        const effectiveLayout =
          isUserMode && userSettings.layout
            ? userSettings.layout
            : adminSettings.layout;
        applyTheme(effectiveTheme, false);
        applyLayout(effectiveLayout, false);
      }

      function saveSettings() {
        if (isUserMode) {
          userSettings.theme = currentTheme;
          userSettings.layout = currentLayout;
          localStorage.setItem(
            "bottyotty_user_settings",
            JSON.stringify(userSettings),
          );
        } else {
          adminSettings.theme = currentTheme;
          adminSettings.layout = currentLayout;
          localStorage.setItem(
            "bottyotty_admin_settings",
            JSON.stringify(adminSettings),
          );
        }
      }

      function loadSettings() {
        const savedAdmin = localStorage.getItem("bottyotty_admin_settings");
        const savedUser = localStorage.getItem("bottyotty_user_settings");
        if (savedAdmin) {
          try {
            const parsed = JSON.parse(savedAdmin);
            adminSettings = {
              theme: parsed.theme || "dark-mode",
              layout: parsed.layout || "minimalist",
            };
          } catch (e) {
            console.error("Failed to parse admin settings", e);
          }
        }
        if (savedUser) {
          try {
            const parsed = JSON.parse(savedUser);
            userSettings = {
              theme: parsed.theme || null,
              layout: parsed.layout || null,
            };
          } catch (e) {
            console.error("Failed to parse user settings", e);
          }
        }
      }

      function showSavedIndicator() {
        const indicator = document.getElementById("savedIndicator");
        indicator.classList.add("show");
        setTimeout(() => {
          indicator.classList.remove("show");
        }, 2000);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCustomization);
      } else {
        initCustomization();
      }
    </script>

    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // Configuration
      const BOT_CONFIG = {
        enabled: true,
        apiUrl: "https://bottyotty-production.up.railway.app",
        autoSync: true,
        syncInterval: 30000,
        userId: 928725439059464222,
      };

      const STORAGE_KEY = "bottyotty-tasks-v6";
      const BACKUP_AT_KEY = "bottyotty-last-backup";
      const SESSION_REMINDER_KEY = "bottyotty-reminder-shown-session";
      const LAST_SYNC_HASH_KEY = "bottyotty-last-sync-hash";
      const ADMIN_CONFIG_KEY = "bottyotty-admin-config";

      // Load admin configuration if available
      const loadAdminConfig = () => {
        const saved = localStorage.getItem(ADMIN_CONFIG_KEY);
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            console.error("Failed to load admin config:", e);
            return null;
          }
        }
        return null;
      };

      const adminConfig = loadAdminConfig();

      // Apply admin config to BOT_CONFIG if available (handles both nested and flat formats)
      if (adminConfig) {
        const botConfig = adminConfig.botConfig || adminConfig;
        if (botConfig.apiUrl) BOT_CONFIG.apiUrl = botConfig.apiUrl;
        if (botConfig.autoSync !== undefined)
          BOT_CONFIG.autoSync = botConfig.autoSync;
        if (botConfig.syncInterval)
          BOT_CONFIG.syncInterval = botConfig.syncInterval * 1000;
      }

      // Use admin config category colors if available (handles both nested and flat formats), otherwise defaults
      const appearance = adminConfig?.appearance || adminConfig;
      const CATEGORY_COLORS = appearance?.categoryColors || {
        Design: { bg: "#fce7f3", text: "#be185d", border: "#ec4899" },
        Development: { bg: "#dbeafe", text: "#1e40af", border: "#3b82f6" },
        "Bug Fix": { bg: "#fee2e2", text: "#991b1b", border: "#ef4444" },
        Feature: { bg: "#d1fae5", text: "#065f46", border: "#10b981" },
        Documentation: { bg: "#e0e7ff", text: "#3730a3", border: "#6366f1" },
        Meeting: { bg: "#fef3c7", text: "#92400e", border: "#f59e0b" },
        General: { bg: "#f3f4f6", text: "#374151", border: "#9ca3af" },
      };

      // Note: Background gradient is applied in useEffect after component mounts

      // Utility Functions
      function dateKeyFromLocal(date = new Date()) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }

      function parseDateKey(key) {
        if (!key) return new Date();
        const [y, m, d] = key.split("-").map(Number);
        if (!y || !m || !d) return new Date();
        return new Date(y, m - 1, d);
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = parseDateKey(dateStr);
        return d.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function getCategoryColor(category) {
        return CATEGORY_COLORS[category] || CATEGORY_COLORS["General"];
      }

      function isOverdue(task) {
        if (task.status !== "active" || !task.endDate) return false;
        const today = dateKeyFromLocal(new Date());
        return task.endDate < today;
      }

      // Bot Status Component
      function BotStatus({ apiUrl }) {
        const [status, setStatus] = useState("checking");

        const checkStatus = async () => {
          try {
            const res = await fetch(`${apiUrl}/api/health`);
            if (res.ok) {
              setStatus("online");
            } else {
              setStatus("offline");
            }
          } catch (error) {
            setStatus("offline");
          }
        };

        useEffect(() => {
          checkStatus();
          const interval = setInterval(checkStatus, 60000); // Check every minute
          return () => clearInterval(interval);
        }, [apiUrl]);

        return (
          <div className={`bot-status ${status}`}>
            <div className="status-dot"></div>
            {status === "online" && "Bot Online"}
            {status === "offline" && "Bot Offline"}
            {status === "checking" && "Checking..."}
          </div>
        );
      }

      // Backup Reminder Toast (FIXED - only shows once per session after 7 days)
      function BackupReminder({ onExport, onDismiss }) {
        return (
          <div className="backup-toast">
            <div className="flex items-start gap-3">
              <span className="text-2xl">üíæ</span>
              <div className="flex-1">
                <p className="font-bold mb-1">Backup Reminder</p>
                <p className="text-sm mb-3">
                  It's been a week! Back up your tasks to stay safe.
                </p>
                <div className="flex gap-2">
                  <button
                    onClick={onExport}
                    className="px-4 py-2 bg-amber-800 hover:bg-amber-900 text-white rounded-lg text-sm font-medium"
                  >
                    Export Now
                  </button>
                  <button
                    onClick={onDismiss}
                    className="px-4 py-2 bg-amber-700 hover:bg-amber-800 text-white rounded-lg text-sm"
                  >
                    Later
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Notification Component
      function Notification({ message, type = "info", onClose }) {
        useEffect(() => {
          const timer = setTimeout(onClose, 5000);
          return () => clearTimeout(timer);
        }, [onClose]);

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
          warning: "bg-yellow-500",
        };

        return (
          <div
            className={`notification-enter fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl z-50 max-w-md`}
          >
            <div className="flex items-center gap-3">
              <span className="text-2xl">
                {type === "success" && "‚úÖ"}
                {type === "error" && "‚ùå"}
                {type === "info" && "‚ÑπÔ∏è"}
                {type === "warning" && "‚ö†Ô∏è"}
              </span>
              <p className="font-medium">{message}</p>
              <button
                onClick={onClose}
                className="ml-auto text-white hover:text-gray-200"
              >
                √ó
              </button>
            </div>
          </div>
        );
      }

      // Login Modal
      function LoginModal({ onLogin }) {
        const [selectedUser, setSelectedUser] = useState("");

        const handleLogin = () => {
          if (!selectedUser) {
            alert("Please select a user");
            return;
          }
          const user = TEAM_MEMBERS.find((m) => m.name === selectedUser);
          if (user) {
            onLogin(user);
          }
        };

        return (
          <div className="modal-backdrop fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div
              style={{
                background: "rgba(255, 255, 255, 0.15)",
                backdropFilter: "blur(10px)",
                border: "1px solid rgba(255, 255, 255, 0.2)",
              }}
              className="rounded-2xl p-8 max-w-md w-full shadow-2xl"
            >
              <div className="text-center mb-6">
                <h2 className="text-3xl font-bold text-white mb-2">
                  Welcome to BottyOtty
                </h2>
                <p className="text-gray-200">Select your name to continue</p>
              </div>

              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-200 mb-2">
                  Your Name
                </label>
                <select
                  value={selectedUser}
                  onChange={(e) => setSelectedUser(e.target.value)}
                  style={{
                    background: "rgba(255, 255, 255, 0.1)",
                    border: "1px solid rgba(255, 255, 255, 0.3)",
                  }}
                  style={{
                    background: "rgba(255, 255, 255, 0.1)",
                    border: "1px solid rgba(255, 255, 255, 0.3)",
                  }}
                  className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                  autoFocus
                >
                  <option value="">-- Select Your Name --</option>
                  {TEAM_MEMBERS.map((member) => (
                    <option key={member.discordId} value={member.name}>
                      {member.name}
                    </option>
                  ))}
                </select>
              </div>

              <button
                onClick={handleLogin}
                className="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-all"
              >
                Login
              </button>
            </div>
          </div>
        );
      }

      // Add Task Modal
      function AddTaskModal({
        onSave,
        onClose,
        assignees = [],
        categories = [],
        currentUser,
      }) {
        const [newTask, setNewTask] = useState({
          name: "",
          link: "",
          requestedBy: "", // New field for requester
          assignee: "", // Blank by default
          category: "General",
          priority: "low", // Default to Low priority
          startDate: "",
          endDate: "",
          notes: "",
          isRecurring: false,
          recurringFrequency: "weekly",
          recurringDay: 1,
          destination: "my-tasks", // Default destination
        });
        const [assigneeSearch, setAssigneeSearch] = useState("");
        const [showAssigneeDropdown, setShowAssigneeDropdown] = useState(false);
        const [requestedBySearch, setRequestedBySearch] = useState("");
        const [showRequestedByDropdown, setShowRequestedByDropdown] =
          useState(false);

        // Filter team members based on search
        const filteredTeamMembers = TEAM_MEMBERS.filter((member) =>
          member.name.toLowerCase().includes(assigneeSearch.toLowerCase()),
        );

        const filteredRequestedByMembers = TEAM_MEMBERS.filter((member) =>
          member.name.toLowerCase().includes(requestedBySearch.toLowerCase()),
        );

        // Smart defaulting: Update destination based on assignee
        const handleAssigneeChange = (assigneeName) => {
          let suggestedDestination = newTask.destination;

          if (!assigneeName) {
            // No assignee ‚Üí suggest My Tasks
            suggestedDestination = "my-tasks";
          } else if (assigneeName !== currentUser?.name) {
            // Assignee is someone else ‚Üí suggest Assigned Out
            suggestedDestination = "assigned-out";
          }

          setNewTask({
            ...newTask,
            assignee: assigneeName,
            destination: suggestedDestination,
          });
        };

        const handleSubmit = () => {
          if (!newTask.name.trim()) {
            alert("Task name is required!");
            return;
          }
          onSave(newTask);
          onClose();
        };

        return (
          <div className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div
              style={{
                background: "rgba(255, 255, 255, 0.15)",
                backdropFilter: "blur(10px)",
                border: "1px solid rgba(255, 255, 255, 0.2)",
              }}
              className="rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide shadow-2xl"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-3xl font-bold text-white">
                  ‚ûï Create New Task
                </h2>
                <button
                  onClick={onClose}
                  className="text-gray-200 hover:text-white text-2xl"
                >
                  √ó
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    Task Name *
                  </label>
                  <input
                    type="text"
                    value={newTask.name}
                    onChange={(e) =>
                      setNewTask({ ...newTask, name: e.target.value })
                    }
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder="Enter task name..."
                    autoFocus
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    Link (optional)
                  </label>
                  <input
                    type="url"
                    value={newTask.link}
                    onChange={(e) =>
                      setNewTask({ ...newTask, link: e.target.value })
                    }
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder="https://example.com"
                  />
                </div>

                {/* Category and Priority on same row */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      Category
                    </label>
                    {categories.length > 0 ? (
                      <select
                        value={newTask.category}
                        onChange={(e) =>
                          setNewTask({ ...newTask, category: e.target.value })
                        }
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                      >
                        <option value="General">General</option>
                        {categories.map((c) => (
                          <option key={c} value={c}>
                            {c}
                          </option>
                        ))}
                      </select>
                    ) : (
                      <input
                        type="text"
                        value={newTask.category}
                        onChange={(e) =>
                          setNewTask({ ...newTask, category: e.target.value })
                        }
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                      />
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      Priority
                    </label>
                    <div className="grid grid-cols-4 gap-2">
                      {[
                        {
                          value: "low",
                          label: "L",
                          color: "bg-green-600",
                          hoverColor: "hover:bg-green-700",
                          border: "border-green-500",
                        },
                        {
                          value: "medium",
                          label: "M",
                          color: "bg-yellow-600",
                          hoverColor: "hover:bg-yellow-700",
                          border: "border-yellow-500",
                        },
                        {
                          value: "high",
                          label: "H",
                          color: "bg-orange-600",
                          hoverColor: "hover:bg-orange-700",
                          border: "border-orange-500",
                        },
                        {
                          value: "urgent",
                          label: "U!",
                          color: "bg-red-600",
                          hoverColor: "hover:bg-red-700",
                          border: "border-red-500",
                        },
                      ].map((priority) => (
                        <button
                          key={priority.value}
                          type="button"
                          onClick={(e) => {
                            e.stopPropagation();
                            setNewTask({
                              ...newTask,
                              priority: priority.value,
                            });
                          }}
                          className={`flex items-center justify-center p-3 rounded-lg border-2 transition-all ${
                            newTask.priority === priority.value
                              ? `${priority.color} ${priority.border} shadow-lg`
                              : `glass-element border-white border-opacity-30 ${priority.hoverColor} hover:border-white hover:border-opacity-40`
                          }`}
                        >
                          <span className="text-white font-bold text-base">
                            {priority.label}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Requested By, Assigned To, and Destination in 3 columns */}
                <div className="grid grid-cols-3 gap-4">
                  {/* Requested By */}
                  <div className="relative">
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      üë§ Requested By
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        value={requestedBySearch || newTask.requestedBy || ""}
                        onChange={(e) => {
                          setRequestedBySearch(e.target.value);
                          setShowRequestedByDropdown(true);
                          if (!e.target.value) {
                            setNewTask({ ...newTask, requestedBy: "" });
                          }
                        }}
                        onFocus={() => setShowRequestedByDropdown(true)}
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Optional..."
                      />
                      {showRequestedByDropdown && requestedBySearch && (
                        <div className="absolute z-50 mt-2 w-full glass-panel border border-gray-700 rounded-lg shadow-2xl max-h-60 overflow-y-auto">
                          {filteredRequestedByMembers.length > 0 ? (
                            filteredRequestedByMembers.map((member) => (
                              <button
                                key={member.discordId}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setNewTask({
                                    ...newTask,
                                    requestedBy: member.name,
                                  });
                                  setRequestedBySearch("");
                                  setShowRequestedByDropdown(false);
                                }}
                                className="w-full text-left px-4 py-3 hover:bg-purple-600 hover:bg-opacity-30 text-white transition-colors border-b border-gray-700 last:border-b-0"
                              >
                                {member.name}
                              </button>
                            ))
                          ) : (
                            <div className="px-4 py-3 text-gray-500 text-sm">
                              No matches found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    <p className="text-xs text-gray-300 mt-1">
                      Who requested this?
                    </p>
                  </div>

                  {/* Assigned To */}
                  <div className="relative">
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      üë∑ Assigned To
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        value={assigneeSearch || newTask.assignee || ""}
                        onChange={(e) => {
                          setAssigneeSearch(e.target.value);
                          setShowAssigneeDropdown(true);
                          if (!e.target.value) {
                            handleAssigneeChange("");
                          }
                        }}
                        onFocus={() => setShowAssigneeDropdown(true)}
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Leave blank for My Tasks..."
                      />
                      {showAssigneeDropdown && assigneeSearch && (
                        <div className="absolute z-50 mt-2 w-full glass-panel border border-gray-700 rounded-lg shadow-2xl max-h-60 overflow-y-auto">
                          {filteredTeamMembers.length > 0 ? (
                            filteredTeamMembers.map((member) => (
                              <button
                                key={member.discordId}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleAssigneeChange(member.name);
                                  setAssigneeSearch("");
                                  setShowAssigneeDropdown(false);
                                }}
                                className="w-full text-left px-4 py-3 hover:bg-purple-600 hover:bg-opacity-30 text-white transition-colors border-b border-gray-700 last:border-b-0"
                              >
                                {member.name}
                              </button>
                            ))
                          ) : (
                            <div className="px-4 py-3 text-gray-500 text-sm">
                              No matches found
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    <p className="text-xs text-gray-300 mt-1">
                      Smart defaults destination
                    </p>
                  </div>

                  {/* Destination */}
                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      üìç Destination
                    </label>
                    <select
                      value={newTask.destination}
                      onChange={(e) => {
                        const dest = e.target.value;
                        setNewTask({
                          ...newTask,
                          destination: dest,
                          // If pool is selected, clear assignee
                          assignee: dest === "pool" ? "" : newTask.assignee,
                        });
                      }}
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        background: "rgba(255, 255, 255, 0.1)",
                        border: "1px solid rgba(255, 255, 255, 0.3)",
                      }}
                      className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                      <option value="my-tasks">üìã My Tasks</option>
                      <option value="assigned-out">üì§ Assigned Out</option>
                      <option value="pool">üèä Pool</option>
                      <option value="team">üéØ Team Requests</option>
                      <option value="incoming">üì• Incoming</option>
                      <option value="campfire">üî• Campfire</option>
                    </select>
                    <p className="text-xs text-gray-300 mt-1">
                      Override if needed
                    </p>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    Notes
                  </label>
                  <textarea
                    value={newTask.notes || ""}
                    onChange={(e) =>
                      setNewTask({ ...newTask, notes: e.target.value })
                    }
                    onClick={(e) => e.stopPropagation()}
                    rows="4"
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none resize-none"
                    placeholder="Add notes..."
                  />
                </div>

                {/* Due Date and Recurring on same row */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      Due Date
                    </label>
                    <input
                      type="date"
                      value={newTask.endDate || ""}
                      onChange={(e) =>
                        setNewTask({ ...newTask, endDate: e.target.value })
                      }
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        background: "rgba(255, 255, 255, 0.1)",
                        border: "1px solid rgba(255, 255, 255, 0.3)",
                      }}
                      className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      Recurring
                    </label>
                    <div className="grid grid-cols-2 gap-2">
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          setNewTask({ ...newTask, isRecurring: false });
                        }}
                        className={`flex items-center justify-center p-3 rounded-lg border-2 transition-all ${
                          !newTask.isRecurring
                            ? "bg-gray-600 border-gray-500 shadow-lg"
                            : "glass-element border-white border-opacity-30 hover:bg-white hover:bg-opacity-20 hover:border-white hover:border-opacity-40"
                        }`}
                      >
                        <span className="text-white font-medium text-sm">
                          No
                        </span>
                      </button>
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          setNewTask({ ...newTask, isRecurring: true });
                        }}
                        className={`flex items-center justify-center p-3 rounded-lg border-2 transition-all ${
                          newTask.isRecurring
                            ? "bg-blue-600 border-blue-500 shadow-lg"
                            : "glass-element border-white border-opacity-30 hover:bg-blue-700 hover:border-blue-500"
                        }`}
                      >
                        <span className="text-white font-medium text-sm">
                          Yes
                        </span>
                      </button>
                    </div>
                  </div>
                </div>

                {/* Recurring frequency options - shown when recurring is enabled */}
                {newTask.isRecurring && (
                  <div className="grid grid-cols-2 gap-4 p-4 glass-panel rounded-lg">
                    <div>
                      <label className="block text-sm font-medium text-gray-200 mb-2">
                        Frequency
                      </label>
                      <select
                        value={newTask.recurringFrequency}
                        onChange={(e) =>
                          setNewTask({
                            ...newTask,
                            recurringFrequency: e.target.value,
                          })
                        }
                        onClick={(e) => e.stopPropagation()}
                        className="w-full px-3 py-2 glass-panel text-white rounded-lg border border-white border-opacity-30 focus:border-blue-500 focus:outline-none text-sm"
                      >
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                      </select>
                    </div>

                    {newTask.recurringFrequency === "weekly" && (
                      <div>
                        <label className="block text-sm font-medium text-gray-200 mb-2">
                          Day of Week
                        </label>
                        <select
                          value={newTask.recurringDay}
                          onChange={(e) =>
                            setNewTask({
                              ...newTask,
                              recurringDay: parseInt(e.target.value),
                            })
                          }
                          onClick={(e) => e.stopPropagation()}
                          className="w-full px-3 py-2 glass-panel text-white rounded-lg border border-white border-opacity-30 focus:border-blue-500 focus:outline-none text-sm"
                        >
                          <option value="1">Monday</option>
                          <option value="2">Tuesday</option>
                          <option value="3">Wednesday</option>
                          <option value="4">Thursday</option>
                          <option value="5">Friday</option>
                          <option value="6">Saturday</option>
                          <option value="0">Sunday</option>
                        </select>
                      </div>
                    )}

                    {newTask.recurringFrequency === "monthly" && (
                      <div>
                        <label className="block text-sm font-medium text-gray-200 mb-2">
                          Day of Month
                        </label>
                        <select
                          value={newTask.recurringDay}
                          onChange={(e) =>
                            setNewTask({
                              ...newTask,
                              recurringDay: parseInt(e.target.value),
                            })
                          }
                          onClick={(e) => e.stopPropagation()}
                          className="w-full px-3 py-2 glass-panel text-white rounded-lg border border-white border-opacity-30 focus:border-blue-500 focus:outline-none text-sm"
                        >
                          {Array.from({ length: 31 }, (_, i) => i + 1).map(
                            (day) => (
                              <option key={day} value={day}>
                                {day}
                              </option>
                            ),
                          )}
                        </select>
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div className="flex gap-4 mt-8">
                <button
                  onClick={handleSubmit}
                  className="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transform hover:scale-105 transition-all"
                >
                  ‚úÖ Create Task
                </button>
                <button
                  onClick={onClose}
                  className="px-6 py-3 glass-element hover:bg-white hover:bg-opacity-20 text-white rounded-lg font-medium"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Edit Task Modal (FIXED - doesn't reset other tasks)
      function EditTaskModal({
        task,
        onSave,
        onClose,
        assignees = [],
        categories = [],
      }) {
        const [editedTask, setEditedTask] = useState({ ...task });

        const handleSave = () => {
          onSave(editedTask);
          onClose();
        };

        return (
          <div className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div
              className="glass-panel rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-3xl font-bold text-white">
                  ‚úèÔ∏è Edit Task #{task.id}
                </h2>
                <button
                  onClick={onClose}
                  className="text-gray-300 hover:text-white text-2xl"
                >
                  √ó
                </button>
              </div>

              <div className="space-y-4">
                {/* Task Name */}
                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    Task Name
                  </label>
                  <input
                    type="text"
                    value={editedTask.name}
                    onChange={(e) =>
                      setEditedTask({ ...editedTask, name: e.target.value })
                    }
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                {/* Category and Assignee on same row */}
                <div className="grid grid-cols-2 gap-4">
                  {/* Category */}
                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      Category
                    </label>
                    {categories.length > 0 ? (
                      <select
                        value={editedTask.category}
                        onChange={(e) =>
                          setEditedTask({
                            ...editedTask,
                            category: e.target.value,
                          })
                        }
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                      >
                        <option value="General">General</option>
                        {categories.map((c) => (
                          <option key={c} value={c}>
                            {c}
                          </option>
                        ))}
                      </select>
                    ) : (
                      <input
                        type="text"
                        value={editedTask.category}
                        onChange={(e) =>
                          setEditedTask({
                            ...editedTask,
                            category: e.target.value,
                          })
                        }
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                      />
                    )}
                  </div>

                  {/* Assignee */}
                  <div>
                    <label className="block text-sm font-medium text-gray-200 mb-2">
                      Assignee
                    </label>
                    {assignees.length > 0 ? (
                      <select
                        value={editedTask.assignee || ""}
                        onChange={(e) =>
                          setEditedTask({
                            ...editedTask,
                            assignee: e.target.value,
                            assignedTo: e.target.value,
                          })
                        }
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                      >
                        <option value="">Unassigned</option>
                        {assignees.map((a) => (
                          <option key={a.name} value={a.name}>
                            {a.name}
                          </option>
                        ))}
                      </select>
                    ) : (
                      <input
                        type="text"
                        value={editedTask.assignee || ""}
                        onChange={(e) =>
                          setEditedTask({
                            ...editedTask,
                            assignee: e.target.value,
                            assignedTo: e.target.value,
                          })
                        }
                        onClick={(e) => e.stopPropagation()}
                        placeholder="Enter assignee name"
                        style={{
                          background: "rgba(255, 255, 255, 0.1)",
                          border: "1px solid rgba(255, 255, 255, 0.3)",
                        }}
                        className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                      />
                    )}
                  </div>
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    Notes
                  </label>
                  <textarea
                    value={editedTask.notes || ""}
                    onChange={(e) =>
                      setEditedTask({ ...editedTask, notes: e.target.value })
                    }
                    onClick={(e) => e.stopPropagation()}
                    rows="4"
                    placeholder="Add any additional notes here..."
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none resize-none"
                  />
                </div>

                {/* Due Date */}
                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    Due Date
                  </label>
                  <input
                    type="date"
                    value={editedTask.endDate || ""}
                    onChange={(e) =>
                      setEditedTask({ ...editedTask, endDate: e.target.value })
                    }
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                {/* Move To */}
                <div>
                  <label className="block text-sm font-medium text-gray-200 mb-2">
                    üìç Move To
                  </label>
                  <select
                    value={
                      editedTask.isIncoming
                        ? "incoming"
                        : editedTask.isAssignedOut
                          ? "assigned-out"
                          : editedTask.isPoolRequest
                            ? "pool"
                            : editedTask.isTeamRequest
                              ? "team"
                              : editedTask.isCampfire
                                ? "campfire"
                                : "my-tasks"
                    }
                    onChange={(e) => {
                      const value = e.target.value;
                      setEditedTask({
                        ...editedTask,
                        isIncoming: value === "incoming",
                        isAssignedOut: value === "assigned-out",
                        isPoolRequest: value === "pool",
                        isTeamRequest: value === "team",
                        isCampfire: value === "campfire",
                      });
                    }}
                    onClick={(e) => e.stopPropagation()}
                    style={{
                      background: "rgba(255, 255, 255, 0.1)",
                      border: "1px solid rgba(255, 255, 255, 0.3)",
                    }}
                    className="w-full px-4 py-3 text-white rounded-lg focus:border-blue-500 focus:outline-none"
                  >
                    <option value="incoming">üì• Incoming</option>
                    <option value="my-tasks">üìã My Tasks</option>
                    <option value="assigned-out">üì§ Assigned Out</option>
                    <option value="pool">üèä Pool</option>
                    <option value="team">üéØ Requests</option>
                    <option value="campfire">üî• Campfire</option>
                  </select>
                  <p className="text-xs text-gray-300 mt-1">
                    Change which view this task appears in
                  </p>
                </div>
              </div>

              <div className="flex gap-4 mt-8">
                <button
                  onClick={handleSave}
                  className="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transform hover:scale-105 transition-all"
                >
                  üíæ Save Changes
                </button>
                <button
                  onClick={onClose}
                  className="px-6 py-3 glass-element hover:bg-white hover:bg-opacity-20 text-white rounded-lg font-medium"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Expanded Task Modal (for clicking task card)
      function ExpandedTaskModal({ task, onClose, onEdit }) {
        const categoryColor = getCategoryColor(task.category);
        const overdue = isOverdue(task);

        return (
          <div className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div
              className="glass-panel rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-3 flex-wrap">
                  {task.isNew && (
                    <span className="text-sm bg-blue-500 text-white px-3 py-1 rounded-full font-bold">
                      NEW
                    </span>
                  )}
                  {task.isImported && (
                    <span className="text-sm bg-cyan-500 text-white px-3 py-1 rounded-full font-bold">
                      IMPORTED
                    </span>
                  )}
                  <h2 className="text-3xl font-bold text-white">{task.name}</h2>
                  {task.discordTaskNumber && (
                    <span className="text-lg bg-purple-600 text-white px-3 py-1 rounded-full">
                      #{task.discordTaskNumber}
                    </span>
                  )}
                  {overdue && (
                    <span className="text-sm bg-red-600 text-white px-3 py-1 rounded-full font-bold animate-pulse">
                      OVERDUE
                    </span>
                  )}
                </div>
                <button
                  onClick={onClose}
                  className="text-gray-300 hover:text-white text-3xl"
                >
                  √ó
                </button>
              </div>

              <div className="space-y-6">
                {/* Category and Priority */}
                <div className="flex gap-3 flex-wrap">
                  <span
                    className="px-4 py-2 rounded-lg text-base font-semibold"
                    style={{
                      backgroundColor: categoryColor.bg,
                      color: categoryColor.text,
                      border: `2px solid ${categoryColor.border}`,
                    }}
                  >
                    {task.category}
                  </span>
                  <span
                    className={`px-4 py-2 rounded-lg font-semibold text-base ${
                      task.priority === "urgent"
                        ? "bg-red-600 text-white"
                        : task.priority === "high"
                          ? "bg-orange-600 text-white"
                          : task.priority === "medium"
                            ? "bg-yellow-600 text-white"
                            : "bg-green-600 text-white"
                    }`}
                  >
                    {task.priority.toUpperCase()} PRIORITY
                  </span>
                </div>

                {/* Details Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {task.assignee && (
                    <div className="glass-element rounded-lg p-4">
                      <p className="text-gray-300 text-sm mb-1">Assignee</p>
                      <p className="text-white text-lg font-medium">
                        üë§ {task.assignee}
                      </p>
                    </div>
                  )}
                  {task.claimedBy && (
                    <div className="glass-element rounded-lg p-4">
                      <p className="text-gray-300 text-sm mb-1">Claimed By</p>
                      <p className="text-yellow-400 text-lg font-medium">
                        ‚úã {task.claimedBy}
                      </p>
                    </div>
                  )}
                  {task.completedBy && (
                    <div className="glass-element rounded-lg p-4">
                      <p className="text-gray-300 text-sm mb-1">Completed By</p>
                      <p className="text-green-400 text-lg font-medium">
                        ‚úÖ {task.completedBy}
                      </p>
                      {task.completedAt && (
                        <p className="text-gray-300 text-xs mt-1">
                          {new Date(task.completedAt).toLocaleString()}
                        </p>
                      )}
                    </div>
                  )}
                  {task.endDate && (
                    <div className="glass-element rounded-lg p-4">
                      <p className="text-gray-300 text-sm mb-1">Due Date</p>
                      <p className="text-white text-lg font-medium">
                        üìÖ {formatDate(task.endDate)}
                      </p>
                    </div>
                  )}
                  {task.campfireFrom && (
                    <div className="glass-element rounded-lg p-4">
                      <p className="text-gray-300 text-sm mb-1">
                        Campfire From
                      </p>
                      <p className="text-orange-400 text-lg font-medium">
                        üî• {task.campfireFrom}
                      </p>
                    </div>
                  )}
                  {task.recurringFrequency && (
                    <div className="glass-element rounded-lg p-4">
                      <p className="text-gray-300 text-sm mb-1">Recurring</p>
                      <p className="text-blue-400 text-lg font-medium">
                        üîÑ {task.recurringFrequency}
                      </p>
                    </div>
                  )}
                </div>

                {/* Link */}
                {task.link && (
                  <div className="glass-element rounded-lg p-4">
                    <p className="text-gray-300 text-sm mb-2">Link</p>
                    <a
                      href={task.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-blue-400 hover:text-blue-300 text-lg hover:underline break-all"
                    >
                      üîó {task.link}
                    </a>
                  </div>
                )}

                {/* Notes */}
                {task.notes && (
                  <div className="glass-element rounded-lg p-4">
                    <p className="text-gray-300 text-sm mb-2">Notes</p>
                    <p className="text-white text-base leading-relaxed whitespace-pre-wrap">
                      {task.notes}
                    </p>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="flex gap-4 mt-6">
                  <button
                    onClick={() => {
                      onEdit(task);
                      onClose();
                    }}
                    className="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-lg transition-all"
                  >
                    ‚úèÔ∏è Edit Task
                  </button>
                  <button
                    onClick={onClose}
                    className="px-6 py-3 glass-element hover:bg-white hover:bg-opacity-20 text-white rounded-lg font-medium text-lg transition-all"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Day Tasks Modal (for calendar click)
      function DayTasksModal({ dateStr, tasks, onClose, onEditTask }) {
        const dayTasks = tasks.filter(
          (t) => t.endDate === dateStr && t.status !== "completed",
        );

        return (
          <div
            className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
            onClick={onClose}
          >
            <div
              className="glass-panel rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-3xl font-bold text-white">
                  üìÖ Tasks for {formatDate(dateStr)}
                </h2>
                <button
                  onClick={onClose}
                  className="text-gray-300 hover:text-white text-2xl"
                >
                  √ó
                </button>
              </div>

              {dayTasks.length === 0 ? (
                <p className="text-center py-12 text-gray-300 text-xl">
                  No tasks on this day
                </p>
              ) : (
                <div className="space-y-3">
                  {dayTasks.map((task) => {
                    const categoryColor = getCategoryColor(task.category);
                    return (
                      <div
                        key={task.id}
                        className="glass-element rounded-lg p-4 hover:bg-white hover:bg-opacity-20 transition-all"
                      >
                        <div className="flex items-start justify-between mb-2">
                          <div className="flex-1">
                            <h3 className="text-xl font-semibold text-white mb-2">
                              {task.name}
                            </h3>
                            <div className="flex gap-2 flex-wrap">
                              <span
                                className="text-xs px-2 py-1 rounded"
                                style={{
                                  backgroundColor: categoryColor.bg,
                                  color: categoryColor.text,
                                }}
                              >
                                {task.category}
                              </span>
                              <span
                                className={`text-xs px-2 py-1 rounded ${
                                  task.priority === "urgent"
                                    ? "bg-red-600 text-white"
                                    : task.priority === "high"
                                      ? "bg-orange-600 text-white"
                                      : task.priority === "medium"
                                        ? "bg-blue-600 text-white"
                                        : "bg-green-600 text-white"
                                }`}
                              >
                                {task.priority.toUpperCase()}
                              </span>
                            </div>
                          </div>
                          <button
                            onClick={() => {
                              onEditTask(task);
                              onClose();
                            }}
                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium"
                          >
                            ‚úèÔ∏è Edit
                          </button>
                        </div>
                        {task.assignee && (
                          <p className="text-gray-200 text-sm">
                            üë§ {task.assignee}
                          </p>
                        )}
                        {task.notes && (
                          <p className="text-gray-300 text-sm mt-2 glass-panel p-2 rounded">
                            {task.notes}
                          </p>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}

              <button
                onClick={onClose}
                className="w-full mt-6 px-6 py-3 glass-element hover:bg-white hover:bg-opacity-20 text-white rounded-lg font-medium"
              >
                Close
              </button>
            </div>
          </div>
        );
      }

      // Team members with Discord IDs
      const TEAM_MEMBERS = [
        { name: "Dakota", discordId: "220326831524544513" },
        { name: "Preston", discordId: "1060679174945259520" },
        { name: "Dahlya", discordId: "367146081248608257" },
        { name: "Araceli", discordId: "343265486919958529" },
        { name: "Terry", discordId: "528700749555957771" },
        { name: "Cole", discordId: "1317654177412939799" },
        { name: "Devin", discordId: "680757425514479662" },
        { name: "Tony", discordId: "1351211310796242977" },
        { name: "Chase", discordId: "1297804315041333354" },
        { name: "Megan", discordId: "928725439059464222" },
        { name: "Adam", discordId: "353922166250799106" },
        { name: "Amanda", discordId: "1203398569575452745" },
        { name: "Ash", discordId: "289212918615244801" },
        { name: "Caleb", discordId: "423987581483483146" },
        { name: "Charles", discordId: "262990512506667009" },
        { name: "Dylan", discordId: "1229532562200723556" },
        { name: "Edward", discordId: "1277407641479548928" },
        { name: "Fernando", discordId: "1242209699135230012" },
        { name: "Hector", discordId: "1102917622443540511" },
        { name: "Isiac", discordId: "1167611497812340813" },
        { name: "Jeff", discordId: "1239615123765596291" },
        { name: "Joey", discordId: "1228184859772588042" },
        { name: "Jose", discordId: "1060679251235442719" },
        { name: "Matt Kiger", discordId: "792234508736135178" },
        { name: "Lauren", discordId: "931331954220101632" },
        { name: "Logan", discordId: "934632146134519820" },
        { name: "Nathaniel", discordId: "765857167290662913" },
        { name: "Presley", discordId: "1189283572100645005" },
        { name: "Rachel", discordId: "1363874133410189443" },
        { name: "Rafael", discordId: "1354099291177750690" },
        { name: "Raymond", discordId: "1281670710271410279" },
        { name: "Ric", discordId: "1363551896530587760" },
        { name: "Ryan M", discordId: "326967402606624769" },
        { name: "Ryan P", discordId: "1422223702040383529" },
        { name: "Sam", discordId: "883800050524905552" },
        { name: "Sean", discordId: "1385598726361583616" },
        { name: "Summer", discordId: "908784314056052748" },
        { name: "Trevor", discordId: "1127672956051525755" },
        { name: "Tyler", discordId: "1119490397626974280" },
      ];

      // Pool channels configuration
      const POOL_CHANNELS = [
        { name: "SMOT Pool", channelId: "1440575030118449152" },
        { name: "OM Pool", channelId: "1440575273778286684" },
        { name: "Cube Pool", channelId: "1440575543358525555" },
      ];

      // Personal assignment channels (To-Dos and RoundTables)
      const PERSONAL_CHANNELS = {
        // To-Dos
        Ash: "1392524881723392040",
        Preston: "1378435914375757865",
        Presley: "1378435889507733655",
        Joey: "1378435818745499781",
        Jeff: "1378435776823562473",
        Dakota: "1378435732338643066",
        Adam: "1378435680555765841",
        // RoundTables
        Dahlya: "1364145512344981515",
        Araceli: "1364145395956977705",
        Terry: "1364146225959403520",
        Cole: "1427801942327038002",
        Devin: "1364145559119597638",
        Amanda: "1425968878848311326",
        Caleb: "1364145445017882634",
        Charles: "1437224826703056996",
        Dylan: "1364145584524759121",
        Edward: "1425939780025192498",
        Fernando: "1437224785632428062",
        Hector: "1364145633333739590",
        Isiac: "1364145675700273274",
        Jose: "1364145746693324830",
        "Matt Kiger": "1364145899839815690",
        Logan: "1387470240988008551",
        Nathaniel: "1364145942231519262",
        Rachel: "1364146051338211388",
        Rafael: "1364146128861528186",
        Raymond: "1387465577035202661",
        Ric: "1399765599542050816",
        "Ryan M": "1364146186658910259",
        "Ryan P": "1425941108889751712",
        Sam: "1364317982985031711",
        Sean: "1387465649772826664",
        Summer: "1364146209895223337",
        Tony: "1364146256292610110",
        Trevor: "1364146273191460934",
        Tyler: "1364146301805269063",
      };

      // User-specific tab and channel configuration
      const USER_CONFIG_DEFAULTS = {
        Megan: {
          visibleTabs: [
            "incoming",
            "my-tasks",
            "assigned-out",
            "pool",
            "team",
            "transfer-requests",
            "campfire",
            "mentions",
            "future-tasks",
            "calendar",
            "analytics",
          ],
          campfireChannel: "1234567890", // Replace with actual Megan campfire channel ID
          photoTasksChannel: null,
          canViewTeamActivity: true, // Can see all task assignments across team
          canViewAnalytics: true, // Can access Analytics/Reports dashboard
          isAdmin: true, // Can access admin panel
          isManager: true, // Manager privileges
          canMoveTasksFreely: true, // Can move tasks without restrictions
          canApproveTransfers: true, // Can approve task transfers
          skills: [
            "Design",
            "Development",
            "Bug Fix",
            "Feature",
            "Documentation",
            "Meeting",
            "General",
          ], // All skills
          status: "available", // available, busy, swamped
          canReceiveAutoAssignments: true, // Can receive auto-assigned tasks
        },
        Ash: {
          visibleTabs: [
            "incoming",
            "my-tasks",
            "assigned-out",
            "pool",
            "team",
            "transfer-requests",
            "mentions",
            "future-tasks",
            "calendar",
          ],
          campfireChannel: null,
          photoTasksChannel: "1111222233", // Replace with actual Ash photo tasks channel ID
          canViewTeamActivity: false,
          canViewAnalytics: false,
          isAdmin: false,
          isManager: false,
          canMoveTasksFreely: false,
          canApproveTransfers: false,
          skills: ["Design", "Development", "Bug Fix"], // Technical skills
          status: "available",
          canReceiveAutoAssignments: true,
        },
        Preston: {
          visibleTabs: [
            "incoming",
            "my-tasks",
            "assigned-out",
            "pool",
            "team",
            "transfer-requests",
            "mentions",
            "future-tasks",
            "calendar",
            "analytics",
          ],
          campfireChannel: null,
          photoTasksChannel: null,
          canViewTeamActivity: true, // Manager - can see team activity
          canViewAnalytics: true, // Manager - can see analytics
          isAdmin: false,
          isManager: true, // Manager role
          canMoveTasksFreely: true, // Managers can move tasks freely
          canApproveTransfers: true, // Managers can approve transfers
          skills: ["Development", "Bug Fix", "Feature", "Meeting", "General"], // Management + technical
          status: "available",
          canReceiveAutoAssignments: true,
        },
        Dakota: {
          visibleTabs: [
            "incoming",
            "my-tasks",
            "assigned-out",
            "pool",
            "team",
            "transfer-requests",
            "mentions",
            "future-tasks",
            "calendar",
          ],
          campfireChannel: null,
          photoTasksChannel: null,
          canViewTeamActivity: false,
          canViewAnalytics: false,
          isAdmin: false,
          isManager: false,
          canMoveTasksFreely: false,
          canApproveTransfers: false,
          skills: ["Documentation", "General", "Meeting"], // Admin/support skills
          status: "available",
          canReceiveAutoAssignments: true,
        },
        // Default config for users not listed
      };

      const DEFAULT_USER_CONFIG = {
        visibleTabs: [
          "incoming",
          "my-tasks",
          "assigned-out",
          "pool",
          "team",
          "transfer-requests",
          "mentions",
          "future-tasks",
          "calendar",
        ],
        canViewTeamActivity: false,
        canViewAnalytics: false,
        canViewTransferMetrics: false, // Can view transfer accept/deny metrics
        canViewStatusMetrics: false, // Can view swamped/busy status trends
        canViewEscalations: false, // Can view escalation reports
        canViewTeamReports: false, // Can view individual team member reports
        canViewPerformanceMetrics: false, // Can view completion time & response time metrics
        canViewPoolAnalytics: false, // Can view pool performance metrics
        canViewSkillPriority: false, // Can view skill matching & priority compliance
        canViewTrends: false, // Can view overdue trends & assignment patterns
        canExportReports: false, // Can export reports to CSV/PDF
        isAdmin: false,
        isManager: false, // Manager role - can see team activity, approve transfers
        campfireChannel: null,
        photoTasksChannel: null,
        // Delete permissions
        canDeleteOwnTasks: true, // Everyone can delete their own tasks
        canDeletePoolTasks: false, // Only managers/leads can delete pool tasks
        canDeleteOthersTasks: false, // Only specific users can delete other's tasks
        canDeleteAllTasks: false, // Only super admins can delete anything
        // Trash & Completed visibility
        canViewAllTrash: false, // Only admins see everyone's deleted tasks
        canViewAllCompleted: false, // Only admins see everyone's completed tasks
        // Quick Launch (Bulk Import)
        canBulkImport: false, // Only certain users can access Quick Launch
        // Task transfer permissions
        canMoveTasksFreely: false, // Admins/Managers can move tasks without restrictions
        canApproveTransfers: false, // Admins/Managers can approve task transfers
        // Skills and status
        skills: ["General"], // User skills for task matching
        status: "available", // available, busy, swamped
        canReceiveAutoAssignments: true, // Can receive auto-assigned tasks based on skills
        // Alert timing configuration (in hours)
        alertTiming: {
          firstAlert: 24, // Alert user after 24 hours of inactivity
          managerEscalation: 48, // Escalate to manager after 48 hours
          poolRelease: 72, // Release to pool after 72 hours
        },
        // Admin-specific alert timing (longer grace periods)
        adminAlertTiming: {
          firstAlert: 48,
          managerEscalation: 96,
          poolRelease: 144,
        },
      };

      // Fetch user config from Discord bot API
      const fetchUserConfigFromBot = async () => {
        if (!BOT_CONFIG.enabled || !BOT_CONFIG.apiUrl) {
          return null;
        }

        try {
          const response = await fetch(`${BOT_CONFIG.apiUrl}/api/permissions`);
          if (response.ok) {
            const config = await response.json();
            // DISABLED: Don't let Dashboard overwrite permissions - Admin Panel only
            // localStorage.setItem('bottyotty-user-permissions', JSON.stringify(config));
            return config;
          }
        } catch (e) {
          console.error("Failed to fetch permissions from bot:", e);
        }
        return null;
      };

      // Save user config to Discord bot API
      const saveUserConfigToBot = async (config) => {
        if (!BOT_CONFIG.enabled || !BOT_CONFIG.apiUrl) {
          console.warn("Bot not enabled - use Admin Panel to save permissions");
          // DISABLED: Don't let Dashboard overwrite permissions - Admin Panel only
          // localStorage.setItem('bottyotty-user-permissions', JSON.stringify(config));
          return false;
        }

        try {
          const response = await fetch(`${BOT_CONFIG.apiUrl}/api/permissions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });

          if (response.ok) {
            // DISABLED: Don't let Dashboard overwrite permissions - Admin Panel only
            // localStorage.setItem('bottyotty-user-permissions', JSON.stringify(config));
            return true;
          } else {
            console.error(
              "Failed to save permissions to bot:",
              response.status,
            );
            return false;
          }
        } catch (e) {
          console.error("Failed to save permissions to bot:", e);
          return false;
        }
      };

      // Load user config from bot API, localStorage cache, or defaults
      const loadUserConfig = () => {
        try {
          // Load Admin Panel config first for global settings
          let adminConfig = null;
          let globalSkills = null;
          let globalInactivitySettings = null;
          let departments = null;
          let roles = null;

          try {
            const adminConfigStr = localStorage.getItem(
              "bottyotty-admin-config",
            );
            if (adminConfigStr) {
              adminConfig = JSON.parse(adminConfigStr);
              globalSkills = adminConfig.skills || null;
              globalInactivitySettings = adminConfig.inactivitySettings || null;
              departments = adminConfig.departments || null;
              roles = adminConfig.roles || null;
              console.log("üì• Loaded Admin Panel config:", {
                skills: globalSkills,
                inactivitySettings: globalInactivitySettings,
                departments,
                roles,
              });
            }
          } catch (e) {
            console.warn("Could not load Admin Panel config:", e);
          }

          // Try localStorage cache first for fast loading
          const saved = localStorage.getItem("bottyotty-user-permissions");
          if (saved) {
            const parsed = JSON.parse(saved);
            console.log(
              "üì• Loading user permissions from localStorage:",
              parsed,
            );

            // Merge with defaults to ensure new fields are present
            const merged = {};

            // Get ALL unique user names from both saved config AND defaults
            const allUserNames = new Set([
              ...Object.keys(parsed || {}),
              ...Object.keys(USER_CONFIG_DEFAULTS),
            ]);

            allUserNames.forEach((userName) => {
              const hardcodedConfig = USER_CONFIG_DEFAULTS[userName] || {};
              const savedConfig = parsed[userName] || {};

              // Smart merge: combine visibleTabs arrays (add new tabs from defaults)
              const defaultTabs = DEFAULT_USER_CONFIG.visibleTabs || [];
              const hardcodedTabs = hardcodedConfig.visibleTabs || [];
              const savedTabs = savedConfig.visibleTabs || [];
              const mergedTabs = [
                ...new Set([...defaultTabs, ...hardcodedTabs, ...savedTabs]),
              ]; // Unique tabs from all

              // CRITICAL: Start with DEFAULT_USER_CONFIG to ensure ALL fields are present
              merged[userName] = {
                ...DEFAULT_USER_CONFIG, // All fields with defaults
                ...hardcodedConfig, // Hardcoded overrides (if any)
                ...savedConfig, // Saved overrides
                visibleTabs: mergedTabs, // Merged tabs
              };

              // Apply Admin Panel global settings if available
              if (globalSkills && !savedConfig.skills) {
                // If user doesn't have skills set, use 'General' as default
                merged[userName].skills = ["General"];
              }

              if (globalInactivitySettings) {
                // Apply inactivity settings based on whether user is admin
                const isUserAdmin =
                  merged[userName].isAdmin || merged[userName].isManager;
                const timing = isUserAdmin
                  ? globalInactivitySettings.admin
                  : globalInactivitySettings.regularUser;
                merged[userName].alertTiming = timing;
                merged[userName].adminAlertTiming =
                  globalInactivitySettings.admin;
              }

              // Apply department and role if set in Admin Panel but not in user config
              if (
                adminConfig &&
                adminConfig.userConfigs &&
                adminConfig.userConfigs[userName]
              ) {
                const adminUserConfig = adminConfig.userConfigs[userName];
                if (adminUserConfig.department)
                  merged[userName].department = adminUserConfig.department;
                if (adminUserConfig.role)
                  merged[userName].role = adminUserConfig.role;
                if (adminUserConfig.skills)
                  merged[userName].skills = adminUserConfig.skills;
              }
            });

            console.log(
              "‚úÖ Merged user permissions with Admin Panel config:",
              merged,
            );
            return merged;
          }
        } catch (e) {
          console.error("Failed to load user permissions from cache:", e);
        }
        console.log("‚ö†Ô∏è No saved permissions found, using defaults");
        return USER_CONFIG_DEFAULTS;
      };

      // Save user config (for backward compatibility - use saveUserConfigToBot for new code)
      // DISABLED: Dashboard should NEVER write permissions, only Admin Panel
      const saveUserConfig = (config) => {
        console.warn(
          "‚ö†Ô∏è Dashboard tried to save permissions - this is disabled. Use Admin Panel instead.",
        );
        // try {
        //   localStorage.setItem('bottyotty-user-permissions', JSON.stringify(config));
        // } catch (e) {
        //   console.error('Failed to save user permissions:', e);
        // }
      };

      // Quick Assign Dropdown Component with Searchable Input
      function QuickAssignDropdown({
        task,
        assignees,
        onAssignToMe,
        onAssignToOther,
        onSendToPool,
        onClose,
      }) {
        const [searchTerm, setSearchTerm] = useState("");
        const [selectedPerson, setSelectedPerson] = useState(null);
        const [selectedPool, setSelectedPool] = useState("");
        const dropdownRef = useRef(null);

        // Filter team members based on search term
        const filteredMembers = TEAM_MEMBERS.filter((member) =>
          member.name.toLowerCase().includes(searchTerm.toLowerCase()),
        );

        // Close dropdown when clicking outside
        useEffect(() => {
          function handleClickOutside(event) {
            if (
              dropdownRef.current &&
              !dropdownRef.current.contains(event.target)
            ) {
              onClose();
            }
          }
          document.addEventListener("mousedown", handleClickOutside);
          return () =>
            document.removeEventListener("mousedown", handleClickOutside);
        }, [onClose]);

        const handleSelectPerson = (person) => {
          setSelectedPerson(person);
          setSearchTerm(person.name);
        };

        const handleAssign = () => {
          if (selectedPerson) {
            onAssignToOther(task, selectedPerson);
            onClose();
          }
        };

        return (
          <div
            ref={dropdownRef}
            className="w-72 glass-panel border border-gray-700 rounded-lg shadow-2xl"
          >
            <div className="p-3 border-b border-gray-700">
              <h4 className="text-white font-semibold text-sm">Quick Assign</h4>
              <p className="text-gray-300 text-xs mt-1">{task.name}</p>
            </div>

            <div className="p-2 space-y-1">
              {/* Assign to Me */}
              <button
                onClick={() => {
                  onAssignToMe(task);
                  onClose();
                }}
                className="w-full text-left px-3 py-2 hover:bg-purple-600 hover:bg-opacity-20 rounded text-white text-sm transition-colors flex items-center gap-2"
              >
                <span>üë§</span>
                <span>Assign to Me</span>
              </button>

              {/* Assign to Someone Else - Searchable */}
              <div className="px-3 py-2 space-y-2">
                <label className="text-gray-300 text-xs font-medium">
                  Assign to Someone Else
                </label>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => {
                    setSearchTerm(e.target.value);
                    setSelectedPerson(null);
                  }}
                  placeholder="Type to search..."
                  className="w-full px-3 py-2 glass-element text-white rounded text-sm border border-white border-opacity-30 focus:border-blue-500 focus:outline-none"
                />

                {/* Search Results */}
                {searchTerm && !selectedPerson && (
                  <div className="max-h-40 overflow-y-auto glass-panel rounded border border-white border-opacity-30">
                    {filteredMembers.length > 0 ? (
                      filteredMembers.map((member) => (
                        <button
                          key={member.discordId}
                          onClick={() => handleSelectPerson(member)}
                          className="w-full text-left px-3 py-2 hover:bg-blue-600 hover:bg-opacity-30 text-white text-sm transition-colors border-b border-gray-700 last:border-b-0"
                        >
                          {member.name}
                        </button>
                      ))
                    ) : (
                      <div className="px-3 py-2 text-gray-500 text-sm">
                        No matches found
                      </div>
                    )}
                  </div>
                )}

                {/* Assign Button */}
                {selectedPerson && (
                  <button
                    onClick={handleAssign}
                    className="w-full px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors"
                  >
                    Assign to {selectedPerson.name}
                  </button>
                )}
              </div>

              {/* Send to Pool */}
              <div className="px-3 py-2 space-y-2">
                <label className="text-gray-300 text-xs font-medium">
                  Send to Pool
                </label>
                <select
                  value={selectedPool}
                  onChange={(e) => setSelectedPool(e.target.value)}
                  className="w-full px-2 py-1.5 glass-element text-white rounded text-sm border border-white border-opacity-30 focus:border-cyan-500 focus:outline-none"
                >
                  <option value="">Select pool...</option>
                  {POOL_CHANNELS.map((pool) => (
                    <option key={pool.channelId} value={pool.channelId}>
                      {pool.name}
                    </option>
                  ))}
                </select>
                {selectedPool && (
                  <button
                    onClick={() => {
                      onSendToPool(task, selectedPool);
                      onClose();
                    }}
                    className="w-full px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded text-sm font-medium transition-colors"
                  >
                    üèä Send to{" "}
                    {
                      POOL_CHANNELS.find((p) => p.channelId === selectedPool)
                        ?.name
                    }
                  </button>
                )}
              </div>
            </div>

            <div className="p-2 border-t border-gray-700">
              <button
                onClick={onClose}
                className="w-full px-3 py-1.5 text-gray-300 hover:text-white text-sm transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        );
      }

      // Task Card Component (with Assign button for incoming)
      function TaskCard({
        task,
        onEdit,
        onDelete,
        onToggleStar,
        onComplete,
        onAssign,
        onAssignToOther,
        onSendToPool,
        onSave,
        onActivate,
        onUndo,
        showActions = true,
        draggable = true,
        isIncoming = false,
        isStaged = false,
        assignees = [],
        onCardClick,
        onWorkingOn,
        onAcceptTransfer,
        onDenyTransfer,
        onClaimPool,
        onOfferHelp,
        onAcceptHelp,
        onShowUpdates,
        currentUser,
      }) {
        const categoryColor = getCategoryColor(task.category);
        const [isDragging, setIsDragging] = useState(false);
        const [showAssignDropdown, setShowAssignDropdown] = useState(false);
        const [dropdownPosition, setDropdownPosition] = useState({
          top: 0,
          left: 0,
        });
        const assignButtonRef = useRef(null);
        const overdue = isOverdue(task);

        const handleDragStart = (e) => {
          setIsDragging(true);
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("taskId", task.id.toString());
        };

        const handleDragEnd = () => {
          setIsDragging(false);
        };

        const handleAssignClick = (e) => {
          e.stopPropagation();
          if (!showAssignDropdown && assignButtonRef.current) {
            const rect = assignButtonRef.current.getBoundingClientRect();
            setDropdownPosition({
              top: rect.top, // Position above button (transform will handle offset)
              left: rect.left,
            });
          }
          setShowAssignDropdown(!showAssignDropdown);
        };

        return (
          <>
            <div
              draggable={draggable && showActions}
              onDragStart={handleDragStart}
              onDragEnd={handleDragEnd}
              onClick={() => onCardClick && onCardClick(task)}
              className={`task-card glass-panel rounded-xl p-6 priority-${task.priority} ${isDragging ? "dragging" : ""} ${task.isNew && isIncoming ? "border-2 border-yellow-400 bg-yellow-900 bg-opacity-20" : ""} ${isStaged ? "border-2 border-amber-500 bg-amber-900 bg-opacity-20" : ""} ${onCardClick ? "cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" : ""} ${showAssignDropdown ? "overflow-visible" : ""}`}
            >
              <div className="flex items-start justify-between mb-3">
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-3 mb-2 flex-wrap">
                    {task.isNew && isIncoming && (
                      <span className="text-xs bg-blue-500 text-white px-2 py-1 rounded font-bold">
                        NEW
                      </span>
                    )}
                    {task.isImported && (
                      <span className="text-xs bg-cyan-500 text-white px-2 py-1 rounded font-bold">
                        IMPORTED
                      </span>
                    )}
                    {isStaged && (
                      <span className="text-xs bg-amber-500 text-white px-2 py-1 rounded font-bold animate-pulse">
                        STAGED
                      </span>
                    )}
                    <h3 className="text-xl font-semibold text-white break-words w-full">
                      {task.name}
                    </h3>
                    {task.discordTaskNumber && (
                      <span className="text-xs bg-purple-600 text-white px-2 py-1 rounded-full">
                        #{task.discordTaskNumber}
                      </span>
                    )}
                    {overdue && <span className="overdue-badge">OVERDUE</span>}
                  </div>
                  <div className="flex flex-wrap gap-2 mb-3">
                    <span
                      className="category-badge"
                      style={{
                        backgroundColor: categoryColor.bg,
                        color: categoryColor.text,
                        border: `1px solid ${categoryColor.border}`,
                      }}
                    >
                      {task.category}
                    </span>
                    <span
                      className={`text-xs px-3 py-1 rounded-full font-medium ${
                        task.priority === "urgent"
                          ? "bg-red-600 text-white"
                          : task.priority === "high"
                            ? "bg-orange-600 text-white"
                            : task.priority === "medium"
                              ? "bg-blue-600 text-white"
                              : "bg-green-600 text-white"
                      }`}
                    >
                      {task.priority.toUpperCase()}
                    </span>
                  </div>
                  <div className="flex flex-wrap gap-3 text-sm text-gray-300">
                    {task.requestedBy && (
                      <span className="text-cyan-400">
                        üìã Requested by: {task.requestedBy}
                      </span>
                    )}
                    {task.assignee && <span>üë§ {task.assignee}</span>}
                    {task.claimedBy && (
                      <span className="text-yellow-400">
                        ‚úã Claimed by: {task.claimedBy}
                      </span>
                    )}
                    {task.completedBy && (
                      <span className="text-green-400">
                        ‚úÖ Completed by: {task.completedBy}
                      </span>
                    )}
                    {task.workingOnBy && (
                      <span className="text-purple-400 font-bold">
                        üöÄ {task.workingOnBy} is working on this
                      </span>
                    )}
                    {task.transferFrom && task.transferTo && (
                      <span className="text-yellow-400">
                        üîÑ Transfer: {task.transferFrom} ‚Üí {task.transferTo}
                      </span>
                    )}
                    {task.skillMatch === false && (
                      <span className="text-red-400 font-bold">
                        ‚ö†Ô∏è Skill mismatch!
                      </span>
                    )}
                    {task.assignedDespiteStatus && (
                      <span className="text-orange-400">
                        ‚ö†Ô∏è Assignee is {task.assignedDespiteStatus}
                      </span>
                    )}
                    {task.needsHelp && (
                      <span className="text-yellow-400 font-bold animate-pulse">
                        ü§ù HELP NEEDED
                      </span>
                    )}
                    {task.skillMatchedUsers && (
                      <span className="text-green-400">
                        ‚úÖ {task.skillMatchedUsers.length} users with matching
                        skills
                      </span>
                    )}
                    {task.endDate && <span>üìÖ {formatDate(task.endDate)}</span>}
                    {task.campfireFrom && (
                      <span>üî• From: {task.campfireFrom}</span>
                    )}
                  </div>
                </div>
                {showActions && (
                  <div className="flex gap-1">
                    {onWorkingOn && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onWorkingOn(task.id);
                        }}
                        className={`text-xl hover:scale-110 transition-transform ${task.workingOnBy ? "opacity-100 animate-pulse" : "opacity-50"}`}
                        title={
                          task.workingOnBy
                            ? `${task.workingOnBy} is working on this`
                            : "Mark as working on"
                        }
                      >
                        üöÄ
                      </button>
                    )}
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onEdit(task);
                      }}
                      className="text-lg hover:scale-110 transition-transform"
                      title="Edit"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onToggleStar(task.id);
                      }}
                      className="text-xl hover:scale-110 transition-transform"
                      title="Star"
                    >
                      {task.starred ? "‚≠ê" : "‚òÜ"}
                    </button>
                  </div>
                )}
              </div>

              {task.link && (
                <a
                  href={task.link}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-400 hover:text-blue-300 text-sm mb-3 inline-block hover:underline"
                  onClick={(e) => e.stopPropagation()}
                >
                  üîó Link
                </a>
              )}

              {task.notes && (
                <p className="text-gray-200 text-sm mb-4 glass-panel p-3 rounded-lg">
                  {task.notes}
                </p>
              )}

              {task.latestUpdate && (
                <div className="mb-4 glass-panel p-3 rounded-lg border-l-4 border-purple-500">
                  <div className="flex items-start justify-between gap-2 mb-1">
                    <span className="text-xs font-semibold text-purple-400">
                      üìù Latest Update
                    </span>
                    <span className="text-xs text-gray-500">
                      {new Date(task.latestUpdate.updated_at).toLocaleString()}
                    </span>
                  </div>
                  <p className="text-gray-200 text-sm mb-1">
                    {task.latestUpdate.update_text}
                  </p>
                  <span className="text-xs text-gray-400">
                    - {task.latestUpdate.updated_by}
                  </span>
                </div>
              )}

              {showActions && (
                <div className="flex gap-2 mt-4 flex-wrap">
                  {onAssign && (
                    <div className="flex-1">
                      <button
                        ref={assignButtonRef}
                        onClick={handleAssignClick}
                        className="w-full px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                      >
                        üë§ Assign
                      </button>
                    </div>
                  )}
                  {task.status === "saved" &&
                    onUndo &&
                    task.savedFromStatus && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onUndo(task.id);
                        }}
                        className="flex-1 px-3 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                      >
                        ‚Ü©Ô∏è Undo
                      </button>
                    )}
                  {task.status === "saved" && onActivate && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onActivate(task.id);
                      }}
                      className="flex-1 px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                    >
                      üîÑ Activate
                    </button>
                  )}
                  {task.status !== "completed" &&
                    task.status !== "saved" &&
                    onComplete && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onComplete(task.id);
                        }}
                        className="px-3 py-2 bg-green-600 hover:bg-green-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                      >
                        ‚úÖ
                      </button>
                    )}
                  {task.discordTaskNumber && onShowUpdates && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onShowUpdates(task);
                      }}
                      className="px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                      title="Add status update"
                    >
                      üìù Update
                    </button>
                  )}
                  {task.status === "active" && onSave && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onSave(task.id);
                      }}
                      className="flex-1 px-3 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                    >
                      üíæ Save
                    </button>
                  )}
                  {task.isTransferRequest &&
                    task.transferTo === currentUser?.name &&
                    onAcceptTransfer && (
                      <>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onAcceptTransfer(task);
                          }}
                          className="flex-1 px-3 py-2 bg-green-600 hover:bg-green-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                        >
                          ‚úÖ Accept
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onDenyTransfer(task);
                          }}
                          className="flex-1 px-3 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                        >
                          ‚ùå Deny
                        </button>
                      </>
                    )}
                  {task.isPoolRequest && onClaimPool && !task.workingOnBy && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        onClaimPool(task);
                      }}
                      className="flex-1 px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                    >
                      ‚úã Claim Task
                    </button>
                  )}
                  {task.isPoolRequest &&
                    task.workingOnBy &&
                    task.workingOnBy !== currentUser?.name && (
                      <div className="flex-1 px-3 py-2 bg-gray-600 text-white rounded-md text-sm font-medium text-center">
                        ‚è≥ {task.workingOnBy} claimed
                      </div>
                    )}
                  {/* Offer Help / Accept Help buttons */}
                  {onOfferHelp &&
                    !task.needsHelp &&
                    task.assignedTo === currentUser?.name && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onOfferHelp(task);
                        }}
                        className="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                      >
                        ü§ù Offer Help
                      </button>
                    )}
                  {onAcceptHelp &&
                    task.needsHelp &&
                    task.assignedTo !== currentUser?.name && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onAcceptHelp(task);
                        }}
                        className="flex-1 px-3 py-2 bg-green-600 hover:bg-green-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm animate-pulse"
                      >
                        ü§ù Help Out
                      </button>
                    )}
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      onDelete(task.id);
                    }}
                    className="px-3 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md text-sm font-medium transition-colors shadow-sm"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              )}
            </div>

            {/* Assign Dropdown Portal - Fixed positioning outside card container */}
            {showAssignDropdown && onAssign && (
              <div
                className="fixed z-[9999]"
                style={{
                  top: `${dropdownPosition.top}px`,
                  left: `${dropdownPosition.left}px`,
                  transform: "translateY(-100%)",
                }}
              >
                <QuickAssignDropdown
                  task={task}
                  assignees={assignees}
                  onAssignToMe={onAssign}
                  onAssignToOther={onAssignToOther}
                  onSendToPool={(task) => alert("Pool feature coming soon!")}
                  onClose={() => setShowAssignDropdown(false)}
                />
              </div>
            )}
          </>
        );
      }

      // Calendar View Component (with task count and click to view)
      function CalendarView({ tasks, onDateClick }) {
        const [currentDate, setCurrentDate] = useState(new Date());

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = dateKeyFromLocal(new Date());

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const monthName = currentDate.toLocaleDateString("en-US", {
          month: "long",
          year: "numeric",
        });

        const getTasksForDate = (dateStr) => {
          return tasks.filter((t) => {
            if (t.status === "completed") return false;
            if (!t.endDate) return false;
            return t.endDate === dateStr;
          });
        };

        const prevMonth = () => {
          setCurrentDate(new Date(year, month - 1));
        };

        const nextMonth = () => {
          setCurrentDate(new Date(year, month + 1));
        };

        const renderCalendarDays = () => {
          const days = [];
          const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

          // Day headers
          dayNames.forEach((day) => {
            days.push(
              <div
                key={`header-${day}`}
                className="text-center font-bold text-white py-3 text-lg"
              >
                {day}
              </div>,
            );
          });

          // Empty cells
          for (let i = 0; i < firstDayOfMonth; i++) {
            days.push(
              <div
                key={`empty-${i}`}
                className="calendar-day"
                style={{ opacity: 0.3 }}
              />,
            );
          }

          // Actual days
          for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = dateKeyFromLocal(new Date(year, month, day));
            const isToday = dateStr === today;
            const dayTasks = getTasksForDate(dateStr);

            days.push(
              <div
                key={day}
                onClick={() => onDateClick && onDateClick(dateStr)}
                className={`calendar-day ${isToday ? "today" : ""}`}
              >
                <div className="calendar-day-number">{day}</div>
                {dayTasks.length > 0 && (
                  <div className="task-count-badge">{dayTasks.length}</div>
                )}
                <div className="flex flex-wrap gap-1 justify-center mt-2">
                  {dayTasks.slice(0, 4).map((t) => {
                    const color = getCategoryColor(t.category);
                    const isRecurring = t.isRecurring || false;
                    return (
                      <div
                        key={t.id}
                        className={`task-dot ${isRecurring ? "ring-2 ring-yellow-400 ring-offset-1" : ""}`}
                        style={{
                          backgroundColor: color.border,
                          ...(isRecurring
                            ? {
                                boxShadow: "0 0 8px rgba(251, 191, 36, 0.6)",
                                transform: "scale(1.2)",
                              }
                            : {}),
                        }}
                        title={`${t.name}${isRecurring ? " (Recurring)" : ""}`}
                      />
                    );
                  })}
                </div>
              </div>,
            );
          }

          return days;
        };

        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-3xl font-bold text-white">üìÖ {monthName}</h2>
              <div className="flex gap-2">
                <button
                  onClick={prevMonth}
                  className="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all"
                >
                  ‚Üê Prev
                </button>
                <button
                  onClick={() => setCurrentDate(new Date())}
                  className="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all"
                >
                  Today
                </button>
                <button
                  onClick={nextMonth}
                  className="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all"
                >
                  Next ‚Üí
                </button>
              </div>
            </div>

            <div className="glass rounded-2xl p-6">
              <div className="calendar-grid">{renderCalendarDays()}</div>
            </div>

            {/* Category Legend */}
            <div className="glass rounded-xl p-6">
              <h3 className="text-white font-bold mb-4 text-lg">
                üìä Category Legend
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {Object.entries(CATEGORY_COLORS).map(([name, color]) => (
                  <div key={name} className="flex items-center gap-2">
                    <div
                      className="w-4 h-4 rounded-full"
                      style={{ backgroundColor: color.border }}
                    />
                    <span className="text-white text-sm">{name}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // Main App Component
      function TaskManager() {
        // Load tasks from localStorage on mount
        const [tasks, setTasks] = useState(() => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
          } catch (e) {
            console.error("Failed to load tasks:", e);
            return [];
          }
        });

        // Sidebar state - default to collapsed
        const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {
          const saved = localStorage.getItem('bottyotty-sidebar-collapsed');
          return saved !== null ? saved === 'true' : true; // Default to true (collapsed)
        });

        const [activeView, setActiveView] = useState("incoming");
        const [editingTask, setEditingTask] = useState(null);
        const [showAddTask, setShowAddTask] = useState(false);
        const [notification, setNotification] = useState(null);
        const [mentions, setMentions] = useState([]);
        const [trashedTasks, setTrashedTasks] = useState([]);
        const [showTrash, setShowTrash] = useState(false);
        const [showHelp, setShowHelp] = useState(false);
        const [assignees, setAssignees] = useState([]);
        const [categories, setCategories] = useState([]);
        const [searchTerm, setSearchTerm] = useState("");
        const [filterCategory, setFilterCategory] = useState("all");
        const [filterPriority, setFilterPriority] = useState("all");
        const [filterUser, setFilterUser] = useState("all");
        const [showBackupReminder, setShowBackupReminder] = useState(false);
        const [selectedCalendarDay, setSelectedCalendarDay] = useState(null);
        const [selectedDate, setSelectedDate] = useState(
          dateKeyFromLocal(new Date()),
        );
        const [showMonthOverview, setShowMonthOverview] = useState(false);
        const [openUpcomingDate, setOpenUpcomingDate] = useState(null);
        const [calendarMonth, setCalendarMonth] = useState(new Date());
        const [overdueExpanded, setOverdueExpanded] = useState(true);
        const [scheduledExpanded, setScheduledExpanded] = useState(true);
        const [scheduledTasksExpanded, setScheduledTasksExpanded] =
          useState(true);
        const [workingOnExpanded, setWorkingOnExpanded] = useState(false);
        const [myTasksExpanded, setMyTasksExpanded] = useState(true);
        const [savedExpanded, setSavedExpanded] = useState(false);
        const [thisWeekExpanded, setThisWeekExpanded] = useState(true);
        const [upcomingExpanded, setUpcomingExpanded] = useState(false);
        const [assignedOutExpanded, setAssignedOutExpanded] = useState({});
        const [filterDateStart, setFilterDateStart] = useState("");
        const [filterDateEnd, setFilterDateEnd] = useState("");
        const [quickFilter, setQuickFilter] = useState("all");
        const [recurringFilter, setRecurringFilter] = useState("none");
        const [recurringListExpanded, setRecurringListExpanded] =
          useState(true);
        const [forecastFilter, setForecastFilter] = useState("this-week");
        const [openAccordions, setOpenAccordions] = useState(new Set());
        const [showStarredForecast, setShowStarredForecast] = useState(false);
        const [stagingMode, setStagingMode] = useState(false);
        const [stagedTasks, setStagedTasks] = useState(new Set());
        const [expandedTask, setExpandedTask] = useState(null);
        const [completedExpanded, setCompletedExpanded] = useState({
          myTasks: true,
          incoming: false,
          assignedOut: false,
          pool: false,
          team: false,
          campfire: false,
        });
        const [showTeamActivity, setShowTeamActivity] = useState(false);
        const [assignedByFilter, setAssignedByFilter] = useState("all"); // 'all', 'me', 'others'
        const [toastMessage, setToastMessage] = useState(null);
        const [isRefreshing, setIsRefreshing] = useState(false);
        const [trainings, setTrainings] = useState([]);
        const [importantMessages, setImportantMessages] = useState([]);
        const [taskUpdates, setTaskUpdates] = useState({});
        const [showUpdateModal, setShowUpdateModal] = useState(false);
        const [updatingTask, setUpdatingTask] = useState(null);
        const fileInputRef = useRef(null);
        const searchTimeoutRef = useRef(null);

        // Current logged-in user
        const [currentUser, setCurrentUser] = useState(() => {
          const savedUser = localStorage.getItem("bottyotty-current-user");
          return savedUser ? JSON.parse(savedUser) : null;
        });
        const [showLoginModal, setShowLoginModal] = useState(!currentUser);

        // User configuration (loaded from localStorage or defaults)
        const [USER_CONFIG, setUSER_CONFIG] = useState(() => loadUserConfig());

        // Track if dashboard grid layout is active
        const [isGridLayout, setIsGridLayout] = useState(false);

        // Watch for layout changes
        useEffect(() => {
          const observer = new MutationObserver(() => {
            setIsGridLayout(document.body.classList.contains('layout-dashboard-grid'));
          });

          observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['class']
          });

          // Initial check
          setIsGridLayout(document.body.classList.contains('layout-dashboard-grid'));

          return () => observer.disconnect();
        }, []);

        // Sidebar toggle effect
        useEffect(() => {
          const sidebar = document.getElementById('sidebarNav');
          const icon = document.getElementById('sidebarToggleIcon');
          const text = document.getElementById('sidebarToggleText');

          if (sidebarCollapsed) {
            document.body.classList.add('sidebar-collapsed');
            if (sidebar) sidebar.classList.add('collapsed');
            if (icon) icon.textContent = '‚Üí';
            if (text) text.textContent = 'Expand';
          } else {
            document.body.classList.remove('sidebar-collapsed');
            if (sidebar) sidebar.classList.remove('collapsed');
            if (icon) icon.textContent = '‚Üê';
            if (text) text.textContent = 'Collapse';
          }
          localStorage.setItem('bottyotty-sidebar-collapsed', sidebarCollapsed);
        }, [sidebarCollapsed]);

        // Sidebar toggle function - make it globally accessible
        useEffect(() => {
          window.toggleSidebar = () => {
            setSidebarCollapsed(prev => !prev);
          };
        }, []);

        // Log when USER_CONFIG or currentUser changes (to debug button visibility)
        useEffect(() => {
          if (currentUser) {
            const myPerms = USER_CONFIG[currentUser.name];
            console.log("üîê Permission Check:", {
              user: currentUser.name,
              permissions: myPerms,
              isAdmin: myPerms?.isAdmin,
              canBulkImport: myPerms?.canBulkImport,
              willShowAdminButton: !!(currentUser && myPerms?.isAdmin),
              willShowQuickLaunchButton: !!(
                currentUser && myPerms?.canBulkImport
              ),
            });
          }
        }, [USER_CONFIG, currentUser]);

        // Reload USER_CONFIG when window regains focus (e.g., returning from Admin Panel)
        useEffect(() => {
          const handleFocus = () => {
            const reloaded = loadUserConfig();
            setUSER_CONFIG(reloaded);
            console.log("üîÑ Reloaded user permissions from localStorage");
            if (currentUser) {
              const myPerms = reloaded[currentUser.name];
              console.log(
                `   Your permissions (${currentUser.name}):`,
                myPerms,
              );
              console.log(`   - isAdmin: ${myPerms?.isAdmin}`);
              console.log(`   - canBulkImport: ${myPerms?.canBulkImport}`);
            }
          };

          window.addEventListener("focus", handleFocus);
          return () => window.removeEventListener("focus", handleFocus);
        }, [currentUser]);

        // FIXED: Backup reminder - only shows once per session after 7 days
        useEffect(() => {
          // Check if already shown this session
          if (sessionStorage.getItem(SESSION_REMINDER_KEY)) {
            return;
          }

          const lastBackup = localStorage.getItem(BACKUP_AT_KEY);
          const weekMs = 7 * 24 * 60 * 60 * 1000;

          if (!lastBackup || Date.now() - Number(lastBackup) > weekMs) {
            if (tasks.length > 0) {
              setShowBackupReminder(true);
              sessionStorage.setItem(SESSION_REMINDER_KEY, "true");
            }
          }
        }, [tasks]);

        // Apply admin config to body background (runs after component mounts)
        useEffect(() => {
          const config = loadAdminConfig();
          if (config) {
            // Handle both nested format (config.appearance) AND flat format (config.darkMode) - backwards compatible!
            const appearance = config.appearance || config;
            const { darkMode, gradientStart, gradientEnd } = appearance;

            if (darkMode) {
              document.body.style.background =
                "linear-gradient(135deg, #1f2937 0%, #111827 100%)";
              console.log("‚úÖ Dark mode applied from admin config");
            } else if (gradientStart && gradientEnd) {
              document.body.style.background = `linear-gradient(135deg, ${gradientStart} 0%, ${gradientEnd} 100%)`;
              console.log(
                "‚úÖ Custom gradient applied:",
                gradientStart,
                gradientEnd,
              );
            }
          }
        }, []); // Run once on mount

        // Save to localStorage as backup
        useEffect(() => {
          if (tasks.length > 0) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
          }
        }, [tasks]);

        // Fetch trainings from API
        useEffect(() => {
          fetch("http://localhost:5000/api/trainings")
            .then((res) => res.json())
            .then((data) => setTrainings(data.trainings || []))
            .catch((err) => console.error("Error fetching trainings:", err));
        }, []);

        // Fetch important messages from API
        useEffect(() => {
          fetch("http://localhost:5000/api/important-messages")
            .then((res) => res.json())
            .then((data) => setImportantMessages(data.messages || []))
            .catch((err) =>
              console.error("Error fetching important messages:", err),
            );
        }, []);

        // Export JSON
        const exportTasks = () => {
          try {
            const data = JSON.stringify(tasks, null, 2);
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            const dateStr = dateKeyFromLocal(new Date()).replace(/-/g, "");
            a.href = url;
            a.download = `bottyotty-backup-${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            localStorage.setItem(BACKUP_AT_KEY, String(Date.now()));
            setShowBackupReminder(false);
            showNotification("Tasks exported successfully!", "success");
          } catch (error) {
            showNotification("Export failed!", "error");
          }
        };

        // Import JSON
        const importTasks = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              if (!Array.isArray(imported)) {
                throw new Error("Invalid format");
              }

              // Merge with existing tasks instead of replacing
              setTasks((prevTasks) => {
                const existingIds = new Set(prevTasks.map((t) => t.id));

                // Tag imported tasks and avoid duplicates
                const newTasks = imported
                  .filter((task) => !existingIds.has(task.id))
                  .map((task) => ({
                    ...task,
                    isImported: true, // Temporary tag for imported tasks
                    importedAt: new Date().toISOString(),
                  }));

                showNotification(
                  `Merged ${newTasks.length} new tasks! (${imported.length - newTasks.length} duplicates skipped)`,
                  "success",
                );
                return [...prevTasks, ...newTasks];
              });
            } catch (error) {
              showNotification("Import failed! Invalid JSON.", "error");
            }
            event.target.value = "";
          };
          reader.readAsText(file);
        };

        // Sync with bot - FIXED: Merges instead of replacing, syncs trash too
        const syncWithBot = async () => {
          if (!BOT_CONFIG.enabled || !BOT_CONFIG.apiUrl) return;

          try {
            const [tasksRes, trashRes, assigneesRes, categoriesRes] =
              await Promise.all([
                fetch(`${BOT_CONFIG.apiUrl}/api/tasks`),
                fetch(`${BOT_CONFIG.apiUrl}/api/trash`),
                fetch(`${BOT_CONFIG.apiUrl}/api/assignees`),
                fetch(`${BOT_CONFIG.apiUrl}/api/categories`),
              ]);

            const botTasks = await tasksRes.json();
            const botTrash = await trashRes.json();
            const botAssignees = await assigneesRes.json();
            const botCategories = await categoriesRes.json();

            console.log("üîÑ Sync - Bot returned", botTasks.length, "tasks");
            console.log("üì¶ Bot tasks:", botTasks);

            // Check if data actually changed
            const newHash = JSON.stringify({
              tasks: botTasks,
              trash: botTrash,
            });
            const oldHash = localStorage.getItem(LAST_SYNC_HASH_KEY);

            // MERGE bot tasks with local tasks instead of replacing
            setTasks((prevTasks) => {
              console.log("üìä Current local tasks:", prevTasks.length);
              console.log("üìÇ Local tasks:", prevTasks);

              // Create map of existing tasks by ID
              const localMap = new Map(prevTasks.map((t) => [t.id, t]));

              // Merge: Keep LOCAL user changes, only update Discord-specific fields
              const merged = botTasks.map((botTask) => {
                const localTask = localMap.get(botTask.id);
                if (localTask) {
                  console.log(
                    "üîÑ Updating existing task:",
                    botTask.id,
                    botTask.name,
                    "(keeping isNew:",
                    localTask.isNew,
                    ")",
                  );
                  // PRESERVE user's local changes (assigned, moved out of incoming, etc)
                  // ONLY update fields that come from Discord bot
                  return {
                    ...localTask, // Keep ALL local changes first
                    // Only update these specific Discord fields:
                    name: botTask.name,
                    notes: botTask.notes,
                    link: botTask.link,
                    discordTaskNumber: botTask.discordTaskNumber,
                    createdAt: botTask.createdAt,
                    // Update status from Discord (when completed)
                    status: botTask.status,
                    // ONLY update these if status changed (e.g., completed on Discord)
                    // Don't overwrite local user actions like claim/assign
                    ...(botTask.status === "completed" && {
                      isIncoming: botTask.isIncoming,
                      isAssignedOut: botTask.isAssignedOut,
                      isTeamRequest: botTask.isTeamRequest,
                    }),
                    // Update assignee info from Discord
                    assignedTo: botTask.assignedTo || localTask.assignedTo,
                    claimedBy: botTask.claimedBy || localTask.claimedBy,
                    claimedById: botTask.claimedById || localTask.claimedById,
                    completedBy: botTask.completedBy || localTask.completedBy,
                    // Keep local isNew flag
                  };
                }
                // NEW task from bot - mark incoming as unread (not campfire)
                const isNew = botTask.isIncoming && !botTask.isCampfire;
                console.log(
                  "‚ú® NEW TASK from bot:",
                  botTask.id,
                  botTask.name,
                  "| isIncoming:",
                  botTask.isIncoming,
                  "| isCampfire:",
                  botTask.isCampfire,
                  "| isNew:",
                  isNew,
                );
                return { ...botTask, isNew };
              });

              // Add any local-only tasks that aren't in bot response
              prevTasks.forEach((localTask) => {
                if (!botTasks.find((bt) => bt.id === localTask.id)) {
                  console.log(
                    "üìå Keeping local-only task:",
                    localTask.id,
                    localTask.name,
                  );
                  merged.push(localTask);
                }
              });

              console.log("‚úÖ After merge:", merged.length, "tasks");

              // Debug: Show incoming tasks with isNew status
              const incomingTasks = merged.filter(
                (t) => t.isIncoming && !t.isCampfire && t.status === "active",
              );
              const unreadIncoming = incomingTasks.filter((t) => t.isNew);
              console.log(
                "üì• Incoming tasks:",
                incomingTasks.length,
                "| Unread:",
                unreadIncoming.length,
              );
              console.log(
                "üìã Unread incoming tasks:",
                unreadIncoming.map((t) => ({
                  id: t.id,
                  name: t.name,
                  isNew: t.isNew,
                })),
              );

              return merged;
            });

            // MERGE bot trash with local trash
            setTrashedTasks((prevTrash) => {
              const localTrashMap = new Map(prevTrash.map((t) => [t.id, t]));

              // Bot trash takes priority
              const mergedTrash = botTrash.map((botTrashTask) => {
                const localTrashTask = localTrashMap.get(botTrashTask.id);
                if (localTrashTask) {
                  return { ...localTrashTask, ...botTrashTask };
                }
                return botTrashTask;
              });

              // Add local-only trash
              prevTrash.forEach((localTrashTask) => {
                if (!botTrash.find((bt) => bt.id === localTrashTask.id)) {
                  mergedTrash.push(localTrashTask);
                }
              });

              return mergedTrash;
            });

            setAssignees(botAssignees);
            setCategories(botCategories);

            // Silent sync - badges show new items, no need for toast notification
            // Only notify if data changed AND it's not the first sync
            // if (newHash !== oldHash && oldHash) {
            //   showNotification('New updates from Discord!', 'info');
            // }

            localStorage.setItem(LAST_SYNC_HASH_KEY, newHash);
          } catch (error) {
            console.error("Sync failed:", error);
          }
        };

        useEffect(() => {
          syncWithBot();
          if (BOT_CONFIG.autoSync) {
            const interval = setInterval(syncWithBot, BOT_CONFIG.syncInterval);
            return () => clearInterval(interval);
          }
        }, []);

        // Sync user permissions from bot on mount and periodically
        // DISABLED: Bot sync was overwriting localStorage permissions with empty data
        // Permissions are now managed via Admin Panel and localStorage only
        /*
      useEffect(() => {
        const syncPermissions = async () => {
          const config = await fetchUserConfigFromBot();
          if (config) {
            console.log('üîê Synced permissions from bot');
            setUSER_CONFIG(config);
          }
        };

        // Initial fetch
        syncPermissions();

        // Periodic refresh (every 60 seconds - less frequent than task sync)
        if (BOT_CONFIG.autoSync) {
          const interval = setInterval(syncPermissions, 60000);
          return () => clearInterval(interval);
        }
      }, []);
      */

        // Fetch mentions from bot
        const fetchMentions = async () => {
          if (!BOT_CONFIG.enabled || !BOT_CONFIG.apiUrl || !currentUser) return;

          try {
            const userId = PERSONAL_CHANNELS[currentUser.name];
            if (!userId) return;

            const response = await fetch(
              `${BOT_CONFIG.apiUrl}/api/mentions/${userId}`,
            );
            if (response.ok) {
              const mentionsData = await response.json();
              setMentions(mentionsData);
              console.log("üí¨ Fetched", mentionsData.length, "mentions");
            }
          } catch (e) {
            console.error("Failed to fetch mentions:", e);
          }
        };

        // Sync mentions from bot on mount and periodically
        useEffect(() => {
          if (!currentUser) return;

          fetchMentions();

          // Periodic refresh (every 30 seconds)
          if (BOT_CONFIG.autoSync) {
            const interval = setInterval(fetchMentions, 30000);
            return () => clearInterval(interval);
          }
        }, [currentUser]);

        // Mark mention as read
        const markMentionAsRead = async (mentionId) => {
          if (!BOT_CONFIG.enabled || !BOT_CONFIG.apiUrl) return;

          try {
            await fetch(`${BOT_CONFIG.apiUrl}/api/mentions/${mentionId}/read`, {
              method: "POST",
            });
            // Update local state
            setMentions((prev) =>
              prev.map((m) => (m.id === mentionId ? { ...m, is_read: 1 } : m)),
            );
          } catch (e) {
            console.error("Failed to mark mention as read:", e);
          }
        };

        const showNotification = (message, type = "info") => {
          setNotification({ message, type });
        };

        const showToast = (message, showRefresh = true) => {
          setToastMessage(message);

          // Show subtle refresh animation if requested
          if (showRefresh) {
            setIsRefreshing(true);
            setTimeout(() => {
              setIsRefreshing(false);
            }, 400); // Match the fade animation duration
          }

          // Auto-hide toast after 3 seconds
          setTimeout(() => {
            setToastMessage(null);
          }, 3000);
        };

        // Generate recurring task instances for the next year
        const generateRecurringInstances = (baseTask) => {
          if (!baseTask.recurringFrequency || !baseTask.endDate)
            return [baseTask];

          const instances = [];
          const seriesId = `series-${Date.now()}`;
          const startDate = new Date(baseTask.endDate);
          const endDate = new Date(startDate);
          endDate.setFullYear(endDate.getFullYear() + 1); // Generate for 1 year

          let currentDate = new Date(startDate);
          let instanceNumber = 1;
          const maxInstances = 365; // Safety limit

          while (currentDate <= endDate && instanceNumber <= maxInstances) {
            const instance = {
              ...baseTask,
              id: Date.now() + instanceNumber,
              endDate: dateKeyFromLocal(currentDate),
              startDate: dateKeyFromLocal(currentDate),
              seriesId,
              instanceNumber,
              isRecurringInstance: true,
              createdAt: new Date().toISOString(),
            };
            instances.push(instance);

            // Calculate next occurrence
            switch (baseTask.recurringFrequency) {
              case "daily":
                currentDate.setDate(currentDate.getDate() + 1);
                break;
              case "weekly":
                currentDate.setDate(currentDate.getDate() + 7);
                break;
              case "monthly":
                currentDate.setMonth(currentDate.getMonth() + 1);
                break;
              case "yearly":
                currentDate.setFullYear(currentDate.getFullYear() + 1);
                break;
              default:
                return [baseTask]; // Unknown frequency
            }
            instanceNumber++;
          }

          // Mark total instances on each
          return instances.map((inst) => ({
            ...inst,
            totalInstances: instances.length,
          }));
        };

        // Task actions
        const handleAddTask = (newTaskData) => {
          const currentUserName = currentUser?.name || "Unknown";
          const destination = newTaskData.destination || "my-tasks";

          // Determine task flags based on destination and assignee
          const isAssigningToOther =
            newTaskData.assignee &&
            newTaskData.assignee !== "Me" &&
            newTaskData.assignee !== currentUserName;

          const baseTask = {
            id: Date.now(),
            ...newTaskData,
            status: "active",
            assignedBy: currentUserName, // Track who created/assigned the task
            assignedTo: isAssigningToOther
              ? newTaskData.assignee
              : newTaskData.assignee === "Me"
                ? currentUserName
                : "",
            isIncoming: destination === "incoming",
            isAssignedOut: destination === "assigned-out" || isAssigningToOther,
            isTeamRequest: destination === "team",
            isPoolRequest: destination === "pool",
            isCampfire: destination === "campfire",
            starred: false,
            createdAt: new Date().toISOString(),
            lastTouchedAt: new Date().toISOString(), // Track for inactivity alerts
            lastTouchedBy: currentUserName,
            workingOnBy: "", // Initialize working indicator
            isTransferRequest: false, // Initialize transfer flag
          };

          console.log("üìù Creating task:", baseTask);
          console.log(
            "üë§ Created by:",
            currentUserName,
            "| Assigned to:",
            baseTask.assignedTo,
          );

          // Generate recurring instances if it's a recurring task (check isRecurring flag)
          if (
            baseTask.isRecurring &&
            baseTask.recurringFrequency &&
            baseTask.endDate
          ) {
            const instances = generateRecurringInstances(baseTask);
            setTasks((prev) => [...instances, ...prev]);
            showNotification(
              `Recurring task series created! (${instances.length} instances)`,
              "success",
            );
            console.log(
              "‚úÖ Recurring task series created:",
              instances.length,
              "instances",
            );
          } else {
            setTasks((prev) => {
              const newTasks = [baseTask, ...prev];
              console.log("‚úÖ Task created! New task count:", newTasks.length);
              return newTasks;
            });

            if (isAssigningToOther) {
              showNotification(
                `Task created and assigned to ${newTaskData.assignee}!`,
                "success",
              );
            } else {
              showNotification("Task created!", "success");
            }
          }
        };

        const handleEditTask = (task) => {
          // Mark as read when opening
          if (task.isNew) {
            setTasks((prev) =>
              prev.map((t) => (t.id === task.id ? { ...t, isNew: false } : t)),
            );
          }
          setEditingTask(task);
        };

        // FIXED: Only updates the specific task being edited
        const handleSaveTask = async (updatedTask) => {
          // If it's a recurring instance, ask if they want to edit series or just this task
          if (updatedTask.isRecurringInstance && updatedTask.seriesId) {
            const editSeries = confirm(
              "This is a recurring task. Would you like to edit the entire series?\n\nClick OK to Edit Series\nClick Cancel to Edit Only This Task",
            );

            if (editSeries) {
              // Update all future instances in the series
              setTasks((prev) =>
                prev.map((t) =>
                  t.seriesId === updatedTask.seriesId &&
                  t.status !== "completed"
                    ? {
                        ...t,
                        ...updatedTask,
                        id: t.id,
                        endDate: t.endDate,
                        startDate: t.startDate,
                        instanceNumber: t.instanceNumber,
                      }
                    : t,
                ),
              );
              showNotification("Series updated!", "success");
              return;
            }
          }

          setTasks((prev) =>
            prev.map((t) =>
              t.id === updatedTask.id ? { ...updatedTask, isNew: false } : t,
            ),
          );
          showNotification("Task updated!", "success");

          // Sync update to Discord
          if (BOT_CONFIG.enabled && updatedTask.discordTaskNumber) {
            try {
              const response = await fetch(
                `${BOT_CONFIG.apiUrl}/api/tasks/${updatedTask.discordTaskNumber}/update`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    name: updatedTask.name,
                    notes: updatedTask.notes,
                    category: updatedTask.category,
                    priority: updatedTask.priority,
                    startDate: updatedTask.startDate,
                    endDate: updatedTask.endDate,
                    assignedTo: updatedTask.assignedTo || updatedTask.assignee,
                    status: updatedTask.status,
                  }),
                },
              );

              if (!response.ok) {
                console.error("Failed to update Discord message");
              } else {
                console.log(
                  `‚úÖ Task #${updatedTask.discordTaskNumber} updated on Discord`,
                );
              }
            } catch (error) {
              console.error("Error updating Discord message:", error);
            }
          }
        };

        // User login/logout handlers
        const handleLogin = (user) => {
          setCurrentUser(user);
          localStorage.setItem("bottyotty-current-user", JSON.stringify(user));
          setShowLoginModal(false);
          showNotification(`Welcome back, ${user.name}!`, "success");
        };

        const handleLogout = () => {
          if (confirm("Are you sure you want to logout?")) {
            setCurrentUser(null);
            localStorage.removeItem("bottyotty-current-user");
            setShowLoginModal(true);
            showNotification("Logged out successfully", "info");
          }
        };

        const handleAssignTask = (task) => {
          const userName = currentUser?.name || "Me";
          // For recurring instances, just assign without moving views
          if (task.isRecurringInstance) {
            setTasks((prev) =>
              prev.map((t) =>
                t.id === task.id
                  ? {
                      ...t,
                      assignedTo: userName,
                      assignee: userName,
                      isNew: false,
                    }
                  : t,
              ),
            );
            showNotification("Task assigned to you", "success");
          } else {
            // Move task out of incoming to My Tasks and mark as read
            setTasks((prev) =>
              prev.map((t) =>
                t.id === task.id
                  ? {
                      ...t,
                      isIncoming: false,
                      isNew: false,
                      assignedTo: userName,
                      assignee: userName,
                    }
                  : t,
              ),
            );
            showNotification("Task assigned and moved to My Tasks", "success");
          }
        };

        const handleAssignToOther = async (task, person) => {
          // Assign task to someone else and move to Assigned Out
          // person object has: { name, discordId }

          // Check if user has skills for this task category
          const hasSkill = checkUserSkillsForTask(person.name, task.category);
          const userConfig = USER_CONFIG[person.name] || DEFAULT_USER_CONFIG;
          const userStatus = userConfig.status || "available";

          // Show warning if user doesn't have skill or is busy/swamped
          if (!hasSkill) {
            const confirmAssign = confirm(
              `‚ö†Ô∏è Warning: ${person.name} doesn't have "${task.category}" skill.\n\n` +
                `This task may be outside their expertise. Assign anyway?`,
            );
            if (!confirmAssign) {
              showNotification(`Assignment cancelled - skill mismatch`, "info");
              return;
            }
          }

          if (userStatus === "busy") {
            showNotification(
              `‚è∏Ô∏è ${person.name} is marked as BUSY but task assigned anyway`,
              "warning",
            );
          } else if (userStatus === "swamped") {
            const confirmAssign = confirm(
              `üÜò Warning: ${person.name} is currently SWAMPED!\n\n` +
                `They may be overwhelmed. Consider assigning to someone else or the skill pool. Assign anyway?`,
            );
            if (!confirmAssign) {
              // Offer to send to skill pool instead
              const sendToPool = confirm(
                `Send to ${task.category} skill pool instead?`,
              );
              if (sendToPool) {
                await autoAssignToSkillPool(task);
              }
              return;
            }
          }

          // For recurring instances, just assign without moving views
          if (task.isRecurringInstance) {
            setTasks((prev) =>
              prev.map((t) =>
                t.id === task.id
                  ? {
                      ...t,
                      isNew: false,
                      assignedTo: person.name,
                      assignee: person.name,
                      skillMatch: hasSkill,
                      assignedDespiteStatus:
                        userStatus !== "available" ? userStatus : null,
                    }
                  : t,
              ),
            );
            showNotification(`Task assigned to ${person.name}`, "success");
          } else {
            // Update local state immediately
            setTasks((prev) =>
              prev.map((t) =>
                t.id === task.id
                  ? {
                      ...t,
                      isIncoming: false,
                      isAssignedOut: true,
                      isNew: false,
                      assignedTo: person.name,
                      assignee: person.name,
                      skillMatch: hasSkill,
                      assignedDespiteStatus:
                        userStatus !== "available" ? userStatus : null,
                    }
                  : t,
              ),
            );
            showNotification(`Task assigned to ${person.name}`, "success");
          }

          // Send assignment to Discord bot
          if (BOT_CONFIG.enabled && task.discordTaskNumber) {
            try {
              const personalChannelId = PERSONAL_CHANNELS[person.name];
              const response = await fetch(
                `${BOT_CONFIG.apiUrl}/api/tasks/${task.discordTaskNumber}/assign`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    assignedTo: person.name,
                    assignedToId: person.discordId,
                    assigneeChannelId: personalChannelId,
                  }),
                },
              );

              if (!response.ok) {
                console.error("Failed to notify Discord bot about assignment");
              } else {
                console.log(
                  `‚úÖ Assignment sent to Discord: Task #${task.discordTaskNumber} ‚Üí ${person.name}`,
                );
              }
            } catch (error) {
              console.error("Error sending assignment to Discord:", error);
            }
          }
        };

        const handleSendToPool = async (task, poolChannelId) => {
          // Send task to pool and move to Pool tasks
          const poolName =
            POOL_CHANNELS.find((p) => p.channelId === poolChannelId)?.name ||
            "Pool";

          // Update local state immediately
          setTasks((prev) =>
            prev.map((t) =>
              t.id === task.id
                ? {
                    ...t,
                    isIncoming: false,
                    isPoolRequest: true,
                    isNew: false,
                  }
                : t,
            ),
          );

          showNotification(`Task sent to ${poolName}`, "success");

          // Send to Discord bot to create pool task
          if (BOT_CONFIG.enabled && task.discordTaskNumber) {
            try {
              const response = await fetch(
                `${BOT_CONFIG.apiUrl}/api/tasks/${task.discordTaskNumber}/send-to-pool`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    poolChannelId: poolChannelId,
                  }),
                },
              );

              if (!response.ok) {
                console.error("Failed to send task to pool");
              } else {
                console.log(
                  `‚úÖ Task #${task.discordTaskNumber} sent to ${poolName}`,
                );
              }
            } catch (error) {
              console.error("Error sending task to pool:", error);
            }
          }
        };

        const handleDeleteTask = async (taskId) => {
          const task = tasks.find((t) => t.id === taskId);
          if (!task) return;

          // Check delete permissions
          const userConfig = currentUser
            ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
            : DEFAULT_USER_CONFIG;
          const isOwnTask =
            task.assignedTo === currentUser?.name ||
            task.createdBy === currentUser?.name;

          // Permission check
          if (userConfig.canDeleteAllTasks) {
            // Super admin can delete anything
          } else if (
            userConfig.canDeleteOthersTasks &&
            (task.assignedTo || task.createdBy)
          ) {
            // Can delete other's assigned tasks
          } else if (userConfig.canDeletePoolTasks && task.isPoolRequest) {
            // Can delete pool tasks
          } else if (userConfig.canDeleteOwnTasks && isOwnTask) {
            // Can delete own tasks
          } else {
            showNotification(
              "‚õî You do not have permission to delete this task",
              "error",
            );
            return;
          }

          // Add task to trash with attribution
          setTrashedTasks((prev) => [
            ...prev,
            {
              ...task,
              trashedAt: Date.now(),
              deletedBy: currentUser?.name || "Unknown",
            },
          ]);
          setTasks((prev) => prev.filter((t) => t.id !== taskId));
          showNotification("Task moved to trash", "info");

          if (BOT_CONFIG.enabled) {
            try {
              await fetch(`${BOT_CONFIG.apiUrl}/api/tasks/${taskId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  deletedBy: currentUser?.name || "Unknown",
                }),
              });
            } catch (error) {
              console.error("Delete failed:", error);
            }
          }
        };

        const handleUndoDelete = async (taskId) => {
          const task = trashedTasks.find((t) => t.id === taskId);
          if (!task) return;

          // Check restore permissions - everyone can restore their own trash
          const isOwnTrash = task.deletedBy === currentUser?.name;
          const userConfig = currentUser
            ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
            : DEFAULT_USER_CONFIG;
          const canRestoreAll = userConfig.canViewAllTrash; // Admins who can see all trash can restore all

          if (!isOwnTrash && !canRestoreAll) {
            showNotification(
              "‚õî You can only restore tasks you deleted",
              "error",
            );
            return;
          }

          delete task.trashedAt;
          delete task.deletedBy;
          setTasks((prev) => [...prev, task]);
          setTrashedTasks((prev) => prev.filter((t) => t.id !== taskId)); // FIXED: Keep all except restored task
          showNotification("Task restored!", "success");

          // Sync restore to bot
          if (BOT_CONFIG.enabled && task.discordTaskNumber) {
            try {
              await fetch(
                `${BOT_CONFIG.apiUrl}/api/trash/${task.discordTaskNumber}/restore`,
                {
                  method: "POST",
                },
              );
            } catch (error) {
              console.error("Restore sync failed:", error);
            }
          }
        };

        const handleToggleStar = (taskId) => {
          setTasks((prev) =>
            prev.map((t) =>
              t.id === taskId ? { ...t, starred: !t.starred } : t,
            ),
          );
        };

        const handleShowUpdateModal = (task) => {
          setUpdatingTask(task);
          setShowUpdateModal(true);
          // Fetch updates for this task
          if (task.discordTaskNumber) {
            fetch(
              `http://localhost:5000/api/tasks/${task.discordTaskNumber}/updates`,
            )
              .then((res) => res.json())
              .then((data) => {
                setTaskUpdates((prev) => ({
                  ...prev,
                  [task.discordTaskNumber]: data.updates || [],
                }));
              })
              .catch((err) => console.error("Error fetching updates:", err));
          }
        };

        const handleCompleteTask = async (taskId) => {
          const task = tasks.find((t) => t.id === taskId);

          // Check if it's the last instance of a recurring series
          if (task?.isRecurringInstance && task?.seriesId) {
            const seriesTasks = tasks.filter(
              (t) => t.seriesId === task.seriesId && t.status !== "completed",
            );
            const isLastInstance =
              seriesTasks.length === 1 && seriesTasks[0].id === taskId;

            if (isLastInstance && task.instanceNumber === task.totalInstances) {
              // Ask user if they want to renew or complete series
              const renew = confirm(
                "This is the last task in the recurring series. Would you like to renew the series for another year?\n\nClick OK to Renew Series\nClick Cancel to Complete Series",
              );

              if (renew) {
                // Generate new instances for another year
                const newBaseTask = { ...task };
                delete newBaseTask.id;
                delete newBaseTask.instanceNumber;
                delete newBaseTask.totalInstances;
                delete newBaseTask.isRecurringInstance;
                delete newBaseTask.seriesId;

                const newInstances = generateRecurringInstances(newBaseTask);
                setTasks((prev) => [
                  ...prev.map((t) =>
                    t.id === taskId
                      ? {
                          ...t,
                          status: "completed",
                          completedBy: currentUser?.name,
                          completedAt: new Date().toISOString(),
                        }
                      : t,
                  ),
                  ...newInstances,
                ]);
                showNotification(
                  `Series renewed! ${newInstances.length} new instances created.`,
                  "success",
                );
              } else {
                setTasks((prev) =>
                  prev.map((t) =>
                    t.id === taskId
                      ? {
                          ...t,
                          status: "completed",
                          completedBy: currentUser?.name,
                          completedAt: new Date().toISOString(),
                        }
                      : t,
                  ),
                );
                showNotification("Recurring series completed! üéâ", "success");
              }
              return;
            }
          }

          // Update local state
          setTasks((prev) =>
            prev.map((t) =>
              t.id === taskId
                ? {
                    ...t,
                    status: "completed",
                    completedBy: currentUser?.name,
                    completedAt: new Date().toISOString(),
                  }
                : t,
            ),
          );
          showNotification("Task completed! üéâ", "success");

          // Sync to Discord bot if task has a Discord task number
          if (BOT_CONFIG.enabled && task?.discordTaskNumber) {
            try {
              const completedAt = new Date().toISOString();
              await fetch(
                `${BOT_CONFIG.apiUrl}/api/tasks/${task.discordTaskNumber}/complete`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    completedBy: currentUser?.name || "Unknown",
                    completedAt: completedAt,
                  }),
                },
              );
              console.log(
                `‚úÖ Synced completion of task #${task.discordTaskNumber} to Discord`,
              );
            } catch (error) {
              console.error("Failed to sync completion to Discord:", error);
            }
          }

          // Notify requester if requestedBy field is set
          if (task?.requestedBy && BOT_CONFIG.enabled) {
            try {
              // Find the requester's Discord ID from TEAM_MEMBERS
              const requester = TEAM_MEMBERS.find(
                (m) => m.name === task.requestedBy,
              );

              if (requester) {
                await fetch(`${BOT_CONFIG.apiUrl}/api/notify/completion`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    requesterId: requester.discordId,
                    requesterName: task.requestedBy,
                    taskName: task.name,
                    taskId: task.discordTaskNumber || task.id,
                    completedBy: currentUser?.name || "Unknown",
                    completedAt: new Date().toISOString(),
                  }),
                });
                console.log(
                  `‚úÖ Notified ${task.requestedBy} about task completion`,
                );
              }
            } catch (error) {
              console.error("Failed to notify requester:", error);
            }
          }
        };

        const handleSaveForLater = async (taskId) => {
          const task = tasks.find((t) => t.id === taskId);

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id === taskId) {
                return {
                  ...t,
                  status: "saved",
                  savedFromStatus: t.status,
                  savedFromAssignedTo: t.assignedTo,
                  savedFromView: activeView,
                  savedAt: new Date().toISOString(),
                };
              }
              return t;
            }),
          );
          showNotification("Task saved for later", "info");

          // If it's a pool task, release it back to pool on Discord
          if (
            BOT_CONFIG.enabled &&
            task?.discordTaskNumber &&
            task?.isPoolRequest
          ) {
            try {
              await fetch(
                `${BOT_CONFIG.apiUrl}/api/tasks/${task.discordTaskNumber}/release-to-pool`,
                {
                  method: "POST",
                },
              );
              console.log(
                `üîÑ Released pool task #${task.discordTaskNumber} to pool on Discord`,
              );
            } catch (error) {
              console.error(
                "Failed to release task to pool on Discord:",
                error,
              );
            }
          }
        };

        const handleUndoSaveForLater = (taskId) => {
          setTasks((prev) =>
            prev.map((t) => {
              if (t.id === taskId && t.status === "saved") {
                const restoredTask = {
                  ...t,
                  status: t.savedFromStatus || "active",
                  assignedTo: t.savedFromAssignedTo,
                  savedFromStatus: undefined,
                  savedFromAssignedTo: undefined,
                  savedFromView: undefined,
                  savedAt: undefined,
                };
                // Switch to the original view if available
                if (t.savedFromView) {
                  setTimeout(() => setActiveView(t.savedFromView), 100);
                }
                return restoredTask;
              }
              return t;
            }),
          );
          showNotification("Task restored!", "success");
        };

        const handleActivateTask = (taskId) => {
          setTasks((prev) =>
            prev.map((t) => (t.id === taskId ? { ...t, status: "active" } : t)),
          );
          showNotification("Task activated!", "success");
        };

        // FIXED: Drag and drop actually works now
        const handleDragOver = (e) => {
          e.preventDefault();
          e.currentTarget.classList.add("drag-over");
        };

        const handleDragLeave = (e) => {
          e.currentTarget.classList.remove("drag-over");
        };

        const handleDrop = (e, targetView) => {
          e.preventDefault();
          e.currentTarget.classList.remove("drag-over");

          const taskId = parseInt(e.dataTransfer.getData("taskId"));
          if (!taskId) return;

          const currentUserName = currentUser?.name || "Unknown";
          const userConfig = currentUser
            ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
            : DEFAULT_USER_CONFIG;
          const task = tasks.find((t) => t.id === taskId);
          if (!task) return;

          // Check if user has permission to move this task
          const canMove =
            userConfig.canMoveTasksFreely ||
            userConfig.isAdmin ||
            userConfig.isManager ||
            task.assignedTo === currentUserName ||
            task.assignee === currentUserName ||
            !task.assignedTo; // Unassigned tasks can be moved by anyone

          if (!canMove) {
            showNotification(
              "‚õî You need manager/admin privileges to move assigned tasks",
              "error",
            );
            return;
          }

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== taskId) return t;

              // Update task properties based on target view
              const updates = {
                ...t,
                lastTouchedAt: new Date().toISOString(), // Track activity
                lastTouchedBy: currentUserName,
              };

              if (targetView === "incoming") {
                updates.isIncoming = true;
                updates.isAssignedOut = false;
                updates.isPoolRequest = false;
                updates.isTeamRequest = false;
                updates.isCampfire = false;
                updates.isTransferRequest = false;
              } else if (targetView === "my-tasks") {
                updates.isIncoming = false;
                updates.isAssignedOut = false;
                updates.isPoolRequest = false;
                updates.isTeamRequest = false;
                updates.isCampfire = false;
                updates.isTransferRequest = false;
                updates.assignedTo = currentUserName;
                updates.assignee = currentUserName;
              } else if (targetView === "assigned-out") {
                updates.isIncoming = false;
                updates.isAssignedOut = true;
                updates.isPoolRequest = false;
                updates.isTeamRequest = false;
                updates.isCampfire = false;
                updates.isTransferRequest = false;
              } else if (targetView === "pool") {
                updates.isIncoming = false;
                updates.isAssignedOut = false;
                updates.isPoolRequest = true;
                updates.isTeamRequest = false;
                updates.isCampfire = false;
                updates.isTransferRequest = false;
                updates.assignedTo = ""; // Unassign when moving to pool
                updates.workingOnBy = ""; // Clear working indicator
              } else if (targetView === "team") {
                updates.isIncoming = false;
                updates.isAssignedOut = false;
                updates.isPoolRequest = false;
                updates.isTeamRequest = true;
                updates.isCampfire = false;
                updates.isTransferRequest = false;
              }

              return updates;
            }),
          );

          // Mark task as staged if in staging mode
          if (stagingMode) {
            setStagedTasks((prev) => new Set([...prev, taskId]));
            showNotification(`Task staged (not synced yet)`, "info");
          } else {
            showNotification(`Task moved to ${targetView}!`, "success");

            // Sync to Discord
            if (BOT_CONFIG.enabled) {
              syncTaskChangeToBot(taskId, "moved", {
                targetView,
                movedBy: currentUserName,
              });
            }
          }
        };

        // Deploy staged changes
        const handleDeploy = async () => {
          if (stagedTasks.size === 0) {
            showNotification("No staged changes to deploy", "info");
            return;
          }

          const count = stagedTasks.size;
          setStagedTasks(new Set()); // Clear staged tasks
          showNotification(
            `Deploying ${count} task${count > 1 ? "s" : ""}...`,
            "info",
          );

          // Trigger sync with bot to send updates to Discord
          if (BOT_CONFIG.enabled) {
            await syncWithBot();
          }

          showNotification(
            `‚úÖ ${count} task${count > 1 ? "s" : ""} deployed!`,
            "success",
          );
        };

        // Sync task changes to Discord bot
        const syncTaskChangeToBot = async (
          taskId,
          changeType,
          metadata = {},
        ) => {
          if (!BOT_CONFIG.enabled || !BOT_CONFIG.apiUrl) return;

          const task = tasks.find((t) => t.id === taskId);
          if (!task) return;

          try {
            await fetch(`${BOT_CONFIG.apiUrl}/api/tasks/${taskId}/log`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                changeType,
                task,
                metadata,
                timestamp: new Date().toISOString(),
              }),
            });
          } catch (error) {
            console.error("Failed to sync task change to bot:", error);
          }
        };

        // Toggle "Working On It" indicator
        const handleToggleWorkingOn = async (taskId) => {
          const currentUserName = currentUser?.name || "Unknown";
          const task = tasks.find((t) => t.id === taskId);
          if (!task) return;

          const isCurrentlyWorking = task.workingOnBy === currentUserName;

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== taskId) return t;
              return {
                ...t,
                workingOnBy: isCurrentlyWorking ? "" : currentUserName,
                workingOnSince: isCurrentlyWorking
                  ? null
                  : new Date().toISOString(),
                lastTouchedAt: new Date().toISOString(),
                lastTouchedBy: currentUserName,
              };
            }),
          );

          showNotification(
            isCurrentlyWorking
              ? "‚úã Stopped working on task"
              : "üöÄ Marked as working on task",
            "success",
          );

          // Sync to Discord
          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(taskId, "working-status", {
              working: !isCurrentlyWorking,
              user: currentUserName,
            });
          }
        };

        // Create transfer request (user-to-user without admin privileges)
        const handleCreateTransferRequest = async (task, targetUser) => {
          const currentUserName = currentUser?.name || "Unknown";
          const userConfig = currentUser
            ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
            : DEFAULT_USER_CONFIG;

          // If user has admin/manager privileges, just transfer directly
          if (
            userConfig.canMoveTasksFreely ||
            userConfig.isAdmin ||
            userConfig.isManager
          ) {
            setTasks((prev) =>
              prev.map((t) => {
                if (t.id !== task.id) return t;
                return {
                  ...t,
                  assignedTo: targetUser,
                  assignee: targetUser,
                  assignedBy: currentUserName,
                  isAssignedOut: true,
                  lastTouchedAt: new Date().toISOString(),
                  lastTouchedBy: currentUserName,
                };
              }),
            );
            showNotification(`‚úÖ Task transferred to ${targetUser}`, "success");

            if (BOT_CONFIG.enabled) {
              syncTaskChangeToBot(task.id, "transferred", {
                from: currentUserName,
                to: targetUser,
              });
            }
            return;
          }

          // Create transfer request for regular users
          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== task.id) return t;
              return {
                ...t,
                isTransferRequest: true,
                transferFrom: currentUserName,
                transferTo: targetUser,
                transferStatus: "pending",
                transferRequestedAt: new Date().toISOString(),
                lastTouchedAt: new Date().toISOString(),
                lastTouchedBy: currentUserName,
              };
            }),
          );

          showNotification(`üì® Transfer request sent to ${targetUser}`, "info");

          // Notify admins/managers
          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(task.id, "transfer-requested", {
              from: currentUserName,
              to: targetUser,
              requiresApproval: true,
            });
          }
        };

        // Accept transfer request
        const handleAcceptTransfer = async (task) => {
          const currentUserName = currentUser?.name || "Unknown";

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== task.id) return t;
              return {
                ...t,
                assignedTo: task.transferTo,
                assignee: task.transferTo,
                assignedBy: task.transferFrom,
                isTransferRequest: false,
                isAssignedOut: false,
                transferStatus: "accepted",
                transferAcceptedAt: new Date().toISOString(),
                lastTouchedAt: new Date().toISOString(),
                lastTouchedBy: currentUserName,
              };
            }),
          );

          showNotification(
            `‚úÖ Transfer accepted! Task moved to your tasks`,
            "success",
          );

          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(task.id, "transfer-accepted", {
              from: task.transferFrom,
              to: task.transferTo,
              acceptedBy: currentUserName,
            });
          }
        };

        // Deny transfer request
        const handleDenyTransfer = async (task, reason = "") => {
          const currentUserName = currentUser?.name || "Unknown";

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== task.id) return t;
              return {
                ...t,
                assignedTo: task.transferFrom, // Send back to sender
                assignee: task.transferFrom,
                isTransferRequest: false,
                isAssignedOut: false,
                transferStatus: "denied",
                transferDeniedAt: new Date().toISOString(),
                transferDeniedReason: reason,
                lastTouchedAt: new Date().toISOString(),
                lastTouchedBy: currentUserName,
              };
            }),
          );

          showNotification(
            `‚ùå Transfer denied. Task returned to ${task.transferFrom}`,
            "info",
          );

          // Notify admins/managers about denied transfer
          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(task.id, "transfer-denied", {
              from: task.transferFrom,
              to: task.transferTo,
              deniedBy: currentUserName,
              reason,
            });
          }
        };

        // Claim pool task
        const handleClaimPoolTask = async (task) => {
          const currentUserName = currentUser?.name || "Unknown";

          // Check if task is already being worked on
          if (task.workingOnBy && task.workingOnBy !== currentUserName) {
            showNotification(
              `‚ö†Ô∏è ${task.workingOnBy} is already working on this task`,
              "warning",
            );
            return;
          }

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== task.id) return t;
              return {
                ...t,
                assignedTo: currentUserName,
                assignee: currentUserName,
                isPoolRequest: false,
                workingOnBy: currentUserName,
                workingOnSince: new Date().toISOString(),
                claimedAt: new Date().toISOString(),
                lastTouchedAt: new Date().toISOString(),
                lastTouchedBy: currentUserName,
              };
            }),
          );

          showNotification(`‚úÖ Task claimed and moved to My Tasks!`, "success");

          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(task.id, "claimed", {
              claimedBy: currentUserName,
            });
          }
        };

        // Check for inactive tasks and send alerts
        const checkTaskAlerts = () => {
          const now = new Date();
          const currentUserName = currentUser?.name || "Unknown";
          const userConfig = currentUser
            ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
            : DEFAULT_USER_CONFIG;
          const alertTiming = userConfig.isAdmin
            ? userConfig.adminAlertTiming ||
              DEFAULT_USER_CONFIG.adminAlertTiming
            : userConfig.alertTiming || DEFAULT_USER_CONFIG.alertTiming;

          tasks.forEach((task) => {
            if (task.status !== "active" || !task.lastTouchedAt) return;

            const lastTouched = new Date(task.lastTouchedAt);
            const hoursSinceTouch = (now - lastTouched) / (1000 * 60 * 60);

            // First alert to user
            if (
              hoursSinceTouch >= alertTiming.firstAlert &&
              !task.alertedUser
            ) {
              showNotification(
                `‚è∞ Task "${task.name}" needs attention!`,
                "warning",
              );
              setTasks((prev) =>
                prev.map((t) =>
                  t.id === task.id
                    ? {
                        ...t,
                        alertedUser: true,
                        lastAlertAt: now.toISOString(),
                      }
                    : t,
                ),
              );

              if (BOT_CONFIG.enabled) {
                syncTaskChangeToBot(task.id, "alert-user", { hoursSinceTouch });
              }
            }

            // Escalate to manager
            if (
              hoursSinceTouch >= alertTiming.managerEscalation &&
              !task.alertedManager
            ) {
              setTasks((prev) =>
                prev.map((t) =>
                  t.id === task.id
                    ? {
                        ...t,
                        alertedManager: true,
                        escalatedAt: now.toISOString(),
                      }
                    : t,
                ),
              );

              if (BOT_CONFIG.enabled) {
                syncTaskChangeToBot(task.id, "alert-manager", {
                  hoursSinceTouch,
                  assignee: task.assignedTo,
                });
              }
            }

            // Release to pool
            if (
              hoursSinceTouch >= alertTiming.poolRelease &&
              !task.releasedToPool
            ) {
              setTasks((prev) =>
                prev.map((t) => {
                  if (t.id !== task.id) return t;
                  return {
                    ...t,
                    isPoolRequest: true,
                    assignedTo: "",
                    workingOnBy: "",
                    releasedToPool: true,
                    releasedAt: now.toISOString(),
                    releaseReason: "Inactivity timeout",
                  };
                }),
              );

              showNotification(
                `üì§ Task "${task.name}" released to pool due to inactivity`,
                "info",
              );

              if (BOT_CONFIG.enabled) {
                syncTaskChangeToBot(task.id, "released-to-pool", {
                  hoursSinceTouch,
                  reason: "inactivity",
                });
              }
            }
          });
        };

        // Run alert check every 30 minutes
        useEffect(() => {
          const alertInterval = setInterval(checkTaskAlerts, 30 * 60 * 1000);
          return () => clearInterval(alertInterval);
        }, [tasks, currentUser]);

        // Check if user has skills for task category
        const checkUserSkillsForTask = (userName, taskCategory) => {
          const userConfig = USER_CONFIG[userName] || DEFAULT_USER_CONFIG;
          return userConfig.skills && userConfig.skills.includes(taskCategory);
        };

        // Get available users with specific skill
        const getAvailableUsersWithSkill = (category) => {
          return Object.keys(USER_CONFIG).filter((userName) => {
            const config = USER_CONFIG[userName];
            return (
              config.skills &&
              config.skills.includes(category) &&
              config.status === "available" &&
              config.canReceiveAutoAssignments
            );
          });
        };

        // Auto-assign task to skill-based pool
        const autoAssignToSkillPool = async (task) => {
          const category = task.category || "General";
          const availableUsers = getAvailableUsersWithSkill(category);

          if (availableUsers.length === 0) {
            // No users with this skill available - send to general pool
            showNotification(
              `‚ö†Ô∏è No users available with "${category}" skill. Task sent to general pool.`,
              "warning",
            );

            setTasks((prev) =>
              prev.map((t) => {
                if (t.id !== task.id) return t;
                return {
                  ...t,
                  isPoolRequest: true,
                  assignedTo: "",
                  skillMismatch: true,
                  skillMismatchReason: `No available users with ${category} skill`,
                };
              }),
            );

            if (BOT_CONFIG.enabled) {
              syncTaskChangeToBot(task.id, "skill-pool-assignment", {
                category,
                availableUsers: 0,
                sentToGeneralPool: true,
              });
            }
          } else {
            // Notify users with matching skills
            showNotification(
              `‚úÖ Task assigned to ${category} skill pool (${availableUsers.length} users notified)`,
              "success",
            );

            setTasks((prev) =>
              prev.map((t) => {
                if (t.id !== task.id) return t;
                return {
                  ...t,
                  isPoolRequest: true,
                  assignedTo: "",
                  skillMatchedUsers: availableUsers,
                  skillPoolCategory: category,
                };
              }),
            );

            if (BOT_CONFIG.enabled) {
              syncTaskChangeToBot(task.id, "skill-pool-assignment", {
                category,
                availableUsers: availableUsers.length,
                notifiedUsers: availableUsers,
              });
            }
          }
        };

        // Handle user status: Swamped
        const handleSetSwamped = async () => {
          const currentUserName = currentUser?.name || "Unknown";

          // Update user status in config
          if (USER_CONFIG[currentUserName]) {
            USER_CONFIG[currentUserName].status = "swamped";
            USER_CONFIG[currentUserName].canReceiveAutoAssignments = false;
          }

          showNotification(
            "üÜò You marked yourself as SWAMPED. Managers have been notified.",
            "warning",
          );

          // Notify Discord/managers
          if (BOT_CONFIG.enabled) {
            try {
              await fetch(
                `${BOT_CONFIG.apiUrl}/api/users/${currentUserName}/status`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    status: "swamped",
                    timestamp: new Date().toISOString(),
                    notifyManagers: true,
                  }),
                },
              );
            } catch (error) {
              console.error("Failed to sync swamped status:", error);
            }
          }
        };

        // Handle user status: Busy
        const handleSetBusy = async () => {
          const currentUserName = currentUser?.name || "Unknown";

          if (USER_CONFIG[currentUserName]) {
            USER_CONFIG[currentUserName].status = "busy";
            USER_CONFIG[currentUserName].canReceiveAutoAssignments = false;
          }

          showNotification(
            "‚è∏Ô∏è Status set to BUSY. You won't receive new auto-assignments.",
            "info",
          );

          if (BOT_CONFIG.enabled) {
            try {
              await fetch(
                `${BOT_CONFIG.apiUrl}/api/users/${currentUserName}/status`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    status: "busy",
                    timestamp: new Date().toISOString(),
                  }),
                },
              );
            } catch (error) {
              console.error("Failed to sync busy status:", error);
            }
          }
        };

        // Handle user status: Available
        const handleSetAvailable = async () => {
          const currentUserName = currentUser?.name || "Unknown";

          if (USER_CONFIG[currentUserName]) {
            USER_CONFIG[currentUserName].status = "available";
            USER_CONFIG[currentUserName].canReceiveAutoAssignments = true;
          }

          showNotification(
            "‚úÖ Status set to AVAILABLE. You can receive new assignments.",
            "success",
          );

          if (BOT_CONFIG.enabled) {
            try {
              await fetch(
                `${BOT_CONFIG.apiUrl}/api/users/${currentUserName}/status`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    status: "available",
                    timestamp: new Date().toISOString(),
                  }),
                },
              );
            } catch (error) {
              console.error("Failed to sync available status:", error);
            }
          }
        };

        // Offer help on a task
        const handleOfferHelp = async (task) => {
          const currentUserName = currentUser?.name || "Unknown";

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== task.id) return t;
              return {
                ...t,
                needsHelp: true,
                helpOfferedBy: currentUserName,
                helpOfferedAt: new Date().toISOString(),
                helpMessage:
                  "Task owner is offering help or looking for assistance",
              };
            }),
          );

          showNotification(
            "ü§ù Help request sent! Task marked as needing assistance.",
            "success",
          );

          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(task.id, "help-offered", {
              offeredBy: currentUserName,
              taskName: task.name,
            });
          }
        };

        // Accept help offer
        const handleAcceptHelp = async (task) => {
          const currentUserName = currentUser?.name || "Unknown";

          setTasks((prev) =>
            prev.map((t) => {
              if (t.id !== task.id) return t;
              return {
                ...t,
                needsHelp: false,
                helpAcceptedBy: currentUserName,
                helpAcceptedAt: new Date().toISOString(),
                assignedTo: currentUserName, // Transfer to helper
                assignedBy: task.helpOfferedBy || task.assignedTo,
              };
            }),
          );

          showNotification(
            "‚úÖ Help accepted! Task transferred to you.",
            "success",
          );

          if (BOT_CONFIG.enabled) {
            syncTaskChangeToBot(task.id, "help-accepted", {
              acceptedBy: currentUserName,
              originalOwner: task.helpOfferedBy || task.assignedTo,
            });
          }
        };

        // Filter tasks
        const filteredTasks = useMemo(() => {
          let filtered = tasks.filter((t) => {
            if (searchTerm) {
              const term = searchTerm.toLowerCase();
              const matchesName = t.name?.toLowerCase().includes(term);
              const matchesAssignee = t.assignee?.toLowerCase().includes(term);
              const matchesCategory = t.category?.toLowerCase().includes(term);
              if (!matchesName && !matchesAssignee && !matchesCategory)
                return false;
            }
            if (filterCategory !== "all" && t.category !== filterCategory)
              return false;
            if (filterPriority !== "all" && t.priority !== filterPriority)
              return false;
            if (filterUser !== "all") {
              if (filterUser === "Unassigned") {
                if (t.assignedTo || t.assignee) return false;
              } else {
                if (t.assignedTo !== filterUser && t.assignee !== filterUser)
                  return false;
              }
            }
            return true;
          });

          // Apply quick filter (only for active tasks in non-calendar views)
          if (quickFilter !== "all" && activeView !== "calendar") {
            const today = dateKeyFromLocal(new Date());
            const tomorrow = dateKeyFromLocal(
              new Date(new Date().setDate(new Date().getDate() + 1)),
            );

            filtered = filtered.filter((t) => {
              if (t.status !== "active") return false;

              if (quickFilter === "today") {
                if (!t.startDate && !t.endDate) return false;
                const start = t.startDate || t.endDate;
                const end = t.endDate || t.startDate;
                return today >= start && today <= end;
              }

              if (quickFilter === "tomorrow") {
                if (!t.startDate && !t.endDate) return false;
                const start = t.startDate || t.endDate;
                const end = t.endDate || t.startDate;
                return tomorrow >= start && tomorrow <= end;
              }

              if (quickFilter === "this-week") {
                if (!t.startDate && !t.endDate) return false;
                const start = t.startDate || t.endDate;
                const end = t.endDate || t.startDate;
                // Check if task falls within the next 7 days
                const weekEnd = dateKeyFromLocal(
                  new Date(new Date().setDate(new Date().getDate() + 6)),
                );
                return end >= today && start <= weekEnd;
              }

              if (quickFilter === "overdue") {
                return isOverdue(t);
              }

              return true;
            });
          }

          return filtered;
        }, [
          tasks,
          searchTerm,
          filterCategory,
          filterPriority,
          filterUser,
          quickFilter,
          activeView,
        ]);

        // Helper to check if a future task is due (this week)
        const isFutureTaskDue = (task) => {
          if (!task.isRecurringInstance) return false;
          const now = new Date();
          now.setHours(0, 0, 0, 0);
          const taskDate = new Date(task.endDate || task.startDate);
          taskDate.setHours(0, 0, 0, 0);
          // Calculate end of this week (Sunday)
          const endOfWeek = new Date(now);
          endOfWeek.setDate(now.getDate() + (6 - now.getDay()));
          // Task is due if it's between today and end of this week
          return taskDate >= now && taskDate <= endOfWeek;
        };

        const incomingTasks = filteredTasks.filter(
          (t) => t.isIncoming && !t.isCampfire && t.status === "active",
        );
        const hasUnreadIncoming = incomingTasks.some((t) => t.isNew);

        const userName = currentUser?.name || "Me";
        const userConfig = currentUser
          ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
          : DEFAULT_USER_CONFIG;

        const myTasks = filteredTasks.filter((t) => {
          // Regular tasks (not incoming, not assigned out, etc.)
          const isRegularTask =
            !t.isIncoming &&
            !t.isAssignedOut &&
            !t.isTeamRequest &&
            !t.isPoolRequest &&
            !t.isCampfire &&
            t.status === "active" &&
            !t.isRecurringInstance;
          // Must be assigned to current user or unassigned
          const isAssignedToMe =
            !t.assignedTo ||
            t.assignedTo === userName ||
            t.assignee === userName;
          // Future tasks assigned to me that are due soon
          const isDueFutureTask =
            t.isRecurringInstance &&
            t.status === "active" &&
            (t.assignedTo === userName || t.assignee === userName) &&
            isFutureTaskDue(t);
          // Tasks from Assigned Out that are assigned to me (show in both views)
          const isAssignedOutToMe =
            t.isAssignedOut &&
            t.status === "active" &&
            (t.assignedTo === userName || t.assignee === userName);
          return (
            (isRegularTask && isAssignedToMe) ||
            isDueFutureTask ||
            isAssignedOutToMe
          );
        });

        const assignedOutTasks = filteredTasks.filter((t) => {
          let passesBasicFilter = false;

          // If user has team activity permission and team activity view is enabled
          if (showTeamActivity && userConfig.canViewTeamActivity) {
            // Show ALL task assignments (any task with assignedTo or assignee)
            const hasAssignment =
              (t.assignedTo || t.assignee) && t.status === "active";
            // Include both regular assigned tasks and due future tasks
            const isRegularWithAssignment =
              (t.isAssignedOut || t.assignedTo || t.assignee) &&
              t.status === "active" &&
              !t.isRecurringInstance;
            const isDueFutureWithAssignment =
              t.isRecurringInstance &&
              t.status === "active" &&
              (t.assignedTo || t.assignee) &&
              isFutureTaskDue(t);
            passesBasicFilter =
              isRegularWithAssignment || isDueFutureWithAssignment;
          } else {
            // Regular view: only show tasks assigned by current user
            // Regular assigned out tasks
            const isRegularAssignedOut =
              t.isAssignedOut && t.status === "active";
            // Future tasks assigned to others that are due soon
            const isDueFutureTaskToOthers =
              t.isRecurringInstance &&
              t.status === "active" &&
              t.assignedTo &&
              t.assignedTo !== userName &&
              isFutureTaskDue(t);
            passesBasicFilter = isRegularAssignedOut || isDueFutureTaskToOthers;
          }

          // Apply assignedBy filter if user has admin permissions
          if (passesBasicFilter && userConfig.canViewTeamActivity) {
            if (assignedByFilter === "me") {
              return t.assignedBy === userName;
            } else if (assignedByFilter === "others") {
              return t.assignedBy && t.assignedBy !== userName;
            }
          }

          return passesBasicFilter;
        });

        const teamTasks = filteredTasks.filter(
          (t) => t.isTeamRequest && t.status === "active",
        );
        const transferRequests = filteredTasks.filter(
          (t) =>
            t.isTransferRequest &&
            t.status === "active" &&
            (t.transferTo === userName || userConfig.canApproveTransfers),
        );
        const poolTasks = filteredTasks.filter(
          (t) => t.isPoolRequest && t.status === "active",
        );
        const campfireTasks = filteredTasks.filter(
          (t) => t.isCampfire && t.status === "active",
        );
        const starredTasks = filteredTasks.filter(
          (t) => t.starred && t.status === "active",
        );
        const savedTasks = filteredTasks.filter((t) => t.status === "saved");

        // Filter completed tasks based on permissions
        const allCompletedTasks = filteredTasks.filter(
          (t) => t.status === "completed",
        );
        const completedTasks = userConfig.canViewAllCompleted
          ? allCompletedTasks // Admins see all completed tasks
          : allCompletedTasks.filter(
              (t) => t.completedBy === userName || t.assignedTo === userName,
            ); // Regular users see only their completed tasks

        const overdueTasks = tasks.filter(
          (t) => isOverdue(t) && t.status === "active",
        );

        // Get current date for display
        const now = new Date();
        const dayOfWeek = now.toLocaleDateString("en-US", { weekday: "long" });
        const fullDate = now.toLocaleDateString("en-US", {
          month: "long",
          day: "numeric",
          year: "numeric",
        });

        return (
          <div className="min-h-screen p-4 md:p-8">
            {/* Header */}
            <div className="glass rounded-2xl p-6 mb-6">
              <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                  <img
                    src="/mnt/user-data/uploads/Botty_Otty_Logo.png"
                    alt="BottyOtty"
                    className="w-16 h-16 object-contain"
                    onError={(e) => {
                      e.target.style.display = "none";
                    }}
                  />
                  <div>
                    <h1 className="text-4xl font-bold text-white mb-1">
                      BottyOtty
                    </h1>
                    {BOT_CONFIG.enabled && (
                      <BotStatus apiUrl={BOT_CONFIG.apiUrl} />
                    )}
                  </div>
                </div>

                {/* Date Display */}
                <div className="flex-shrink-0 px-6">
                  <div className="text-center">
                    <div className="text-white font-bold text-lg">
                      {dayOfWeek}
                    </div>
                    <div className="text-gray-200 text-sm">{fullDate}</div>
                  </div>
                </div>

                {/* User Display with Status */}
                {currentUser && (
                  <div className="flex flex-col gap-2">
                    <div className="flex items-center gap-3 bg-white bg-opacity-10 px-4 py-2 rounded-lg">
                      <div className="text-white">
                        <div className="text-xs text-gray-200">
                          Logged in as
                        </div>
                        <div className="font-bold flex items-center gap-2">
                          {currentUser.name}
                          {(() => {
                            const userConfig =
                              USER_CONFIG[currentUser.name] ||
                              DEFAULT_USER_CONFIG;
                            const status = userConfig.status || "available";
                            if (status === "swamped")
                              return (
                                <span
                                  className="text-xs px-2 py-0.5 rounded-full animate-pulse"
                                  style={{ backgroundColor: "#454d28" }}
                                >
                                  üéë SWAMPED
                                </span>
                              );
                            if (status === "busy")
                              return (
                                <span className="text-xs bg-yellow-600 px-2 py-0.5 rounded-full">
                                  ‚è∏Ô∏è BUSY
                                </span>
                              );
                            return (
                              <span className="text-xs bg-green-600 px-2 py-0.5 rounded-full">
                                ‚úÖ AVAILABLE
                              </span>
                            );
                          })()}
                        </div>
                      </div>
                      <button
                        onClick={handleLogout}
                        className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium transition-colors"
                        title="Logout"
                      >
                        Logout
                      </button>
                    </div>

                    {/* Status Control Buttons */}
                    <div className="flex gap-1">
                      <button
                        onClick={handleSetAvailable}
                        className="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-medium transition-colors"
                        title="Set status to Available"
                      >
                        ‚úÖ Available
                      </button>
                      <button
                        onClick={handleSetBusy}
                        className="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-xs font-medium transition-colors"
                        title="Set status to Busy"
                      >
                        ‚è∏Ô∏è Busy
                      </button>
                      <button
                        onClick={handleSetSwamped}
                        style={{ backgroundColor: "#454d28" }}
                        className="px-2 py-1 hover:opacity-90 text-white rounded text-xs font-medium transition-colors animate-pulse"
                        title="Call for help - notify managers"
                      >
                        üéë Swamped!
                      </button>
                    </div>
                  </div>
                )}

                {/* 2-Line Layout: Actions and System Tools */}
                <div className="flex flex-col gap-2 items-end">
                  {/* Line 1: Primary Action Buttons */}
                  <div className="flex flex-wrap gap-2 items-center justify-end">
                    <button
                      onClick={() => setShowAddTask(true)}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-all text-sm shadow-lg"
                      title="Create New Task"
                    >
                      ‚ûï Add Task
                    </button>

                    <button
                      onClick={() => setShowTrash(true)}
                      className="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all text-sm"
                      title="Trash"
                    >
                      üóëÔ∏è
                    </button>

                    <button
                      onClick={async () => {
                        const btn = event.target.closest("button");
                        btn.disabled = true;
                        btn.textContent = "üîÑ Syncing...";
                        await syncWithBot();
                        btn.textContent = "‚úÖ Synced!";
                        setTimeout(() => {
                          btn.disabled = false;
                          btn.textContent = "üîÑ Sync";
                        }, 1500);
                      }}
                      style={{ backgroundColor: "#5865f2" }}
                      className="px-3 py-2 hover:opacity-90 text-white rounded-lg transition-all text-sm"
                      title="Manually sync with Discord bot"
                    >
                      üîÑ Sync
                    </button>

                    <button
                      onClick={() => setShowHelp(true)}
                      className="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all text-sm"
                      title="Open Help & User Guides"
                    >
                      ‚ùì
                    </button>
                  </div>

                  {/* Line 2: System Tools and Staging */}
                  <div className="flex flex-wrap gap-2 items-center justify-end">
                    {currentUser && USER_CONFIG[currentUser.name]?.isAdmin && (
                      <a
                        href="admin.html"
                        className="px-3 py-1.5 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white rounded-lg font-medium transition-all text-sm"
                        title="Open Admin Panel to customize settings"
                      >
                        ‚öôÔ∏è Admin
                      </a>
                    )}

                    {currentUser &&
                      USER_CONFIG[currentUser.name]?.canBulkImport && (
                        <a
                          href="quick-launch.html"
                          className="px-3 py-1.5 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white rounded-lg font-medium transition-all text-sm"
                          title="Open Quick Launch for bulk CRM task imports"
                        >
                          üöÄ Quick Launch
                        </a>
                      )}

                    {currentUser &&
                      (USER_CONFIG[currentUser.name]?.canViewAnalytics ||
                        USER_CONFIG[currentUser.name]?.isAdmin) && (
                        <a
                          href="reports.html"
                          className="px-3 py-1.5 bg-gradient-to-r from-emerald-600 to-cyan-600 hover:from-emerald-700 hover:to-cyan-700 text-white rounded-lg font-medium transition-all text-sm"
                          title="View Reports & Analytics"
                        >
                          üìä Reports
                        </a>
                      )}

                    {/* Staging Mode Toggle - Enhanced */}
                    <button
                      onClick={() => setStagingMode(!stagingMode)}
                      className={`px-3 py-1.5 ${stagingMode ? "bg-blue-600 hover:bg-blue-700" : "bg-green-600 hover:bg-green-700"} text-white rounded-lg transition-all font-medium text-sm flex items-center gap-2`}
                      title="Toggle staging mode - stage changes before deploying to Discord"
                    >
                      <span
                        className={`inline-block w-10 h-5 rounded-full relative transition-all ${stagingMode ? "bg-blue-400" : "bg-green-400"}`}
                      >
                        <span
                          className={`absolute top-0.5 ${stagingMode ? "right-0.5" : "left-0.5"} w-4 h-4 bg-white rounded-full transition-all shadow-md`}
                        ></span>
                      </span>
                      {stagingMode ? "Staging ON" : "Staging OFF"}
                    </button>

                    {/* Deploy Button - only show when staging mode is ON */}
                    {stagingMode && (
                      <button
                        onClick={handleDeploy}
                        className={`px-3 py-1.5 ${stagedTasks.size > 0 ? "bg-green-600 hover:bg-green-700 animate-pulse" : "bg-gray-600"} text-white rounded-lg transition-all font-bold text-sm`}
                        disabled={stagedTasks.size === 0}
                        title={`Deploy ${stagedTasks.size} staged task${stagedTasks.size !== 1 ? "s" : ""} to Discord`}
                      >
                        üöÄ Deploy ({stagedTasks.size})
                      </button>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* V4-Style Quick Navigation */}
            <div className="glass rounded-xl p-4 mb-4">
              <div className="flex flex-wrap lg:flex-nowrap gap-4">
                {/* Quick Filters - Left */}
                <div className="flex-1">
                  <div className="flex flex-wrap gap-2 items-center">
                    <span className="text-white font-bold text-sm uppercase tracking-wide mr-2">
                      Quick View:
                    </span>
                    <button
                      onClick={() => {
                        setQuickFilter("all");
                        setSearchTerm("");
                        setFilterCategory("all");
                        setFilterPriority("all");
                        setFilterUser("all");
                        showToast("All filters cleared");
                      }}
                      className={`px-4 py-2 ${quickFilter === "all" ? "bg-purple-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      ALL
                    </button>
                    <button
                      onClick={() => {
                        setQuickFilter("today");
                        showToast("Showing today's tasks");
                      }}
                      className={`px-4 py-2 ${quickFilter === "today" ? "bg-blue-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      TODAY
                    </button>
                    <button
                      onClick={() => {
                        setQuickFilter("tomorrow");
                        showToast("Showing tomorrow's tasks");
                      }}
                      className={`px-4 py-2 ${quickFilter === "tomorrow" ? "bg-blue-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      TOMORROW
                    </button>
                    <button
                      onClick={() => {
                        setQuickFilter("this-week");
                        showToast("Showing this week's tasks");
                      }}
                      className={`px-4 py-2 ${quickFilter === "this-week" ? "bg-indigo-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      THIS WEEK
                    </button>
                  </div>
                </div>

                {/* Search and Filters - Center */}
                <div className="flex-shrink-0 px-4 border-x border-white border-opacity-20">
                  <div className="flex flex-wrap gap-2 items-center">
                    <input
                      type="text"
                      placeholder="üîç Search..."
                      value={searchTerm}
                      onChange={(e) => {
                        setSearchTerm(e.target.value);

                        // Debounce the toast to avoid showing on every keystroke
                        if (searchTimeoutRef.current) {
                          clearTimeout(searchTimeoutRef.current);
                        }

                        if (e.target.value.length > 0) {
                          searchTimeoutRef.current = setTimeout(() => {
                            showToast(`Searching for: "${e.target.value}"`);
                          }, 800);
                        }
                      }}
                      className="px-3 py-1.5 bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-60 rounded-lg border border-white border-opacity-30 focus:outline-none focus:border-opacity-60 text-sm"
                    />

                    <select
                      value={filterCategory}
                      onChange={(e) => {
                        setFilterCategory(e.target.value);
                        if (e.target.value !== "all")
                          showToast(`Filtered by category: ${e.target.value}`);
                      }}
                      className="px-3 py-1.5 bg-white bg-opacity-20 text-white rounded-lg border border-white border-opacity-30 focus:outline-none text-sm"
                    >
                      <option value="all" className="glass-panel">
                        All Categories
                      </option>
                      {categories.map((c) => (
                        <option key={c} value={c} className="glass-panel">
                          {c}
                        </option>
                      ))}
                    </select>

                    <select
                      value={filterPriority}
                      onChange={(e) => {
                        setFilterPriority(e.target.value);
                        if (e.target.value !== "all")
                          showToast(`Filtered by priority: ${e.target.value}`);
                      }}
                      className="px-3 py-1.5 bg-white bg-opacity-20 text-white rounded-lg border border-white border-opacity-30 focus:outline-none text-sm"
                    >
                      <option value="all" className="glass-panel">
                        All Priorities
                      </option>
                      <option value="urgent" className="glass-panel">
                        Urgent
                      </option>
                      <option value="high" className="glass-panel">
                        High
                      </option>
                      <option value="medium" className="glass-panel">
                        Medium
                      </option>
                      <option value="low" className="glass-panel">
                        Low
                      </option>
                    </select>

                    <select
                      value={filterUser}
                      onChange={(e) => {
                        setFilterUser(e.target.value);
                        if (e.target.value !== "all")
                          showToast(`Filtered by user: ${e.target.value}`);
                      }}
                      className="px-3 py-1.5 bg-white bg-opacity-20 text-white rounded-lg border border-white border-opacity-30 focus:outline-none text-sm"
                    >
                      <option value="all" className="glass-panel">
                        All Users
                      </option>
                      <option value="Unassigned" className="glass-panel">
                        Unassigned
                      </option>
                      {TEAM_MEMBERS.map((member) => (
                        <option
                          key={member.discordId}
                          value={member.name}
                          className="glass-panel"
                        >
                          {member.name}
                        </option>
                      ))}
                    </select>

                    {/* Hidden file inputs for Export/Import functionality */}
                    <button
                      onClick={exportTasks}
                      className="px-2 py-1.5 bg-white bg-opacity-10 hover:bg-opacity-20 text-white rounded-lg transition-all text-xs"
                      title="Export Tasks to JSON"
                    >
                      üíæ
                    </button>

                    <button
                      onClick={() => fileInputRef.current?.click()}
                      className="px-2 py-1.5 bg-white bg-opacity-10 hover:bg-opacity-20 text-white rounded-lg transition-all text-xs"
                      title="Import Tasks from JSON"
                    >
                      üìÇ
                    </button>
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept=".json"
                      onChange={importTasks}
                      className="hidden"
                    />
                  </div>
                </div>

                {/* Special Views - Right */}
                <div className="flex-shrink-0 pl-4">
                  <div className="flex flex-wrap gap-2 items-center">
                    <span className="text-white font-bold text-sm uppercase tracking-wide mr-2">
                      Special:
                    </span>
                    <button
                      onClick={() => setActiveView("overdue")}
                      className={`px-4 py-2 ${activeView === "overdue" ? "bg-red-600" : overdueTasks.length > 0 ? "bg-red-700 hover:bg-red-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      ‚ö†Ô∏è Overdue
                      {overdueTasks.length > 0 && (
                        <span className="ml-1 px-1.5 py-0.5 bg-white bg-opacity-20 rounded text-xs font-bold">
                          {overdueTasks.length}
                        </span>
                      )}
                    </button>
                    <button
                      onClick={() => setActiveView("starred")}
                      className={`px-4 py-2 ${activeView === "starred" ? "bg-yellow-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      ‚≠ê Starred
                      {starredTasks.length > 0 && (
                        <span className="ml-1 px-1.5 py-0.5 bg-white bg-opacity-20 rounded text-xs font-bold">
                          {starredTasks.length}
                        </span>
                      )}
                    </button>
                    <button
                      onClick={() => setActiveView("completed")}
                      className={`px-4 py-2 ${activeView === "completed" ? "bg-gray-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                    >
                      ‚úÖ Completed
                      {completedTasks.length > 0 && (
                        <span className="ml-1 px-1.5 py-0.5 bg-white bg-opacity-20 rounded text-xs font-bold">
                          {completedTasks.length}
                        </span>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* File Tab Navigation */}
            <div className="mb-0">
              <div className="flex justify-between items-end gap-1 px-2">
                {/* LEFT SIDE TABS */}
                <div className="flex flex-wrap gap-1">
                  {(() => {
                    const userConfig = currentUser
                      ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
                      : DEFAULT_USER_CONFIG;
                    const unreadMentions = mentions.filter(
                      (m) => !m.is_read,
                    ).length;
                    const allTabs = [
                      {
                        id: "incoming",
                        label: "üì• Incoming",
                        count: incomingTasks.length,
                        color: "bg-blue-600",
                        hoverColor: "hover:bg-blue-700",
                      },
                      {
                        id: "my-tasks",
                        label: "üìã My Tasks",
                        count: myTasks.length,
                        color: "bg-purple-600",
                        hoverColor: "hover:bg-purple-700",
                      },
                      {
                        id: "assigned-out",
                        label: "üì§ Assigned Out",
                        count: assignedOutTasks.length,
                        color: "bg-orange-600",
                        hoverColor: "hover:bg-orange-700",
                      },
                      {
                        id: "pool",
                        label: "üèä Pool",
                        count: poolTasks.length,
                        color: "bg-cyan-600",
                        hoverColor: "hover:bg-cyan-700",
                      },
                      {
                        id: "team",
                        label: "üéØ Requests",
                        count: teamTasks.length,
                        color: "bg-green-600",
                        hoverColor: "hover:bg-green-700",
                      },
                      {
                        id: "transfer-requests",
                        label: "üì® Task Requests",
                        count: transferRequests.length,
                        color: "bg-yellow-600",
                        hoverColor: "hover:bg-yellow-700",
                      },
                      {
                        id: "campfire",
                        label: "üî• Campfire",
                        count: campfireTasks.length,
                        color: "bg-red-600",
                        hoverColor: "hover:bg-red-700",
                      },
                      {
                        id: "mentions",
                        label: "üí¨ Mentions",
                        count: mentions.length,
                        color: "bg-pink-600",
                        hoverColor: "hover:bg-pink-700",
                      },
                      {
                        id: "training",
                        label: "üéì Training",
                        count: trainings.length,
                        color: "bg-indigo-600",
                        hoverColor: "hover:bg-indigo-700",
                      },
                    ];

                    // Filter tabs based on user configuration
                    return allTabs
                      .filter((tab) => userConfig.visibleTabs.includes(tab.id))
                      .map((view) => {
                        // Calculate unread count for incoming, campfire, and mentions
                        // FIXED: Show badge for unassigned tasks in both tabs
                        let unreadCount = 0;
                        if (view.id === "incoming") {
                          unreadCount = incomingTasks.filter(
                            (t) =>
                              !t.assignedTo || t.assignedTo === "Unassigned",
                          ).length;
                        } else if (view.id === "campfire") {
                          unreadCount = campfireTasks.filter(
                            (t) =>
                              !t.assignedTo || t.assignedTo === "Unassigned",
                          ).length;
                        } else if (view.id === "mentions") {
                          unreadCount = unreadMentions;
                        }

                        // Debug badge rendering
                        if (view.id === "incoming") {
                          console.log(
                            "üé® Rendering Incoming badge | Total incoming:",
                            view.count,
                            "| Unassigned count:",
                            unreadCount,
                            "| Badge visible:",
                            unreadCount > 0,
                          );
                          console.log(
                            "üìã Unassigned incoming tasks:",
                            incomingTasks
                              .filter(
                                (t) =>
                                  !t.assignedTo ||
                                  t.assignedTo === "Unassigned",
                              )
                              .map((t) => ({
                                id: t.id,
                                name: t.name,
                                assignedTo: t.assignedTo,
                              })),
                          );
                        }
                        if (view.id === "campfire") {
                          console.log(
                            "üî• Rendering Campfire badge | Total campfire:",
                            view.count,
                            "| Unassigned count:",
                            unreadCount,
                            "| Badge visible:",
                            unreadCount > 0,
                          );
                          console.log(
                            "üî• Unassigned campfire tasks:",
                            campfireTasks
                              .filter(
                                (t) =>
                                  !t.assignedTo ||
                                  t.assignedTo === "Unassigned",
                              )
                              .map((t) => ({
                                id: t.id,
                                name: t.name,
                                assignedTo: t.assignedTo,
                              })),
                          );
                        }

                        return (
                          <button
                            key={view.id}
                            onClick={() => setActiveView(view.id)}
                            className={`px-5 py-3 font-medium transition-all relative ${
                              activeView === view.id
                                ? `${view.color} text-white rounded-t-xl border-t-2 border-l-2 border-r-2 border-white border-opacity-30 -mb-px z-10 relative`
                                : `bg-white bg-opacity-10 text-gray-200 rounded-t-lg ${view.hoverColor} hover:text-white`
                            }`}
                            style={
                              activeView === view.id
                                ? { paddingBottom: "14px" }
                                : {}
                            }
                          >
                            {view.label}
                            {view.count > 0 && (
                              <span className="ml-1 px-1.5 py-0.5 bg-white bg-opacity-20 rounded text-xs font-bold">
                                {view.count}
                              </span>
                            )}
                            {/* Small purple notification dot */}
                            {unreadCount > 0 && (
                              <span className="absolute top-2 right-2 w-2 h-2 bg-purple-500 rounded-full border border-white"></span>
                            )}
                          </button>
                        );
                      });
                  })()}
                </div>

                {/* RIGHT SIDE TABS */}
                <div className="flex flex-wrap gap-1">
                  {(() => {
                    const userConfig = currentUser
                      ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
                      : DEFAULT_USER_CONFIG;
                    // Calculate future tasks count
                    const futureTasks = tasks.filter(
                      (t) =>
                        t.status === "active" &&
                        t.isRecurringInstance &&
                        (t.endDate || t.startDate),
                    );

                    const rightTabs = [
                      {
                        id: "future-tasks",
                        label: "üîÆ Future Tasks",
                        count: futureTasks.length,
                        color: "bg-teal-600",
                        hoverColor: "hover:bg-teal-700",
                      },
                      {
                        id: "calendar",
                        label: "üìÖ Calendar",
                        count: 0,
                        color: "bg-indigo-600",
                        hoverColor: "hover:bg-indigo-700",
                      },
                    ];

                    // Filter right tabs based on user configuration and permissions
                    return rightTabs
                      .filter((tab) => {
                        // Check if tab is in visible tabs list
                        if (!userConfig.visibleTabs.includes(tab.id))
                          return false;
                        // Check if tab requires special permission
                        if (
                          tab.requiresPermission &&
                          !userConfig[tab.requiresPermission]
                        )
                          return false;
                        return true;
                      })
                      .map((view) => (
                        <button
                          key={view.id}
                          onClick={() => setActiveView(view.id)}
                          className={`px-5 py-3 font-medium transition-all relative ${
                            activeView === view.id
                              ? `${view.color} text-white rounded-t-xl border-t-2 border-l-2 border-r-2 border-white border-opacity-30 -mb-px z-10 relative`
                              : `bg-white bg-opacity-10 text-gray-200 rounded-t-lg ${view.hoverColor} hover:text-white`
                          }`}
                          style={
                            activeView === view.id
                              ? { paddingBottom: "14px" }
                              : {}
                          }
                        >
                          {view.label}
                          {view.count > 0 && (
                            <span className="ml-1 px-1.5 py-0.5 bg-white bg-opacity-20 rounded text-xs font-bold">
                              {view.count}
                            </span>
                          )}
                        </button>
                      ));
                  })()}
                </div>
              </div>
            </div>

            {/* Main Content - connects to file tabs */}
            <div className="glass rounded-b-2xl rounded-tr-2xl p-6 border-t-2 border-white border-opacity-30">
              {activeView === "calendar" ? (
                <>
                  {/* Calendar Controls - All on one line */}
                  <div className="bg-white bg-opacity-10 backdrop-blur rounded-xl p-5 border border-white border-opacity-20 mb-4">
                    <div className="flex items-center justify-between gap-6 flex-wrap">
                      {/* Date Range - LEFT */}
                      <div className="flex items-center gap-3 flex-1">
                        <label className="text-white text-base font-semibold">
                          Date Range:
                        </label>
                        <input
                          type="date"
                          value={filterDateStart}
                          onChange={(e) => {
                            setFilterDateStart(e.target.value);
                            if (e.target.value)
                              showToast("Date range start set");
                          }}
                          onClick={(e) => e.stopPropagation()}
                          onMouseDown={(e) => e.stopPropagation()}
                          className="px-4 py-2.5 glass-panel text-white border border-white border-opacity-30 rounded-lg text-base focus:ring-2 focus:ring-purple-500 outline-none"
                          placeholder="Start Date"
                        />
                        <span className="text-white text-base font-medium">
                          to
                        </span>
                        <input
                          type="date"
                          value={filterDateEnd}
                          onChange={(e) => {
                            setFilterDateEnd(e.target.value);
                            if (e.target.value) showToast("Date range end set");
                          }}
                          onClick={(e) => e.stopPropagation()}
                          onMouseDown={(e) => e.stopPropagation()}
                          className="px-4 py-2.5 glass-panel text-white border border-white border-opacity-30 rounded-lg text-base focus:ring-2 focus:ring-purple-500 outline-none"
                          placeholder="End Date"
                        />
                        {(filterDateStart || filterDateEnd) && (
                          <button
                            onClick={() => {
                              setFilterDateStart("");
                              setFilterDateEnd("");
                              showToast("Date range cleared");
                            }}
                            className="px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-all font-medium"
                          >
                            Clear
                          </button>
                        )}
                      </div>

                      {/* Separator */}
                      <div className="h-8 w-px bg-white bg-opacity-30"></div>

                      {/* Quick View Buttons - MIDDLE */}
                      <div className="flex gap-2 flex-1 justify-center">
                        <button
                          onClick={() =>
                            setSelectedCalendarDay(dateKeyFromLocal(new Date()))
                          }
                          className="px-4 py-2.5 text-sm rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition-all font-semibold"
                        >
                          Today
                        </button>
                        <button
                          onClick={() => {
                            const d = new Date();
                            d.setDate(d.getDate() + 1);
                            setSelectedCalendarDay(dateKeyFromLocal(d));
                          }}
                          className="px-4 py-2.5 text-sm rounded-lg glass-element hover:bg-white hover:bg-opacity-20 text-white transition-all font-semibold"
                        >
                          Tomorrow
                        </button>
                        <button
                          onClick={() => {
                            const el =
                              document.getElementById("this-week-section");
                            if (el) el.scrollIntoView({ behavior: "smooth" });
                          }}
                          className="px-4 py-2.5 text-sm rounded-lg glass-element hover:bg-white hover:bg-opacity-20 text-white transition-all font-semibold"
                        >
                          This Week
                        </button>
                        <button
                          onClick={() => {
                            const el =
                              document.getElementById("overdue-section");
                            if (el) el.scrollIntoView({ behavior: "smooth" });
                          }}
                          className={`px-4 py-2.5 text-sm rounded-lg ${overdueTasks.length > 0 ? "bg-red-700 hover:bg-red-600" : "glass-element hover:bg-white hover:bg-opacity-20"} text-white transition-all font-semibold`}
                        >
                          Overdue
                        </button>
                      </div>

                      {/* Separator */}
                      <div className="h-8 w-px bg-white bg-opacity-30"></div>

                      {/* Recurring Tasks Filter - RIGHT */}
                      <div className="flex items-center gap-3 flex-1 justify-end">
                        <label className="text-white text-base font-semibold">
                          Recurring Tasks:
                        </label>
                        <select
                          value={recurringFilter}
                          onChange={(e) => setRecurringFilter(e.target.value)}
                          className="px-4 py-2.5 glass-panel text-white border border-white border-opacity-30 rounded-lg text-base focus:ring-2 focus:ring-purple-500 outline-none font-medium"
                        >
                          <option value="none">(none)</option>
                          <option value="this-week">This Week</option>
                          <option value="next-week">Next Week</option>
                          <option value="this-month">This Month</option>
                          <option value="next-month">Next Month</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Recurring Tasks List View - Shows when filter is active */}
                  {recurringFilter !== "none" &&
                    (() => {
                      const now = new Date();
                      now.setHours(0, 0, 0, 0); // Start of today

                      const recurringTasks = tasks.filter((t) => {
                        if (t.status !== "active") return false;
                        if (!t.recurringFrequency && !t.isRecurringInstance)
                          return false;
                        if (!t.endDate && !t.startDate) return false;

                        const taskDate = new Date(t.endDate || t.startDate);
                        taskDate.setHours(0, 0, 0, 0);

                        switch (recurringFilter) {
                          case "this-week":
                            // Start of this week (Sunday)
                            const thisWeekStart = new Date(now);
                            thisWeekStart.setDate(now.getDate() - now.getDay());
                            // End of this week (Saturday)
                            const thisWeekEnd = new Date(thisWeekStart);
                            thisWeekEnd.setDate(thisWeekStart.getDate() + 6);
                            return (
                              taskDate >= thisWeekStart &&
                              taskDate <= thisWeekEnd
                            );
                          case "next-week":
                            // Start of next week (Sunday)
                            const nextWeekStart = new Date(now);
                            nextWeekStart.setDate(
                              now.getDate() - now.getDay() + 7,
                            );
                            // End of next week (Saturday)
                            const nextWeekEnd = new Date(nextWeekStart);
                            nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                            return (
                              taskDate >= nextWeekStart &&
                              taskDate <= nextWeekEnd
                            );
                          case "this-month":
                            // Start of this month
                            const thisMonthStart = new Date(
                              now.getFullYear(),
                              now.getMonth(),
                              1,
                            );
                            // End of this month
                            const thisMonthEnd = new Date(
                              now.getFullYear(),
                              now.getMonth() + 1,
                              0,
                            );
                            return (
                              taskDate >= thisMonthStart &&
                              taskDate <= thisMonthEnd
                            );
                          case "next-month":
                            // Start of next month
                            const nextMonthStart = new Date(
                              now.getFullYear(),
                              now.getMonth() + 1,
                              1,
                            );
                            // End of next month
                            const nextMonthEnd = new Date(
                              now.getFullYear(),
                              now.getMonth() + 2,
                              0,
                            );
                            return (
                              taskDate >= nextMonthStart &&
                              taskDate <= nextMonthEnd
                            );
                          default:
                            return false;
                        }
                      });

                      const filterLabel = {
                        "this-week": "This Week",
                        "next-week": "Next Week",
                        "this-month": "This Month",
                        "next-month": "Next Month",
                      }[recurringFilter];

                      return (
                        <div className="bg-purple-900/30 backdrop-blur rounded-xl border border-purple-700/50 overflow-hidden mb-6">
                          <button
                            onClick={() =>
                              setRecurringListExpanded(!recurringListExpanded)
                            }
                            className="w-full px-6 py-4 bg-purple-900/20 hover:bg-purple-900/30 transition-colors text-left"
                          >
                            <h3 className="text-xl font-bold text-white flex items-center gap-2">
                              <span>{recurringListExpanded ? "‚ñº" : "‚ñ∂"}</span>
                              <span>üîÑ</span>
                              <span>
                                Recurring Tasks - {filterLabel} (
                                {recurringTasks.length})
                              </span>
                            </h3>
                          </button>
                          {recurringListExpanded && (
                            <div className="p-4">
                              {recurringTasks.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                  {recurringTasks.map((task) => (
                                    <TaskCard
                                      key={task.id}
                                      task={task}
                                      isStaged={stagedTasks.has(task.id)}
                                      onEdit={handleEditTask}
                                      onDelete={handleDeleteTask}
                                      onToggleStar={handleToggleStar}
                                      onComplete={handleCompleteTask}
                                      onSave={handleSaveForLater}
                                      onCardClick={(task) =>
                                        setExpandedTask(task)
                                      }
                                      showActions={true}
                                      draggable={false}
                                    />
                                  ))}
                                </div>
                              ) : (
                                <div className="text-center py-8 text-gray-300">
                                  No recurring tasks found for{" "}
                                  {filterLabel.toLowerCase()}
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })()}

                  {/* Two Column Layout: Calendar LEFT, Sections RIGHT */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    {/* LEFT: Calendar */}
                    <div className="bg-white bg-opacity-10 backdrop-blur rounded-xl p-4 border border-white border-opacity-20">
                      <div className="flex items-center justify-between mb-3">
                        <button
                          onClick={() => {
                            const newMonth = new Date(calendarMonth);
                            newMonth.setMonth(newMonth.getMonth() - 1);
                            setCalendarMonth(newMonth);
                          }}
                          className="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 hover:scale-110 text-white rounded-lg text-lg font-bold transition-all shadow-md"
                        >
                          ‚óÄ
                        </button>
                        <h3 className="text-xl font-bold text-white uppercase tracking-wide">
                          {calendarMonth.toLocaleDateString("en-US", {
                            month: "long",
                            year: "numeric",
                          })}
                        </h3>
                        <button
                          onClick={() => {
                            const newMonth = new Date(calendarMonth);
                            newMonth.setMonth(newMonth.getMonth() + 1);
                            setCalendarMonth(newMonth);
                          }}
                          className="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 hover:scale-110 text-white rounded-lg text-lg font-bold transition-all shadow-md"
                        >
                          ‚ñ∂
                        </button>
                      </div>
                      <div className="grid grid-cols-7 text-sm text-gray-200 mb-3 text-center font-bold uppercase tracking-wide">
                        {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(
                          (d, i) => (
                            <div key={i} className="py-2">
                              {d}
                            </div>
                          ),
                        )}
                      </div>
                      <div className="grid grid-cols-7 gap-2">
                        {(() => {
                          const year = calendarMonth.getFullYear();
                          const month = calendarMonth.getMonth();
                          const firstOfMonth = new Date(year, month, 1);
                          const daysInMonth = new Date(
                            year,
                            month + 1,
                            0,
                          ).getDate();
                          const startWeekday = firstOfMonth.getDay();

                          return (
                            <>
                              {Array.from({ length: startWeekday }).map(
                                (_, i) => (
                                  <div key={`empty-${i}`} className="h-20" />
                                ),
                              )}
                              {Array.from({ length: daysInMonth }).map(
                                (_, i) => {
                                  const day = i + 1;
                                  const dateStr = dateKeyFromLocal(
                                    new Date(year, month, day),
                                  );
                                  const today = dateKeyFromLocal(new Date());
                                  const isToday = dateStr === today;
                                  const isSelected =
                                    dateStr === selectedCalendarDay;

                                  // Check if date is in selected range
                                  const isInRange =
                                    (filterDateStart || filterDateEnd) &&
                                    dateStr >=
                                      (filterDateStart || "0000-00-00") &&
                                    dateStr <= (filterDateEnd || "9999-12-31");

                                  const tasksCount = tasks.filter((t) => {
                                    if (t.status === "completed") return false;
                                    if (!t.startDate && !t.endDate)
                                      return false;
                                    return (
                                      t.endDate === dateStr ||
                                      t.startDate === dateStr
                                    );
                                  }).length;
                                  const hasOverdueTasks =
                                    tasks.filter(
                                      (t) =>
                                        t.status !== "completed" &&
                                        t.endDate === dateStr &&
                                        isOverdue(t),
                                    ).length > 0;

                                  return (
                                    <button
                                      key={day}
                                      onClick={() =>
                                        setSelectedCalendarDay(dateStr)
                                      }
                                      className={`h-20 w-full rounded-lg text-base font-semibold transition-all relative shadow-md border-2 ${
                                        isSelected
                                          ? "bg-purple-600 text-white font-bold border-purple-300 shadow-xl scale-105"
                                          : isInRange
                                            ? "bg-yellow-600 bg-opacity-40 text-white font-medium border-yellow-400 shadow-lg"
                                            : isToday
                                              ? "bg-blue-600 text-white font-bold border-blue-300 shadow-xl"
                                              : hasOverdueTasks
                                                ? "bg-red-600 bg-opacity-70 text-white font-medium border-red-400 shadow-lg"
                                                : tasksCount > 0
                                                  ? "bg-white bg-opacity-25 text-white border-white border-opacity-30 hover:bg-opacity-35 hover:scale-105 hover:shadow-lg"
                                                  : "text-gray-200 border-white border-opacity-30 border-opacity-30 hover:bg-white hover:bg-opacity-10 hover:text-white hover:border-opacity-50"
                                      }`}
                                    >
                                      {/* Date number in top-right corner */}
                                      <span className="absolute top-2 right-2 text-lg font-bold">
                                        {day}
                                      </span>

                                      {/* Task count badge in bottom-left corner */}
                                      {tasksCount > 0 && (
                                        <span
                                          className={`absolute bottom-2 left-2 text-xs leading-none px-2 py-1 rounded-full font-bold shadow-md ${
                                            hasOverdueTasks
                                              ? "bg-red-700 text-white border border-red-500"
                                              : "bg-purple-700 text-white border border-purple-500"
                                          }`}
                                        >
                                          {tasksCount}{" "}
                                          {tasksCount === 1 ? "task" : "tasks"}
                                        </span>
                                      )}
                                    </button>
                                  );
                                },
                              )}
                            </>
                          );
                        })()}
                      </div>
                    </div>

                    {/* RIGHT: Sections */}
                    <div className="space-y-4">
                      {/* Selected Date or Date Range Tasks */}
                      {(selectedCalendarDay ||
                        filterDateStart ||
                        filterDateEnd) &&
                        (() => {
                          // Determine if we're showing a single date or a range
                          const isRange = filterDateStart || filterDateEnd;

                          const selectedTasks = tasks.filter((t) => {
                            if (t.status !== "active") return false;
                            if (!t.startDate && !t.endDate) return false;

                            // Apply recurring filter
                            if (recurringFilter !== "all") {
                              const now = new Date();
                              const taskDate = new Date(
                                t.endDate || t.startDate,
                              );

                              switch (recurringFilter) {
                                case "this-week":
                                  const thisWeekEnd = new Date(now);
                                  thisWeekEnd.setDate(
                                    now.getDate() + (7 - now.getDay()),
                                  );
                                  if (taskDate > thisWeekEnd) return false;
                                  break;
                                case "next-week":
                                  const nextWeekStart = new Date(now);
                                  nextWeekStart.setDate(
                                    now.getDate() + (7 - now.getDay()) + 1,
                                  );
                                  const nextWeekEnd = new Date(nextWeekStart);
                                  nextWeekEnd.setDate(
                                    nextWeekStart.getDate() + 6,
                                  );
                                  if (
                                    taskDate < nextWeekStart ||
                                    taskDate > nextWeekEnd
                                  )
                                    return false;
                                  break;
                                case "this-month":
                                  const thisMonthEnd = new Date(
                                    now.getFullYear(),
                                    now.getMonth() + 1,
                                    0,
                                  );
                                  if (taskDate > thisMonthEnd) return false;
                                  break;
                                case "next-month":
                                  const nextMonthStart = new Date(
                                    now.getFullYear(),
                                    now.getMonth() + 1,
                                    1,
                                  );
                                  const nextMonthEnd = new Date(
                                    now.getFullYear(),
                                    now.getMonth() + 2,
                                    0,
                                  );
                                  if (
                                    taskDate < nextMonthStart ||
                                    taskDate > nextMonthEnd
                                  )
                                    return false;
                                  break;
                              }

                              // Only show recurring tasks (either original or instances)
                              if (
                                !t.recurringFrequency &&
                                !t.isRecurringInstance
                              )
                                return false;
                            }

                            const taskStart = t.startDate || t.endDate;
                            const taskEnd = t.endDate || t.startDate;

                            if (isRange) {
                              // Date range filtering
                              const rangeStart =
                                filterDateStart || "0000-00-00";
                              const rangeEnd = filterDateEnd || "9999-12-31";

                              // Task overlaps with range if task end is >= range start AND task start is <= range end
                              return (
                                taskEnd >= rangeStart && taskStart <= rangeEnd
                              );
                            } else {
                              // Single date filtering
                              return (
                                selectedCalendarDay >= taskStart &&
                                selectedCalendarDay <= taskEnd
                              );
                            }
                          });

                          let headerTitle, headerSubtitle;
                          if (isRange) {
                            const startLabel = filterDateStart
                              ? parseDateKey(
                                  filterDateStart,
                                ).toLocaleDateString("en-US", {
                                  month: "short",
                                  day: "numeric",
                                  year: "numeric",
                                })
                              : "Beginning";
                            const endLabel = filterDateEnd
                              ? parseDateKey(filterDateEnd).toLocaleDateString(
                                  "en-US",
                                  {
                                    month: "short",
                                    day: "numeric",
                                    year: "numeric",
                                  },
                                )
                              : "End";
                            headerTitle = "üìÖ Date Range";
                            headerSubtitle = `${startLabel} - ${endLabel}`;
                          } else {
                            const selectedDateObj =
                              parseDateKey(selectedCalendarDay);
                            headerTitle = "üìÜ Selected Date";
                            headerSubtitle = selectedDateObj.toLocaleDateString(
                              "en-US",
                              {
                                weekday: "long",
                                month: "long",
                                day: "numeric",
                              },
                            );
                          }

                          return (
                            <div className="bg-purple-900 bg-opacity-30 backdrop-blur rounded-xl border border-purple-700 overflow-hidden">
                              <div className="px-4 py-3 flex items-center justify-between bg-purple-900 bg-opacity-20">
                                <div>
                                  <h2 className="text-base font-bold text-white">
                                    {headerTitle}
                                  </h2>
                                  <p className="text-xs text-purple-200 mt-0.5">
                                    {headerSubtitle}
                                  </p>
                                </div>
                                {!isRange && (
                                  <button
                                    onClick={() => setSelectedCalendarDay(null)}
                                    className="text-white hover:text-red-400 text-lg transition-all"
                                    title="Clear selection"
                                  >
                                    ‚úï
                                  </button>
                                )}
                              </div>
                              <div className="p-3">
                                {selectedTasks.length > 0 ? (
                                  <div className="space-y-2">
                                    {selectedTasks.map((task) => (
                                      <TaskCard
                                        key={task.id}
                                        task={task}
                                        isStaged={stagedTasks.has(task.id)}
                                        onEdit={handleEditTask}
                                        onDelete={handleDeleteTask}
                                        onToggleStar={handleToggleStar}
                                        onComplete={handleCompleteTask}
                                        onSave={handleSaveForLater}
                                        onAssign={handleAssignTask}
                                        onAssignToOther={handleAssignToOther}
                                        onSendToPool={handleSendToPool}
                                        onCardClick={(task) =>
                                          setExpandedTask(task)
                                        }
                                        assignees={assignees}
                                        showActions={true}
                                        draggable={false}
                                      />
                                    ))}
                                  </div>
                                ) : (
                                  <div className="text-center py-4 text-gray-300 text-sm">
                                    {isRange
                                      ? "No tasks in this date range"
                                      : "No tasks scheduled for this date"}
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })()}

                      {/* Overdue Section */}
                      {overdueTasks.length > 0 && (
                        <div
                          id="overdue-section"
                          className="bg-red-900/30 backdrop-blur rounded-xl border border-red-700/50 overflow-hidden mb-4"
                        >
                          <button
                            onClick={() => setOverdueExpanded(!overdueExpanded)}
                            className="w-full px-4 py-3 flex items-center justify-between text-white hover:bg-red-900/20 transition-all"
                          >
                            <h2 className="text-base font-bold">
                              ‚ö†Ô∏è Overdue Tasks
                            </h2>
                            <div className="flex items-center gap-2">
                              <span className="px-2 py-0.5 bg-red-600 rounded-full text-sm font-bold">
                                {overdueTasks.length}
                              </span>
                              <span className="text-lg">
                                {overdueExpanded ? "‚ñ≤" : "‚ñº"}
                              </span>
                            </div>
                          </button>
                          {overdueExpanded && (
                            <div className="p-3 pt-0 space-y-2">
                              {overdueTasks.map((task) => (
                                <TaskCard
                                  key={task.id}
                                  task={task}
                                  isStaged={stagedTasks.has(task.id)}
                                  onEdit={handleEditTask}
                                  onDelete={handleDeleteTask}
                                  onToggleStar={handleToggleStar}
                                  onComplete={handleCompleteTask}
                                  onSave={handleSaveForLater}
                                  onAssign={handleAssignTask}
                                  onAssignToOther={handleAssignToOther}
                                  onSendToPool={handleSendToPool}
                                  onCardClick={(task) => setExpandedTask(task)}
                                  assignees={assignees}
                                  showActions={true}
                                  draggable={false}
                                />
                              ))}
                            </div>
                          )}
                        </div>
                      )}

                      {/* This Week Section */}
                      {(() => {
                        const today = new Date();
                        const weekRange = [];
                        for (let i = 0; i <= 6; i++) {
                          const d = new Date(today);
                          d.setDate(d.getDate() + i);
                          const ds = dateKeyFromLocal(d);
                          const dayTasks = tasks.filter((t) => {
                            if (t.status !== "active") return false;
                            if (!t.startDate && !t.endDate) return false;
                            const start = t.startDate || t.endDate;
                            const end = t.endDate || t.startDate;
                            return ds >= start && ds <= end;
                          });
                          weekRange.push({
                            dateStr: ds,
                            tasks: dayTasks,
                            count: dayTasks.length,
                          });
                        }

                        return (
                          <div
                            id="this-week-section"
                            className="bg-white bg-opacity-10 backdrop-blur rounded-xl border border-white border-opacity-20 overflow-hidden"
                          >
                            <button
                              onClick={() =>
                                setThisWeekExpanded(!thisWeekExpanded)
                              }
                              className="w-full px-4 py-3 flex items-center justify-between text-white hover:bg-white hover:bg-opacity-10 transition-all"
                            >
                              <h2 className="text-base font-bold">
                                üìÖ This Week
                              </h2>
                              <span className="text-lg">
                                {thisWeekExpanded ? "‚ñ≤" : "‚ñº"}
                              </span>
                            </button>
                            {thisWeekExpanded && (
                              <div className="p-3 pt-0 space-y-2">
                                {weekRange.map((group) => {
                                  const d = parseDateKey(group.dateStr);
                                  const label = d.toLocaleDateString("en-US", {
                                    weekday: "short",
                                    month: "short",
                                    day: "numeric",
                                  });
                                  const isOpen =
                                    openUpcomingDate === group.dateStr;

                                  return (
                                    <div
                                      key={group.dateStr}
                                      className="bg-white bg-opacity-10 rounded-lg overflow-hidden border border-white border-opacity-20"
                                    >
                                      <button
                                        onClick={() =>
                                          setOpenUpcomingDate(
                                            isOpen ? null : group.dateStr,
                                          )
                                        }
                                        className="w-full px-3 py-2 flex items-center justify-between text-white hover:bg-white hover:bg-opacity-10 transition-all text-sm"
                                      >
                                        <span className="font-semibold">
                                          {label}
                                        </span>
                                        <span className="flex items-center gap-2 text-xs">
                                          <span className="px-2 py-0.5 bg-purple-600 rounded-full">
                                            {group.count}
                                          </span>
                                          {isOpen ? "‚ñ≤" : "‚ñº"}
                                        </span>
                                      </button>
                                      {isOpen && group.count > 0 && (
                                        <div className="p-2 space-y-2 bg-black bg-opacity-20">
                                          {group.tasks.map((task) => (
                                            <TaskCard
                                              key={task.id}
                                              task={task}
                                              isStaged={stagedTasks.has(
                                                task.id,
                                              )}
                                              onEdit={handleEditTask}
                                              onDelete={handleDeleteTask}
                                              onToggleStar={handleToggleStar}
                                              onComplete={handleCompleteTask}
                                              onSave={handleSaveForLater}
                                              onAssign={handleAssignTask}
                                              onAssignToOther={
                                                handleAssignToOther
                                              }
                                              onSendToPool={handleSendToPool}
                                              onCardClick={(task) =>
                                                setExpandedTask(task)
                                              }
                                              assignees={assignees}
                                              showActions={true}
                                              draggable={false}
                                            />
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                </>
              ) : activeView === "future-tasks" ? (
                <>
                  {/* Future Tasks View */}
                  <h2 className="text-3xl font-bold text-white mb-6">
                    üîÆ Future Tasks - Forecast
                  </h2>

                  {/* Forecast Filter Buttons */}
                  <div className="bg-white bg-opacity-10 backdrop-blur rounded-xl p-4 border border-white border-opacity-20 mb-4">
                    <div className="flex flex-wrap gap-3 items-center">
                      <span className="text-white font-bold text-sm uppercase tracking-wide">
                        Forecast:
                      </span>
                      <button
                        onClick={() => setForecastFilter("all")}
                        className={`px-4 py-2 ${forecastFilter === "all" ? "bg-teal-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                      >
                        [ALL]
                      </button>
                      <button
                        onClick={() => setForecastFilter("this-week")}
                        className={`px-4 py-2 ${forecastFilter === "this-week" ? "bg-teal-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                      >
                        This Week
                      </button>
                      <button
                        onClick={() => setForecastFilter("next-week")}
                        className={`px-4 py-2 ${forecastFilter === "next-week" ? "bg-teal-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                      >
                        Next Week
                      </button>
                      <button
                        onClick={() => setForecastFilter("this-month")}
                        className={`px-4 py-2 ${forecastFilter === "this-month" ? "bg-teal-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                      >
                        This Month
                      </button>
                      <button
                        onClick={() => setForecastFilter("next-month")}
                        className={`px-4 py-2 ${forecastFilter === "next-month" ? "bg-teal-600" : "bg-slate-700 hover:bg-slate-600"} text-white rounded-lg text-sm font-bold transition-all`}
                      >
                        Next Month
                      </button>

                      <div className="ml-auto flex items-center gap-2">
                        <label className="flex items-center gap-2 text-white font-medium cursor-pointer">
                          <input
                            type="checkbox"
                            checked={showStarredForecast}
                            onChange={(e) =>
                              setShowStarredForecast(e.target.checked)
                            }
                            className="w-4 h-4"
                          />
                          <span>‚≠ê Starred Only</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  {/* Forecasted Tasks Display */}
                  {(() => {
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);

                    const forecastedTasks = tasks.filter((t) => {
                      if (t.status !== "active") return false;
                      if (!t.isRecurringInstance) return false;
                      if (!t.endDate && !t.startDate) return false;
                      if (showStarredForecast && !t.starred) return false;

                      if (forecastFilter === "all") return true;

                      const taskDate = new Date(t.endDate || t.startDate);
                      taskDate.setHours(0, 0, 0, 0);

                      switch (forecastFilter) {
                        case "this-week":
                          const thisWeekStart = new Date(now);
                          thisWeekStart.setDate(now.getDate() - now.getDay());
                          const thisWeekEnd = new Date(thisWeekStart);
                          thisWeekEnd.setDate(thisWeekStart.getDate() + 6);
                          return (
                            taskDate >= thisWeekStart && taskDate <= thisWeekEnd
                          );
                        case "next-week":
                          const nextWeekStart = new Date(now);
                          nextWeekStart.setDate(
                            now.getDate() - now.getDay() + 7,
                          );
                          const nextWeekEnd = new Date(nextWeekStart);
                          nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                          return (
                            taskDate >= nextWeekStart && taskDate <= nextWeekEnd
                          );
                        case "this-month":
                          const thisMonthStart = new Date(
                            now.getFullYear(),
                            now.getMonth(),
                            1,
                          );
                          const thisMonthEnd = new Date(
                            now.getFullYear(),
                            now.getMonth() + 1,
                            0,
                          );
                          return (
                            taskDate >= thisMonthStart &&
                            taskDate <= thisMonthEnd
                          );
                        case "next-month":
                          const nextMonthStart = new Date(
                            now.getFullYear(),
                            now.getMonth() + 1,
                            1,
                          );
                          const nextMonthEnd = new Date(
                            now.getFullYear(),
                            now.getMonth() + 2,
                            0,
                          );
                          return (
                            taskDate >= nextMonthStart &&
                            taskDate <= nextMonthEnd
                          );
                        default:
                          return false;
                      }
                    });

                    const filterLabel = {
                      all: "[ALL]",
                      "this-week": "This Week",
                      "next-week": "Next Week",
                      "this-month": "This Month",
                      "next-month": "Next Month",
                    }[forecastFilter];

                    // Group tasks by seriesId for [ALL] view
                    const groupedTasks = {};
                    if (forecastFilter === "all") {
                      forecastedTasks.forEach((task) => {
                        const key = task.seriesId || task.name;
                        if (!groupedTasks[key]) {
                          groupedTasks[key] = {
                            name: task.name,
                            tasks: [],
                            baseTask: task,
                          };
                        }
                        groupedTasks[key].tasks.push(task);
                      });
                    }

                    const toggleAccordion = (key) => {
                      setOpenAccordions((prev) => {
                        const newSet = new Set(prev);
                        if (newSet.has(key)) {
                          newSet.delete(key);
                        } else {
                          newSet.add(key);
                        }
                        return newSet;
                      });
                    };

                    const handleDeleteAllInstances = (seriesKey) => {
                      if (
                        confirm(
                          `Delete all ${groupedTasks[seriesKey].tasks.length} instances of "${groupedTasks[seriesKey].name}"?`,
                        )
                      ) {
                        const taskIds = groupedTasks[seriesKey].tasks.map(
                          (t) => t.id,
                        );
                        setTasks((prev) =>
                          prev.filter((t) => !taskIds.includes(t.id)),
                        );
                        showNotification(
                          `Deleted all instances of "${groupedTasks[seriesKey].name}"`,
                          "success",
                        );
                      }
                    };

                    return (
                      <div className="bg-teal-900/30 backdrop-blur rounded-xl border border-teal-700/50 overflow-hidden">
                        <div className="px-6 py-4 bg-teal-900/20">
                          <h3 className="text-xl font-bold text-white flex items-center gap-2">
                            <span>üìä</span>
                            <span>
                              Forecast Results - {filterLabel} (
                              {forecastedTasks.length})
                            </span>
                            {showStarredForecast && <span>‚≠ê</span>}
                          </h3>
                        </div>
                        <div className="p-4">
                          {forecastedTasks.length > 0 ? (
                            forecastFilter === "all" ? (
                              // Accordion view for [ALL] filter
                              <div className="space-y-3">
                                {Object.entries(groupedTasks).map(
                                  ([key, group]) => {
                                    const isOpen = openAccordions.has(key);
                                    return (
                                      <div
                                        key={key}
                                        className="glass-panel rounded-xl border border-teal-600/30 overflow-hidden"
                                      >
                                        {/* Accordion Header */}
                                        <div
                                          className="flex items-center justify-between p-4 cursor-pointer hover:glass-element/50 transition-colors"
                                          onClick={() => toggleAccordion(key)}
                                        >
                                          <div className="flex items-center gap-3">
                                            <span className="text-xl">
                                              {isOpen ? "‚ñº" : "‚ñ∂"}
                                            </span>
                                            <h4 className="text-lg font-bold text-white">
                                              {group.name}
                                            </h4>
                                            <span className="px-2 py-1 bg-teal-600 text-white rounded text-sm font-bold">
                                              {group.tasks.length} instances
                                            </span>
                                          </div>
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleDeleteAllInstances(key);
                                            }}
                                            className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-medium transition-colors"
                                          >
                                            üóëÔ∏è Delete All
                                          </button>
                                        </div>

                                        {/* Accordion Content */}
                                        {isOpen && (
                                          <div className="p-4 glass-element border-t border-teal-600/30">
                                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                              {group.tasks
                                                .sort(
                                                  (a, b) =>
                                                    new Date(
                                                      a.endDate || a.startDate,
                                                    ) -
                                                    new Date(
                                                      b.endDate || b.startDate,
                                                    ),
                                                )
                                                .map((task) => (
                                                  <TaskCard
                                                    key={task.id}
                                                    task={task}
                                                    isStaged={stagedTasks.has(
                                                      task.id,
                                                    )}
                                                    onEdit={handleEditTask}
                                                    onDelete={handleDeleteTask}
                                                    onToggleStar={
                                                      handleToggleStar
                                                    }
                                                    onComplete={
                                                      handleCompleteTask
                                                    }
                                                    onSave={handleSaveForLater}
                                                    onAssign={handleAssignTask}
                                                    onAssignToOther={
                                                      handleAssignToOther
                                                    }
                                                    assignees={assignees}
                                                    onCardClick={(task) =>
                                                      setExpandedTask(task)
                                                    }
                                                    showActions={true}
                                                    draggable={false}
                                                  />
                                                ))}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    );
                                  },
                                )}
                              </div>
                            ) : (
                              // Grid view for other filters
                              <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                {forecastedTasks.map((task) => (
                                  <TaskCard
                                    key={task.id}
                                    task={task}
                                    isStaged={stagedTasks.has(task.id)}
                                    onEdit={handleEditTask}
                                    onDelete={handleDeleteTask}
                                    onToggleStar={handleToggleStar}
                                    onComplete={handleCompleteTask}
                                    onSave={handleSaveForLater}
                                    onAssign={handleAssignTask}
                                    onAssignToOther={handleAssignToOther}
                                    assignees={assignees}
                                    onCardClick={(task) =>
                                      setExpandedTask(task)
                                    }
                                    showActions={true}
                                    draggable={false}
                                  />
                                ))}
                              </div>
                            )
                          ) : (
                            <div className="text-center py-8 text-gray-300">
                              No forecasted tasks found for{" "}
                              {filterLabel.toLowerCase()}
                              {showStarredForecast && " (starred)"}
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })()}
                </>
              ) : activeView === "overdue" ? (
                <>
                  {/* Overdue View */}
                  <h2 className="text-3xl font-bold text-white mb-6">
                    ‚ö†Ô∏è Overdue Tasks ({overdueTasks.length})
                  </h2>
                  {overdueTasks.length > 0 ? (
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                      {overdueTasks.map((task) => (
                        <TaskCard
                          key={task.id}
                          task={task}
                          isStaged={stagedTasks.has(task.id)}
                          onEdit={handleEditTask}
                          onDelete={handleDeleteTask}
                          onToggleStar={handleToggleStar}
                          onComplete={handleCompleteTask}
                          onSave={handleSaveForLater}
                          onAssign={handleAssignTask}
                          onAssignToOther={handleAssignToOther}
                          onSendToPool={handleSendToPool}
                          onCardClick={(task) => setExpandedTask(task)}
                          assignees={assignees}
                          showActions={true}
                          draggable={false}
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-20">
                      <div className="text-6xl mb-4">‚úÖ</div>
                      <p className="text-white text-opacity-60 text-xl">
                        No overdue tasks!
                      </p>
                    </div>
                  )}
                </>
              ) : isGridLayout ? (
                /* Dashboard Grid View - Show all categories */
                <div className="dashboard-grid-container">
                  {/* Incoming Tasks */}
                  <div className="dashboard-grid-item glass-element rounded-xl p-4">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      üì• Incoming
                      <span className="text-sm bg-blue-600 px-2 py-1 rounded">
                        {incomingTasks.length}
                      </span>
                    </h3>
                    <div className="view-content space-y-3">
                      {incomingTasks.length > 0 ? (
                        incomingTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            showActions={true}
                            draggable={true}
                          />
                        ))
                      ) : (
                        <div className="text-center py-8 text-gray-300 text-sm">
                          No incoming tasks
                        </div>
                      )}
                    </div>
                  </div>

                  {/* My Tasks */}
                  <div className="dashboard-grid-item glass-element rounded-xl p-4">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      üìã My Tasks
                      <span className="text-sm bg-purple-600 px-2 py-1 rounded">
                        {myTasks.length}
                      </span>
                    </h3>
                    <div className="view-content space-y-3">
                      {myTasks.length > 0 ? (
                        myTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            showActions={true}
                            draggable={true}
                          />
                        ))
                      ) : (
                        <div className="text-center py-8 text-gray-300 text-sm">
                          No tasks
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Assigned Out */}
                  <div className="dashboard-grid-item glass-element rounded-xl p-4">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      üì§ Assigned Out
                      <span className="text-sm bg-orange-600 px-2 py-1 rounded">
                        {assignedOutTasks.length}
                      </span>
                    </h3>
                    <div className="view-content space-y-3">
                      {assignedOutTasks.length > 0 ? (
                        assignedOutTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            showActions={true}
                            draggable={true}
                          />
                        ))
                      ) : (
                        <div className="text-center py-8 text-gray-300 text-sm">
                          No assigned out tasks
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Pool Tasks */}
                  <div className="dashboard-grid-item glass-element rounded-xl p-4">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      üèä Pool
                      <span className="text-sm bg-cyan-600 px-2 py-1 rounded">
                        {poolTasks.length}
                      </span>
                    </h3>
                    <div className="view-content space-y-3">
                      {poolTasks.length > 0 ? (
                        poolTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            showActions={true}
                            draggable={true}
                          />
                        ))
                      ) : (
                        <div className="text-center py-8 text-gray-300 text-sm">
                          No pool tasks
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Campfire */}
                  <div className="dashboard-grid-item glass-element rounded-xl p-4">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      üî• Campfire
                      <span className="text-sm bg-red-600 px-2 py-1 rounded">
                        {campfireTasks.length}
                      </span>
                    </h3>
                    <div className="view-content space-y-3">
                      {campfireTasks.length > 0 ? (
                        campfireTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            showActions={true}
                            draggable={true}
                          />
                        ))
                      ) : (
                        <div className="text-center py-8 text-gray-300 text-sm">
                          No campfire tasks
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Requests */}
                  <div className="dashboard-grid-item glass-element rounded-xl p-4">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      üéØ Requests
                      <span className="text-sm bg-green-600 px-2 py-1 rounded">
                        {teamTasks.length}
                      </span>
                    </h3>
                    <div className="view-content space-y-3">
                      {teamTasks.length > 0 ? (
                        teamTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            showActions={true}
                            draggable={true}
                          />
                        ))
                      ) : (
                        <div className="text-center py-8 text-gray-300 text-sm">
                          No requests
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ) : (
                <div
                  className="drop-zone space-y-4 view-content"
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                  onDrop={(e) => handleDrop(e, activeView)}
                >
                  {/* Working On Accordion - Shows ABOVE My Tasks when My Tasks is expanded */}
                  {activeView === "my-tasks" &&
                    myTasksExpanded &&
                    (() => {
                      const workingOnTasks = myTasks.filter((t) => t.workingOn);
                      return (
                        <div className="bg-green-900/30 backdrop-blur rounded-xl border border-green-700/50 overflow-hidden mb-6">
                          <button
                            onClick={() =>
                              setWorkingOnExpanded(!workingOnExpanded)
                            }
                            className="w-full px-6 py-4 flex items-center justify-between text-white hover:bg-green-900/20 transition-all"
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-2xl">üéØ</span>
                              <span className="text-xl font-bold">
                                WORKING ON ({workingOnTasks.length})
                              </span>
                            </div>
                            <span className="text-2xl">
                              {workingOnExpanded ? "‚ñ≤" : "‚ñº"}
                            </span>
                          </button>
                          {workingOnExpanded && (
                            <div
                              className="p-6 drop-zone"
                              onDragOver={handleDragOver}
                              onDragLeave={handleDragLeave}
                              onDrop={(e) => {
                                e.preventDefault();
                                e.currentTarget.classList.remove("drag-over");
                                const taskId = parseInt(
                                  e.dataTransfer.getData("taskId"),
                                );
                                const task = tasks.find((t) => t.id === taskId);
                                if (task) {
                                  setTasks((prev) =>
                                    prev.map((t) =>
                                      t.id === taskId
                                        ? { ...t, workingOn: true }
                                        : t,
                                    ),
                                  );
                                  showNotification(
                                    `Task set as working on`,
                                    "success",
                                  );
                                }
                              }}
                            >
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {workingOnTasks.length > 0 ? (
                                  workingOnTasks.map((task) => (
                                    <TaskCard
                                      key={task.id}
                                      task={task}
                                      isStaged={stagedTasks.has(task.id)}
                                      onEdit={handleEditTask}
                                      onDelete={handleDeleteTask}
                                      onToggleStar={handleToggleStar}
                                      onComplete={handleCompleteTask}
                                      onSave={handleSaveForLater}
                                      onAssign={handleAssignTask}
                                      onAssignToOther={handleAssignToOther}
                                      onSendToPool={handleSendToPool}
                                      onCardClick={(task) =>
                                        setExpandedTask(task)
                                      }
                                      onWorkingOn={(taskId) => {
                                        setTasks((prev) =>
                                          prev.map((t) =>
                                            t.id === taskId
                                              ? {
                                                  ...t,
                                                  workingOn: !t.workingOn,
                                                }
                                              : t,
                                          ),
                                        );
                                      }}
                                      showActions={true}
                                      draggable={true}
                                    />
                                  ))
                                ) : (
                                  <div className="text-center py-8 text-gray-300 text-sm col-span-full">
                                    Drag tasks here to mark as working on
                                  </div>
                                )}
                              </div>
                              {workingOnTasks.length > 0 && (
                                <button
                                  onClick={() => {
                                    setTasks((prev) =>
                                      prev.map((t) =>
                                        t.workingOn
                                          ? { ...t, workingOn: false }
                                          : t,
                                      ),
                                    );
                                    showNotification(
                                      "Cleared working on tasks",
                                      "info",
                                    );
                                  }}
                                  className="mt-4 px-4 py-2 glass-element hover:bg-white hover:bg-opacity-20 text-white rounded-lg text-sm transition-all"
                                >
                                  Clear All
                                </button>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })()}

                  {/* My Tasks Accordion */}
                  {activeView === "my-tasks" &&
                    (() => {
                      const myTasksNoDates = myTasks.filter(
                        (t) => !t.startDate && !t.endDate,
                      );
                      return (
                        <div className="bg-purple-900/30 backdrop-blur rounded-xl border border-purple-700/50 overflow-hidden mb-6">
                          <button
                            onClick={() => setMyTasksExpanded(!myTasksExpanded)}
                            className="w-full px-6 py-4 flex items-center justify-between text-white hover:bg-purple-900/20 transition-all"
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-2xl">üìã</span>
                              <span className="text-xl font-bold">
                                MY TASKS ({myTasksNoDates.length})
                              </span>
                            </div>
                            <span className="text-2xl">
                              {myTasksExpanded ? "‚ñ≤" : "‚ñº"}
                            </span>
                          </button>
                        </div>
                      );
                    })()}

                  {/* Other Views Heading */}
                  {activeView !== "my-tasks" && (
                    <div className="mb-6">
                      <div className="flex items-center justify-between">
                        <h2 className="text-3xl font-bold text-white">
                          {activeView === "incoming" &&
                            `üì• Incoming Requests (${incomingTasks.length})`}
                          {activeView === "assigned-out" &&
                            `üì§ Assigned Out (${assignedOutTasks.length})`}
                          {activeView === "pool" &&
                            `üèä Pool (${poolTasks.length})`}
                          {activeView === "team" &&
                            `üéØ Requests (${teamTasks.length})`}
                          {activeView === "transfer-requests" &&
                            `üîÑ Transfer Requests (${transferRequests.length})`}
                          {activeView === "campfire" &&
                            `üî• Campfire (${campfireTasks.length})`}
                          {activeView === "mentions" &&
                            `üí¨ Mentions (${mentions.length})`}
                          {activeView === "starred" &&
                            `‚≠ê Starred (${starredTasks.length})`}
                          {activeView === "completed" && (
                            <span>
                              ‚úÖ Completed ({completedTasks.length})
                              {userConfig.canViewAllCompleted && (
                                <span className="text-sm text-gray-300 ml-2">
                                  (All users)
                                </span>
                              )}
                              {!userConfig.canViewAllCompleted && (
                                <span className="text-sm text-gray-300 ml-2">
                                  (My tasks)
                                </span>
                              )}
                            </span>
                          )}
                        </h2>
                        {/* Team Activity Toggle - only visible for users with permission */}
                        {activeView === "assigned-out" &&
                          userConfig.canViewTeamActivity && (
                            <div className="flex gap-3 items-center">
                              <button
                                onClick={() =>
                                  setShowTeamActivity(!showTeamActivity)
                                }
                                className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                                  showTeamActivity
                                    ? "bg-orange-600 hover:bg-orange-700 text-white"
                                    : "bg-purple-900 bg-opacity-30 hover:bg-opacity-50 text-purple-200"
                                }`}
                              >
                                {showTeamActivity
                                  ? "üë• Team Activity"
                                  : "üì§ My Assigned Out"}
                              </button>
                              <select
                                value={assignedByFilter}
                                onChange={(e) =>
                                  setAssignedByFilter(e.target.value)
                                }
                                className="px-3 py-2 text-white rounded-lg focus:border-blue-500 focus:outline-none text-sm font-medium"
                              >
                                <option value="all">All Assignments</option>
                                <option value="me">üì§ Assigned by Me</option>
                                <option value="others">
                                  üë• Assigned by Others
                                </option>
                              </select>
                            </div>
                          )}
                      </div>
                    </div>
                  )}

                  {(() => {
                    // Special view for Mentions
                    if (activeView === "mentions") {
                      return (
                        <div className="space-y-4">
                          {mentions.length === 0 ? (
                            <div className="text-center py-20">
                              <div className="text-6xl mb-4">üí¨</div>
                              <p className="text-white text-opacity-60 text-xl">
                                No mentions yet
                              </p>
                              <p className="text-white text-opacity-40 text-sm mt-2">
                                You'll see @mentions, replies, and role pings
                                here
                              </p>
                            </div>
                          ) : (
                            mentions.map((mention) => (
                              <div
                                key={mention.id}
                                className={`glass rounded-xl p-4 border ${mention.is_read ? "border-white border-opacity-30" : "border-pink-500 border-2"} hover:bg-white hover:bg-opacity-5 transition-all`}
                              >
                                <div className="flex items-start justify-between gap-4">
                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-pink-400 font-semibold">
                                        {mention.mention_type ===
                                          "direct_mention" && "üë§ Mentioned by"}
                                        {mention.mention_type === "reply" &&
                                          "üí¨ Reply from"}
                                        {mention.mention_type ===
                                          "role_mention" &&
                                          "üë• Role mention by"}
                                        {mention.mention_type === "everyone" &&
                                          "üì¢ @everyone from"}
                                      </span>
                                      <span className="text-white font-bold">
                                        {mention.author_name}
                                      </span>
                                      {!mention.is_read && (
                                        <span className="px-2 py-1 bg-pink-600 text-white text-xs rounded-full font-bold">
                                          NEW
                                        </span>
                                      )}
                                    </div>
                                    <div className="text-gray-200 mb-2">
                                      <span className="text-sm text-gray-300">
                                        in #{mention.channel_name}
                                      </span>
                                    </div>
                                    <div className="glass-panel bg-opacity-50 rounded-lg p-3 mb-3">
                                      <p className="text-white break-words">
                                        {mention.message_content}
                                      </p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                      <a
                                        href={mention.message_link}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-blue-400 hover:text-blue-300 text-sm hover:underline"
                                      >
                                        üîó Jump to message
                                      </a>
                                      {!mention.is_read && (
                                        <button
                                          onClick={() =>
                                            markMentionAsRead(mention.id)
                                          }
                                          className="text-sm px-3 py-1 bg-pink-600 hover:bg-pink-700 text-white rounded-lg transition-all"
                                        >
                                          Mark as read
                                        </button>
                                      )}
                                      <span className="text-xs text-gray-500 ml-auto">
                                        {new Date(
                                          mention.created_at,
                                        ).toLocaleString()}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      );
                    }

                    // Transfer Requests View - handle BEFORE viewTasks
                    if (activeView === "transfer-requests") {
                      return (
                        <div className="space-y-6">
                          <div className="bg-yellow-900 bg-opacity-20 backdrop-blur rounded-xl p-6 border-2 border-yellow-600 border-opacity-50">
                            <h3 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                              <span>üîÑ</span>
                              <span>Transfer Requests</span>
                              <span className="text-sm font-normal text-gray-200">
                                ({transferRequests.length})
                              </span>
                            </h3>
                            <p className="text-gray-300 mb-4">
                              Review and approve or deny task transfer requests
                              from team members.
                            </p>

                            {transferRequests.length === 0 ? (
                              <div className="text-center text-gray-400 py-12">
                                <p className="text-6xl mb-4">‚ú®</p>
                                <p className="text-xl">
                                  No pending transfer requests
                                </p>
                              </div>
                            ) : (
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {transferRequests.map((task) => (
                                  <TaskCard
                                    key={task.id}
                                    task={task}
                                    isStaged={stagedTasks.has(task.id)}
                                    onEdit={handleEditTask}
                                    onDelete={handleDeleteTask}
                                    onToggleStar={handleToggleStar}
                                    onComplete={handleCompleteTask}
                                    onSave={handleSaveForLater}
                                    onAcceptTransfer={handleAcceptTransfer}
                                    onDenyTransfer={handleDenyTransfer}
                                    onWorkingOn={handleToggleWorkingOn}
                                    onShowUpdates={handleShowUpdateModal}
                                    currentUser={currentUser}
                                    assignees={assignees}
                                    showActions={true}
                                    draggable={false}
                                  />
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    }

                    // Training View
                    if (activeView === "training") {
                      return (
                        <div className="space-y-6">
                          <div className="bg-indigo-900 bg-opacity-20 backdrop-blur rounded-xl p-6 border-2 border-indigo-600 border-opacity-50">
                            <h3 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                              <span>üéì</span>
                              <span>Training Records</span>
                              <span className="text-sm font-normal text-gray-200">
                                ({trainings.length})
                              </span>
                            </h3>
                            <p className="text-gray-300 mb-4">
                              View training sessions and attendance records.
                            </p>

                            {trainings.length === 0 ? (
                              <div className="text-center text-gray-400 py-12">
                                <p className="text-6xl mb-4">üéì</p>
                                <p className="text-xl">
                                  No training sessions yet
                                </p>
                                <p className="text-sm text-gray-500 mt-2">
                                  Use @training-create in Discord to create a
                                  training session
                                </p>
                              </div>
                            ) : (
                              <div className="space-y-4">
                                {trainings.map((training) => (
                                  <div
                                    key={training.id}
                                    className="glass-panel rounded-xl p-6 border border-indigo-500 border-opacity-30 hover:bg-white hover:bg-opacity-5 transition-all"
                                  >
                                    <div className="flex items-start justify-between gap-4 mb-4">
                                      <div className="flex-1">
                                        <h4 className="text-xl font-bold text-white mb-2">
                                          {training.title}
                                        </h4>
                                        <div className="flex items-center gap-4 text-sm text-gray-300 mb-2">
                                          <span>üìÖ {training.date}</span>
                                          {training.presenter && (
                                            <span>üë§ {training.presenter}</span>
                                          )}
                                          {training.category && (
                                            <span className="px-2 py-1 bg-indigo-600 rounded text-xs">
                                              {training.category}
                                            </span>
                                          )}
                                        </div>
                                        {training.notes && (
                                          <p className="text-gray-200 mb-3">
                                            {training.notes}
                                          </p>
                                        )}
                                      </div>
                                    </div>

                                    {training.attendees &&
                                      training.attendees.length > 0 && (
                                        <div className="border-t border-white border-opacity-20 pt-4">
                                          <h5 className="text-sm font-semibold text-gray-300 mb-2">
                                            Attendance (
                                            {training.attendees.length})
                                          </h5>
                                          <div className="flex flex-wrap gap-2">
                                            {training.attendees.map(
                                              (attendee, idx) => (
                                                <span
                                                  key={idx}
                                                  className="px-3 py-1 bg-indigo-600 bg-opacity-40 rounded-full text-sm text-white"
                                                >
                                                  {attendee.name}
                                                </span>
                                              ),
                                            )}
                                          </div>
                                        </div>
                                      )}

                                    <div className="mt-4 flex items-center gap-4">
                                      <button
                                        onClick={() => {
                                          fetch(
                                            `http://localhost:5000/api/trainings/${training.id}/signin`,
                                            {
                                              method: "POST",
                                              headers: {
                                                "Content-Type":
                                                  "application/json",
                                              },
                                              body: JSON.stringify({
                                                attendee_name:
                                                  currentUser?.name ||
                                                  "Unknown",
                                                attendee_id:
                                                  currentUser?.id || 0,
                                              }),
                                            },
                                          )
                                            .then((res) => res.json())
                                            .then((data) => {
                                              if (data.success) {
                                                showNotification(
                                                  "‚úÖ Signed in to training!",
                                                  "success",
                                                );
                                                // Refresh trainings
                                                fetch(
                                                  "http://localhost:5000/api/trainings",
                                                )
                                                  .then((res) => res.json())
                                                  .then((data) =>
                                                    setTrainings(
                                                      data.trainings || [],
                                                    ),
                                                  )
                                                  .catch((err) =>
                                                    console.error(
                                                      "Error refreshing trainings:",
                                                      err,
                                                    ),
                                                  );
                                              } else {
                                                showNotification(
                                                  data.error ||
                                                    "Failed to sign in",
                                                  "error",
                                                );
                                              }
                                            })
                                            .catch((err) => {
                                              console.error(
                                                "Error signing in:",
                                                err,
                                              );
                                              showNotification(
                                                "Error signing in to training",
                                                "error",
                                              );
                                            });
                                        }}
                                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-all text-sm font-medium"
                                      >
                                        ‚úçÔ∏è Sign In
                                      </button>
                                      <span className="text-xs text-gray-500">
                                        Created{" "}
                                        {new Date(
                                          training.created_at,
                                        ).toLocaleDateString()}
                                      </span>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    }

                    const viewTasks = {
                      incoming: incomingTasks,
                      "my-tasks": myTasks,
                      "assigned-out": assignedOutTasks,
                      pool: poolTasks,
                      team: teamTasks,
                      campfire: campfireTasks,
                      starred: starredTasks,
                      completed: completedTasks,
                    }[activeView];

                    // Hide content if My Tasks accordion is collapsed
                    if (activeView === "my-tasks" && !myTasksExpanded) {
                      return null;
                    }

                    if (!viewTasks || viewTasks.length === 0) {
                      return (
                        <div className="text-center py-20">
                          <div className="text-6xl mb-4">
                            {activeView === "campfire" && "üî•"}
                            {activeView === "incoming" && "üì•"}
                            {activeView === "my-tasks" && "üìã"}
                            {activeView === "starred" && "‚≠ê"}
                            {activeView === "pool" && "üèä"}
                            {activeView === "team" && "üéØ"}
                            {activeView === "completed" && "‚úÖ"}
                          </div>
                          <p className="text-white text-opacity-60 text-xl">
                            No tasks here
                          </p>
                          {activeView === "campfire" && (
                            <p className="text-white text-opacity-40 text-sm mt-2">
                              React with üî• in Discord to create private
                              requests
                            </p>
                          )}
                        </div>
                      );
                    }

                    // Special layout for Pool with assignee drop zones
                    if (activeView === "pool") {
                      const assignees = [
                        "Person 1",
                        "Person 2",
                        "Person 3",
                        "Person 4",
                      ];
                      const unassignedTasks = viewTasks.filter(
                        (t) => !t.assignee || !assignees.includes(t.assignee),
                      );

                      return (
                        <div className="space-y-6">
                          {/* Unassigned Task Pool - Drop Zone */}
                          <div
                            className="bg-white bg-opacity-10 backdrop-blur rounded-xl p-6 border border-white border-opacity-20 drop-zone"
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={(e) => {
                              e.preventDefault();
                              e.currentTarget.classList.remove("drag-over");
                              const taskId = parseInt(
                                e.dataTransfer.getData("taskId"),
                              );
                              const task = tasks.find((t) => t.id === taskId);
                              if (task) {
                                setTasks((prev) =>
                                  prev.map((t) =>
                                    t.id === taskId
                                      ? {
                                          ...t,
                                          assignee: null,
                                          isPoolRequest: true,
                                        }
                                      : t,
                                  ),
                                );
                                showNotification(
                                  `Task returned to pool`,
                                  "info",
                                );
                              }
                            }}
                          >
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                              <span>üì¶</span>
                              <span>Task Pool (Drag to Assign)</span>
                              <span className="text-sm font-normal text-gray-200">
                                ({unassignedTasks.length})
                              </span>
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                              {unassignedTasks.map((task) => (
                                <TaskCard
                                  key={task.id}
                                  task={task}
                                  isStaged={stagedTasks.has(task.id)}
                                  onEdit={handleEditTask}
                                  onDelete={handleDeleteTask}
                                  onToggleStar={handleToggleStar}
                                  onComplete={handleCompleteTask}
                                  onSave={handleSaveForLater}
                                  onAssign={handleAssignTask}
                                  onAssignToOther={handleAssignToOther}
                                  onSendToPool={handleSendToPool}
                                  onClaimPool={handleClaimPoolTask}
                                  onWorkingOn={handleToggleWorkingOn}
                                  onShowUpdates={handleShowUpdateModal}
                                  onCardClick={(task) => setExpandedTask(task)}
                                  currentUser={currentUser}
                                  assignees={assignees}
                                  showActions={true}
                                  draggable={true}
                                />
                              ))}
                            </div>
                          </div>

                          {/* Assignee Drop Zones */}
                          <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                            {assignees.map((assignee) => {
                              const assigneeTasks = viewTasks.filter(
                                (t) => t.assignee === assignee,
                              );
                              return (
                                <div
                                  key={assignee}
                                  className="drop-zone bg-cyan-900 bg-opacity-20 backdrop-blur rounded-xl p-4 border-2 border-cyan-700 border-opacity-50 min-h-[200px]"
                                  onDragOver={handleDragOver}
                                  onDragLeave={handleDragLeave}
                                  onDrop={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.remove(
                                      "drag-over",
                                    );
                                    const taskId = parseInt(
                                      e.dataTransfer.getData("taskId"),
                                    );
                                    const task = tasks.find(
                                      (t) => t.id === taskId,
                                    );
                                    if (task) {
                                      setTasks((prev) =>
                                        prev.map((t) =>
                                          t.id === taskId
                                            ? {
                                                ...t,
                                                assignee,
                                                isPoolRequest: true,
                                              }
                                            : t,
                                        ),
                                      );
                                      showNotification(
                                        `Task assigned to ${assignee}`,
                                        "success",
                                      );
                                    }
                                  }}
                                >
                                  <h4 className="text-lg font-bold text-white mb-3 flex items-center justify-between">
                                    <span>{assignee}</span>
                                    <span className="text-sm font-normal bg-cyan-600 px-2 py-1 rounded-full">
                                      {assigneeTasks.length}
                                    </span>
                                  </h4>
                                  <div className="space-y-3">
                                    {assigneeTasks.length > 0 ? (
                                      assigneeTasks.map((task) => (
                                        <TaskCard
                                          key={task.id}
                                          task={task}
                                          isStaged={stagedTasks.has(task.id)}
                                          onEdit={handleEditTask}
                                          onDelete={handleDeleteTask}
                                          onToggleStar={handleToggleStar}
                                          onComplete={handleCompleteTask}
                                          onSave={handleSaveForLater}
                                          onAssign={handleAssignTask}
                                          onAssignToOther={handleAssignToOther}
                                          onSendToPool={handleSendToPool}
                                          onCardClick={(task) =>
                                            setExpandedTask(task)
                                          }
                                          assignees={assignees}
                                          showActions={true}
                                          draggable={true}
                                        />
                                      ))
                                    ) : (
                                      <div className="text-center py-8 text-gray-300 text-sm">
                                        Drag tasks here to assign
                                      </div>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    }

                    // Special layout for Team Requests with assignee drop zones
                    if (activeView === "team") {
                      const assignees = [
                        "Person 1",
                        "Person 2",
                        "Person 3",
                        "Person 4",
                      ];
                      const unassignedTasks = viewTasks.filter(
                        (t) => !t.assignee || !assignees.includes(t.assignee),
                      );

                      return (
                        <div className="space-y-6">
                          {/* Unassigned Task Pool */}
                          <div className="bg-white bg-opacity-10 backdrop-blur rounded-xl p-6 border border-white border-opacity-20">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                              <span>üì¶</span>
                              <span>Task Pool (Drag to Assign)</span>
                              <span className="text-sm font-normal text-gray-200">
                                ({unassignedTasks.length})
                              </span>
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                              {unassignedTasks.map((task) => (
                                <TaskCard
                                  key={task.id}
                                  task={task}
                                  isStaged={stagedTasks.has(task.id)}
                                  onEdit={handleEditTask}
                                  onDelete={handleDeleteTask}
                                  onToggleStar={handleToggleStar}
                                  onComplete={handleCompleteTask}
                                  onSave={handleSaveForLater}
                                  onAssign={handleAssignTask}
                                  onAssignToOther={handleAssignToOther}
                                  onSendToPool={handleSendToPool}
                                  onClaimPool={handleClaimPoolTask}
                                  onWorkingOn={handleToggleWorkingOn}
                                  onShowUpdates={handleShowUpdateModal}
                                  onCardClick={(task) => setExpandedTask(task)}
                                  currentUser={currentUser}
                                  assignees={assignees}
                                  showActions={true}
                                  draggable={true}
                                />
                              ))}
                            </div>
                          </div>

                          {/* Assignee Drop Zones */}
                          <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                            {assignees.map((assignee) => {
                              const assigneeTasks = viewTasks.filter(
                                (t) => t.assignee === assignee,
                              );
                              return (
                                <div
                                  key={assignee}
                                  className="drop-zone bg-purple-900 bg-opacity-20 backdrop-blur rounded-xl p-4 border-2 border-purple-700 border-opacity-50 min-h-[200px]"
                                  onDragOver={handleDragOver}
                                  onDragLeave={handleDragLeave}
                                  onDrop={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.remove(
                                      "drag-over",
                                    );
                                    const taskId = parseInt(
                                      e.dataTransfer.getData("taskId"),
                                    );
                                    const task = tasks.find(
                                      (t) => t.id === taskId,
                                    );
                                    if (task) {
                                      setTasks((prev) =>
                                        prev.map((t) =>
                                          t.id === taskId
                                            ? {
                                                ...t,
                                                assignee,
                                                isTeamRequest: true,
                                              }
                                            : t,
                                        ),
                                      );
                                      showNotification(
                                        `Task assigned to ${assignee}`,
                                        "success",
                                      );
                                    }
                                  }}
                                >
                                  <h4 className="text-lg font-bold text-white mb-3 flex items-center justify-between">
                                    <span>üë§ {assignee}</span>
                                    <span className="text-sm font-normal text-purple-300">
                                      ({assigneeTasks.length})
                                    </span>
                                  </h4>
                                  <div className="space-y-3">
                                    {assigneeTasks.map((task) => (
                                      <TaskCard
                                        key={task.id}
                                        task={task}
                                        onEdit={handleEditTask}
                                        onDelete={handleDeleteTask}
                                        onToggleStar={handleToggleStar}
                                        onComplete={handleCompleteTask}
                                        onSave={handleSaveForLater}
                                        onAssign={handleAssignTask}
                                        onAssignToOther={handleAssignToOther}
                                        onSendToPool={handleSendToPool}
                                        onCardClick={(task) =>
                                          setExpandedTask(task)
                                        }
                                        assignees={assignees}
                                        showActions={true}
                                        draggable={true}
                                      />
                                    ))}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    }

                    // Special layout for My Tasks
                    if (activeView === "my-tasks") {
                      // Exclude recurring instances from scheduled - they only show on calendar
                      const tasksWithDates = viewTasks.filter(
                        (t) =>
                          (t.startDate || t.endDate) && !t.isRecurringInstance,
                      );
                      const tasksNoDates = viewTasks.filter(
                        (t) => !t.startDate && !t.endDate,
                      );
                      const regularTasks = tasksNoDates.filter(
                        (t) => !t.workingOn,
                      );

                      return (
                        <>
                          {/* Regular Tasks (No Due Date) - Just show in grid */}
                          {regularTasks.length > 0 && (
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 mb-6">
                              {regularTasks.map((task) => (
                                <TaskCard
                                  key={task.id}
                                  task={task}
                                  isStaged={stagedTasks.has(task.id)}
                                  onEdit={handleEditTask}
                                  onDelete={handleDeleteTask}
                                  onToggleStar={handleToggleStar}
                                  onComplete={handleCompleteTask}
                                  onSave={handleSaveForLater}
                                  onAssign={handleAssignTask}
                                  onAssignToOther={handleAssignToOther}
                                  onSendToPool={handleSendToPool}
                                  onCardClick={(task) => setExpandedTask(task)}
                                  onWorkingOn={(taskId) => {
                                    setTasks((prev) =>
                                      prev.map((t) =>
                                        t.id === taskId
                                          ? { ...t, workingOn: !t.workingOn }
                                          : t,
                                      ),
                                    );
                                  }}
                                  showActions={true}
                                  draggable={true}
                                />
                              ))}
                            </div>
                          )}

                          {/* Scheduled Tasks - Separate Accordion */}
                          {tasksWithDates.length > 0 && (
                            <div className="bg-blue-900/30 backdrop-blur rounded-xl border border-blue-700/50 overflow-hidden mb-6">
                              <button
                                onClick={() =>
                                  setScheduledTasksExpanded(
                                    !scheduledTasksExpanded,
                                  )
                                }
                                className="w-full px-6 py-4 flex items-center justify-between text-white hover:bg-blue-900/20 transition-all"
                              >
                                <div className="flex items-center gap-3">
                                  <span className="text-2xl">üìÖ</span>
                                  <span className="text-xl font-bold">
                                    MY SCHEDULED TASKS ({tasksWithDates.length})
                                  </span>
                                </div>
                                <span className="text-2xl">
                                  {scheduledTasksExpanded ? "‚ñ≤" : "‚ñº"}
                                </span>
                              </button>
                              {scheduledTasksExpanded && (
                                <div className="p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                  {tasksWithDates.map((task) => (
                                    <TaskCard
                                      key={task.id}
                                      task={task}
                                      isStaged={stagedTasks.has(task.id)}
                                      onEdit={handleEditTask}
                                      onDelete={handleDeleteTask}
                                      onToggleStar={handleToggleStar}
                                      onComplete={handleCompleteTask}
                                      onSave={handleSaveForLater}
                                      onAssign={handleAssignTask}
                                      onAssignToOther={handleAssignToOther}
                                      onSendToPool={handleSendToPool}
                                      onCardClick={(task) =>
                                        setExpandedTask(task)
                                      }
                                      onWorkingOn={(taskId) => {
                                        setTasks((prev) =>
                                          prev.map((t) =>
                                            t.id === taskId
                                              ? {
                                                  ...t,
                                                  workingOn: !t.workingOn,
                                                }
                                              : t,
                                          ),
                                        );
                                      }}
                                      showActions={true}
                                      draggable={true}
                                    />
                                  ))}
                                </div>
                              )}
                            </div>
                          )}
                        </>
                      );
                    }

                    // Special layout for Assigned Out - drag and drop between assignees
                    if (activeView === "assigned-out") {
                      // Tasks awaiting assignment (no assignee)
                      const awaitingTasks = viewTasks.filter(
                        (t) => !t.assignedTo && !t.assignee,
                      );

                      // Get list of team members who should appear as drop zones
                      const assigneeList = TEAM_MEMBERS.map((m) => m.name);

                      return (
                        <div className="space-y-6">
                          {/* Awaiting Assignment Drop Zone */}
                          <div
                            className="drop-zone bg-amber-900 bg-opacity-20 backdrop-blur rounded-xl p-6 border-2 border-dashed border-amber-500 border-opacity-50 min-h-[140px]"
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={(e) => {
                              e.preventDefault();
                              e.currentTarget.classList.remove("drag-over");
                              const taskId = parseInt(
                                e.dataTransfer.getData("taskId"),
                              );
                              const task = tasks.find((t) => t.id === taskId);
                              if (task) {
                                setTasks((prev) =>
                                  prev.map((t) =>
                                    t.id === taskId
                                      ? {
                                          ...t,
                                          assignee: "",
                                          assignedTo: "",
                                          isAssignedOut: true, // Keep it in assigned-out
                                        }
                                      : t,
                                  ),
                                );
                                // Mark task as staged if in staging mode
                                if (stagingMode) {
                                  setStagedTasks(
                                    (prev) => new Set([...prev, taskId]),
                                  );
                                  showNotification(
                                    `Task moved to Awaiting Assignment (staged)`,
                                    "info",
                                  );
                                } else {
                                  showNotification(
                                    `Task moved to Awaiting Assignment`,
                                    "info",
                                  );
                                }
                              }
                            }}
                          >
                            <div className="text-center">
                              <div className="text-4xl mb-2">‚è≥</div>
                              <div className="text-lg font-bold text-amber-300">
                                Awaiting Assignment
                              </div>
                              <div className="text-sm text-gray-300 mt-1">
                                Drag tasks here to unassign (
                                {awaitingTasks.length})
                              </div>
                            </div>
                            {awaitingTasks.length > 0 && (
                              <div className="mt-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                {awaitingTasks.map((task) => (
                                  <TaskCard
                                    key={task.id}
                                    task={task}
                                    isStaged={stagedTasks.has(task.id)}
                                    onEdit={handleEditTask}
                                    onDelete={handleDeleteTask}
                                    onToggleStar={handleToggleStar}
                                    onComplete={handleCompleteTask}
                                    onSave={handleSaveForLater}
                                    onAssign={handleAssignTask}
                                    onAssignToOther={handleAssignToOther}
                                    onSendToPool={handleSendToPool}
                                    assignees={assignees}
                                    showActions={true}
                                    draggable={true}
                                  />
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Assignee Drop Zones - collapsible sections */}
                          <div className="space-y-3">
                            {assigneeList.map((assignee) => {
                              const assigneeTasks = viewTasks.filter(
                                (t) =>
                                  t.assignedTo === assignee ||
                                  t.assignee === assignee,
                              );
                              const isExpanded =
                                assignedOutExpanded[assignee] !== false; // Default to expanded

                              // Only show if they have tasks
                              if (assigneeTasks.length === 0) return null;

                              return (
                                <div
                                  key={assignee}
                                  className="drop-zone bg-orange-900 bg-opacity-20 backdrop-blur rounded-xl border border-orange-700 border-opacity-50"
                                  onDragOver={handleDragOver}
                                  onDragLeave={handleDragLeave}
                                  onDrop={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.remove(
                                      "drag-over",
                                    );
                                    const taskId = parseInt(
                                      e.dataTransfer.getData("taskId"),
                                    );
                                    const task = tasks.find(
                                      (t) => t.id === taskId,
                                    );
                                    if (task) {
                                      setTasks((prev) =>
                                        prev.map((t) =>
                                          t.id === taskId
                                            ? {
                                                ...t,
                                                assignee: assignee,
                                                assignedTo: assignee,
                                                isAssignedOut: true,
                                              }
                                            : t,
                                        ),
                                      );
                                      // Mark task as staged if in staging mode
                                      if (stagingMode) {
                                        setStagedTasks(
                                          (prev) => new Set([...prev, taskId]),
                                        );
                                        showNotification(
                                          `Task assigned to ${assignee} (staged)`,
                                          "success",
                                        );
                                      } else {
                                        showNotification(
                                          `Task assigned to ${assignee}`,
                                          "success",
                                        );
                                      }
                                    }
                                  }}
                                >
                                  <button
                                    onClick={() =>
                                      setAssignedOutExpanded((prev) => ({
                                        ...prev,
                                        [assignee]: !isExpanded,
                                      }))
                                    }
                                    className="w-full px-6 py-4 flex items-center justify-between text-white hover:bg-orange-900 hover:bg-opacity-20 transition-all rounded-xl"
                                  >
                                    <div className="flex items-center gap-3">
                                      <span className="text-2xl">üë§</span>
                                      <span className="text-xl font-bold">
                                        {assignee}
                                      </span>
                                      <span className="px-3 py-1 bg-orange-600 rounded-full text-sm font-bold">
                                        {assigneeTasks.length}
                                      </span>
                                    </div>
                                    <span className="text-2xl">
                                      {isExpanded ? "‚ñ≤" : "‚ñº"}
                                    </span>
                                  </button>
                                  {isExpanded && (
                                    <div className="p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                      {assigneeTasks.map((task) => (
                                        <TaskCard
                                          key={task.id}
                                          task={task}
                                          isStaged={stagedTasks.has(task.id)}
                                          onEdit={handleEditTask}
                                          onDelete={handleDeleteTask}
                                          onToggleStar={handleToggleStar}
                                          onComplete={handleCompleteTask}
                                          onSave={handleSaveForLater}
                                          onAssign={handleAssignTask}
                                          onAssignToOther={handleAssignToOther}
                                          onSendToPool={handleSendToPool}
                                          assignees={assignees}
                                          showActions={true}
                                          draggable={true}
                                        />
                                      ))}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    }

                    // Special layout for Completed tasks - organized by type
                    if (activeView === "completed") {
                      const completedByType = {
                        myTasks: completedTasks.filter(
                          (t) =>
                            !t.isIncoming &&
                            !t.isAssignedOut &&
                            !t.isPoolRequest &&
                            !t.isTeamRequest &&
                            !t.isCampfire,
                        ),
                        incoming: completedTasks.filter((t) => t.isIncoming),
                        assignedOut: completedTasks.filter(
                          (t) => t.isAssignedOut,
                        ),
                        pool: completedTasks.filter((t) => t.isPoolRequest),
                        team: completedTasks.filter((t) => t.isTeamRequest),
                        campfire: completedTasks.filter((t) => t.isCampfire),
                      };

                      const types = [
                        {
                          key: "myTasks",
                          label: "üìã My Tasks",
                          count: completedByType.myTasks.length,
                          color: "bg-purple-900",
                        },
                        {
                          key: "incoming",
                          label: "üì• Incoming",
                          count: completedByType.incoming.length,
                          color: "bg-blue-900",
                        },
                        {
                          key: "assignedOut",
                          label: "üì§ Assigned Out",
                          count: completedByType.assignedOut.length,
                          color: "bg-orange-900",
                        },
                        {
                          key: "pool",
                          label: "üèä Pool",
                          count: completedByType.pool.length,
                          color: "bg-cyan-900",
                        },
                        {
                          key: "team",
                          label: "üéØ Requests",
                          count: completedByType.team.length,
                          color: "bg-green-900",
                        },
                        {
                          key: "campfire",
                          label: "üî• Campfire",
                          count: completedByType.campfire.length,
                          color: "bg-red-900",
                        },
                      ];

                      return (
                        <div className="space-y-3">
                          {types.map((type) => {
                            if (type.count === 0) return null;

                            return (
                              <div
                                key={type.key}
                                className={`${type.color} bg-opacity-20 backdrop-blur rounded-xl border border-gray-700 overflow-hidden`}
                              >
                                <button
                                  onClick={() =>
                                    setCompletedExpanded((prev) => ({
                                      ...prev,
                                      [type.key]: !prev[type.key],
                                    }))
                                  }
                                  className="w-full px-4 py-3 flex items-center justify-between text-white hover:bg-white hover:bg-opacity-5 transition-all"
                                >
                                  <div className="flex items-center gap-2">
                                    <span className="font-semibold">
                                      {type.label}
                                    </span>
                                    <span className="px-2 py-0.5 glass-element rounded text-xs font-bold">
                                      {type.count}
                                    </span>
                                  </div>
                                  <span className="text-lg">
                                    {completedExpanded[type.key] ? "‚ñ≤" : "‚ñº"}
                                  </span>
                                </button>
                                {completedExpanded[type.key] && (
                                  <div className="p-3 grid grid-cols-1 lg:grid-cols-2 gap-3 bg-black bg-opacity-20">
                                    {completedByType[type.key].map((task) => (
                                      <TaskCard
                                        key={task.id}
                                        task={task}
                                        isStaged={stagedTasks.has(task.id)}
                                        onEdit={handleEditTask}
                                        onDelete={handleDeleteTask}
                                        onToggleStar={handleToggleStar}
                                        onActivate={handleActivateTask}
                                        showActions={false}
                                        draggable={false}
                                      />
                                    ))}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      );
                    }

                    // Regular grid layout for other views
                    return (
                      <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                        {viewTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onComplete={handleCompleteTask}
                            onSave={handleSaveForLater}
                            onActivate={handleActivateTask}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            assignees={assignees}
                            showActions={activeView !== "completed"}
                            isIncoming={
                              activeView === "incoming" ||
                              activeView === "campfire"
                            }
                            draggable={false}
                          />
                        ))}
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* Saved for Later Section - VIEW SPECIFIC */}
              {(() => {
                const viewSavedTasks = (() => {
                  switch (activeView) {
                    case "my-tasks":
                      return savedTasks.filter(
                        (t) =>
                          !t.isIncoming &&
                          !t.isAssignedOut &&
                          !t.isPoolRequest &&
                          !t.isTeamRequest &&
                          !t.isCampfire,
                      );
                    case "campfire":
                      return savedTasks.filter((t) => t.isCampfire);
                    case "incoming":
                      return savedTasks.filter((t) => t.isIncoming);
                    case "assigned-out":
                      return savedTasks.filter((t) => t.isAssignedOut);
                    case "pool":
                      return savedTasks.filter((t) => t.isPoolRequest);
                    case "team":
                      return savedTasks.filter((t) => t.isTeamRequest);
                    default:
                      return [];
                  }
                })();

                if (
                  viewSavedTasks.length === 0 ||
                  activeView === "calendar" ||
                  activeView === "starred" ||
                  activeView === "completed"
                )
                  return null;

                return (
                  <div className="bg-blue-900/30 backdrop-blur rounded-xl border border-blue-700/50 overflow-hidden mt-4">
                    <button
                      onClick={() => setSavedExpanded(!savedExpanded)}
                      className="w-full px-6 py-4 flex items-center justify-between text-white hover:bg-blue-900/20 transition-all"
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">üíæ</span>
                        <span className="text-xl font-bold">
                          SAVED FOR LATER ({viewSavedTasks.length})
                        </span>
                      </div>
                      <span className="text-2xl">
                        {savedExpanded ? "‚ñ≤" : "‚ñº"}
                      </span>
                    </button>
                    {savedExpanded && (
                      <div className="p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                        {viewSavedTasks.map((task) => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            isStaged={stagedTasks.has(task.id)}
                            onEdit={handleEditTask}
                            onDelete={handleDeleteTask}
                            onToggleStar={handleToggleStar}
                            onActivate={handleActivateTask}
                            onUndo={handleUndoSaveForLater}
                            onAssign={handleAssignTask}
                            onAssignToOther={handleAssignToOther}
                            onSendToPool={handleSendToPool}
                            onCardClick={(task) => setExpandedTask(task)}
                            assignees={assignees}
                            showActions={true}
                            draggable={false}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>

            {/* Modals */}
            {showLoginModal && <LoginModal onLogin={handleLogin} />}

            {showAddTask && (
              <AddTaskModal
                onSave={handleAddTask}
                onClose={() => setShowAddTask(false)}
                assignees={assignees}
                categories={categories}
                currentUser={currentUser}
              />
            )}

            {editingTask && (
              <EditTaskModal
                task={editingTask}
                onSave={handleSaveTask}
                onClose={() => setEditingTask(null)}
                assignees={assignees}
                categories={categories}
              />
            )}

            {selectedCalendarDay && (
              <DayTasksModal
                dateStr={selectedCalendarDay}
                tasks={tasks}
                onClose={() => setSelectedCalendarDay(null)}
                onEditTask={handleEditTask}
              />
            )}

            {expandedTask && (
              <ExpandedTaskModal
                task={expandedTask}
                onClose={() => setExpandedTask(null)}
                onEdit={handleEditTask}
              />
            )}

            {showUpdateModal && updatingTask && (
              <div
                className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                onClick={() => setShowUpdateModal(false)}
              >
                <div
                  className="glass-panel rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide"
                  onClick={(e) => e.stopPropagation()}
                >
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-3xl font-bold text-white">
                      Task Updates - #{updatingTask.discordTaskNumber}
                    </h2>
                    <button
                      onClick={() => setShowUpdateModal(false)}
                      className="text-3xl text-white hover:text-gray-300 transition-colors"
                    >
                      ‚úï
                    </button>
                  </div>

                  <div className="mb-6">
                    <h3 className="text-xl text-white mb-2">
                      {updatingTask.name}
                    </h3>
                    <p className="text-gray-300 text-sm">
                      {updatingTask.notes}
                    </p>
                  </div>

                  {/* Add Update Form */}
                  <div className="mb-6 glass-panel p-4 rounded-lg border border-purple-500 border-opacity-30">
                    <h4 className="text-lg font-semibold text-white mb-3">
                      Add Status Update
                    </h4>
                    <form
                      onSubmit={(e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const updateText = formData.get("updateText");

                        if (!updateText.trim()) {
                          showNotification("Please enter an update", "error");
                          return;
                        }

                        fetch(
                          `http://localhost:5000/api/tasks/${updatingTask.discordTaskNumber}/updates`,
                          {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                              update_text: updateText,
                              updated_by: currentUser?.name || "Unknown",
                              updated_by_id: currentUser?.id || 0,
                            }),
                          },
                        )
                          .then((res) => res.json())
                          .then((data) => {
                            if (data.success) {
                              showNotification("‚úÖ Update added!", "success");
                              e.target.reset();
                              // Refresh updates
                              fetch(
                                `http://localhost:5000/api/tasks/${updatingTask.discordTaskNumber}/updates`,
                              )
                                .then((res) => res.json())
                                .then((data) => {
                                  setTaskUpdates((prev) => ({
                                    ...prev,
                                    [updatingTask.discordTaskNumber]:
                                      data.updates || [],
                                  }));
                                });
                            } else {
                              showNotification(
                                data.error || "Failed to add update",
                                "error",
                              );
                            }
                          })
                          .catch((err) => {
                            console.error("Error adding update:", err);
                            showNotification("Error adding update", "error");
                          });
                      }}
                    >
                      <textarea
                        name="updateText"
                        placeholder="What's the status? What are you working on?"
                        className="w-full px-4 py-3 bg-white bg-opacity-10 border border-white border-opacity-30 rounded-lg text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none mb-3"
                        rows="3"
                      ></textarea>
                      <button
                        type="submit"
                        className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-medium"
                      >
                        üìù Add Update
                      </button>
                    </form>
                  </div>

                  {/* Update History */}
                  <div>
                    <h4 className="text-lg font-semibold text-white mb-3">
                      Update History
                    </h4>
                    {taskUpdates[updatingTask.discordTaskNumber] &&
                    taskUpdates[updatingTask.discordTaskNumber].length > 0 ? (
                      <div className="space-y-3">
                        {taskUpdates[updatingTask.discordTaskNumber].map(
                          (update, idx) => (
                            <div
                              key={idx}
                              className="glass-panel p-4 rounded-lg border-l-4 border-purple-500"
                            >
                              <div className="flex items-start justify-between gap-2 mb-2">
                                <span className="font-semibold text-purple-400">
                                  {update.updated_by}
                                </span>
                                <span className="text-xs text-gray-500">
                                  {new Date(update.updated_at).toLocaleString()}
                                </span>
                              </div>
                              <p className="text-gray-200">
                                {update.update_text}
                              </p>
                            </div>
                          ),
                        )}
                      </div>
                    ) : (
                      <div className="text-center text-gray-400 py-8">
                        <p className="text-6xl mb-2">üìù</p>
                        <p>No updates yet</p>
                        <p className="text-sm mt-1">
                          Add the first status update above!
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {showTrash &&
              (() => {
                // Filter trash based on permissions
                const userConfig = currentUser
                  ? USER_CONFIG[currentUser.name] || DEFAULT_USER_CONFIG
                  : DEFAULT_USER_CONFIG;
                const visibleTrash = userConfig.canViewAllTrash
                  ? trashedTasks // Admins see all trash
                  : trashedTasks.filter(
                      (t) => t.deletedBy === currentUser?.name,
                    ); // Regular users see only their own trash

                return (
                  <div
                    className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                    onClick={() => setShowTrash(false)}
                  >
                    <div
                      className="glass-panel rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide"
                      onClick={(e) => e.stopPropagation()}
                    >
                      <div className="flex items-center justify-between mb-6">
                        <h2 className="text-3xl font-bold text-white">
                          üóëÔ∏è Trash ({visibleTrash.length})
                          {userConfig.canViewAllTrash && (
                            <span className="text-sm text-gray-300 ml-2">
                              (All users)
                            </span>
                          )}
                        </h2>
                        <button
                          onClick={() => setShowTrash(false)}
                          className="text-gray-300 hover:text-white text-2xl"
                        >
                          √ó
                        </button>
                      </div>

                      {visibleTrash.length === 0 ? (
                        <div className="text-center py-12">
                          <p className="text-gray-300 text-xl">
                            Trash is empty
                          </p>
                        </div>
                      ) : (
                        <>
                          <div className="space-y-3 mb-6">
                            {visibleTrash.map((task) => (
                              <div
                                key={task.id}
                                className="glass-element rounded-lg p-4 flex items-center justify-between hover:bg-white hover:bg-opacity-20 transition-all"
                              >
                                <div className="flex-1">
                                  <h4 className="text-white font-semibold">
                                    {task.name}
                                  </h4>
                                  <p className="text-gray-300 text-sm">
                                    Deleted{" "}
                                    {new Date(task.trashedAt).toLocaleString()}
                                  </p>
                                  {task.deletedBy && (
                                    <p className="text-red-400 text-sm mt-1">
                                      üóëÔ∏è Deleted by:{" "}
                                      <span className="font-semibold">
                                        {task.deletedBy}
                                      </span>
                                    </p>
                                  )}
                                </div>
                                <button
                                  onClick={() => handleUndoDelete(task.id)}
                                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all"
                                >
                                  ‚Ü©Ô∏è Restore
                                </button>
                              </div>
                            ))}
                          </div>
                          {userConfig.canViewAllTrash && (
                            <button
                              onClick={() => {
                                if (
                                  confirm(
                                    "Are you sure you want to permanently empty ALL trash (all users)? This cannot be undone.",
                                  )
                                ) {
                                  setTrashedTasks([]);
                                  showNotification("Trash emptied", "info");
                                }
                              }}
                              className="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
                            >
                              üóëÔ∏è Empty ALL Trash Permanently (All Users)
                            </button>
                          )}
                          {!userConfig.canViewAllTrash && (
                            <button
                              onClick={() => {
                                if (
                                  confirm(
                                    "Are you sure you want to permanently empty your trash? This cannot be undone.",
                                  )
                                ) {
                                  setTrashedTasks((prev) =>
                                    prev.filter(
                                      (t) => t.deletedBy !== currentUser?.name,
                                    ),
                                  );
                                  showNotification(
                                    "Your trash emptied",
                                    "info",
                                  );
                                }
                              }}
                              className="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
                            >
                              üóëÔ∏è Empty My Trash Permanently
                            </button>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                );
              })()}

            {/* Help Modal */}
            {showHelp && (
              <div
                className="modal-backdrop fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                onClick={() => setShowHelp(false)}
              >
                <div
                  className="glass-panel rounded-2xl p-8 max-w-5xl w-full max-h-[90vh] overflow-y-auto scrollbar-hide"
                  onClick={(e) => e.stopPropagation()}
                >
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-3xl font-bold text-white">
                      ‚ùì BottyOtty Help & Guides
                    </h2>
                    <button
                      onClick={() => setShowHelp(false)}
                      className="text-gray-300 hover:text-white text-2xl"
                    >
                      √ó
                    </button>
                  </div>

                  {/* Quick Start */}
                  <div className="bg-blue-900 bg-opacity-20 rounded-lg p-6 mb-6 border border-blue-500 border-opacity-30">
                    <h3 className="text-xl font-bold text-white mb-3">
                      üöÄ Quick Start
                    </h3>
                    <div className="text-gray-200 space-y-2">
                      <p>
                        <strong>New to BottyOtty?</strong> Here's how to get
                        started:
                      </p>
                      <ol className="list-decimal list-inside ml-2 space-y-1">
                        <li>
                          Check <strong>üì• Incoming</strong> tab for new tasks
                          assigned to you
                        </li>
                        <li>Click a task to see full details</li>
                        <li>
                          Use <strong>"Assign to Self"</strong> to claim tasks
                        </li>
                        <li>
                          Click <strong>‚úÖ Complete</strong> when done
                        </li>
                        <li>
                          Use <strong>üîÑ Sync</strong> button to update from
                          Discord
                        </li>
                      </ol>
                    </div>
                  </div>

                  {/* Common Tasks */}
                  <div className="glass-element rounded-lg p-6 mb-6">
                    <h3 className="text-xl font-bold text-white mb-4">
                      üìã Common Tasks
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <h4 className="text-green-400 font-semibold mb-2">
                          Creating a Task
                        </h4>
                        <p className="text-gray-200 text-sm">
                          Click <strong>‚ûï Task</strong> button ‚Üí Fill in
                          details ‚Üí Choose assignee ‚Üí Save
                        </p>
                      </div>
                      <div>
                        <h4 className="text-blue-400 font-semibold mb-2">
                          Assigning to Someone
                        </h4>
                        <p className="text-gray-200 text-sm">
                          Click task ‚Üí <strong>"Assign to Other"</strong> ‚Üí
                          Select team member ‚Üí Confirm
                        </p>
                      </div>
                      <div>
                        <h4 className="text-purple-400 font-semibold mb-2">
                          Finding Tasks
                        </h4>
                        <p className="text-gray-200 text-sm">
                          Use <strong>üîç Search</strong> bar or filter by
                          Category/Priority/User
                        </p>
                      </div>
                      <div>
                        <h4 className="text-yellow-400 font-semibold mb-2">
                          Restoring Deleted
                        </h4>
                        <p className="text-gray-200 text-sm">
                          Click <strong>üóëÔ∏è Trash</strong> ‚Üí Find task ‚Üí Click{" "}
                          <strong>‚Ü©Ô∏è Restore</strong>
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Tab Explanations */}
                  <div className="glass-element rounded-lg p-6 mb-6">
                    <h3 className="text-xl font-bold text-white mb-4">
                      üìë Tab Guide
                    </h3>
                    <div className="space-y-3 text-sm">
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üì•</span>
                        <div>
                          <strong className="text-white">Incoming</strong>
                          <p className="text-gray-200">
                            New tasks assigned to you that you haven't acted on
                            yet
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üìã</span>
                        <div>
                          <strong className="text-white">My Tasks</strong>
                          <p className="text-gray-200">
                            Your active tasks you're currently working on
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üì§</span>
                        <div>
                          <strong className="text-white">Assigned Out</strong>
                          <p className="text-gray-200">
                            Tasks you assigned to other team members
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üèä</span>
                        <div>
                          <strong className="text-white">Pool</strong>
                          <p className="text-gray-200">
                            Unassigned tasks available for anyone to claim
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üí¨</span>
                        <div>
                          <strong className="text-white">Mentions</strong>
                          <p className="text-gray-200">
                            Tasks where you're @mentioned in notes or comments
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">‚≠ê</span>
                        <div>
                          <strong className="text-white">Starred</strong>
                          <p className="text-gray-200">
                            Tasks you marked as important (click ‚≠ê on any task)
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">‚úÖ</span>
                        <div>
                          <strong className="text-white">Completed</strong>
                          <p className="text-gray-200">
                            Finished tasks (yours only, or everyone's if you
                            have permission)
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Permissions */}
                  <div className="bg-purple-900 bg-opacity-20 rounded-lg p-6 mb-6 border border-purple-500 border-opacity-30">
                    <h3 className="text-xl font-bold text-white mb-4">
                      üîê Your Permissions
                    </h3>
                    <div className="space-y-2 text-sm">
                      <div className="flex items-center gap-2">
                        {userConfig.canDeleteOwnTasks ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">
                          Delete your own tasks
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        {userConfig.canDeletePoolTasks ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">Delete pool tasks</span>
                      </div>
                      <div className="flex items-center gap-2">
                        {userConfig.canViewAllTrash ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">
                          View everyone's trash
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        {userConfig.canViewAllCompleted ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">
                          View everyone's completed tasks
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        {userConfig.canViewTeamActivity ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">
                          View team activity (all assignments)
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        {userConfig.canBulkImport ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">
                          Quick Launch access
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        {userConfig.isAdmin ? (
                          <span className="text-green-400">‚úÖ</span>
                        ) : (
                          <span className="text-red-400">‚ùå</span>
                        )}
                        <span className="text-gray-200">Admin access</span>
                      </div>
                    </div>
                    <p className="text-gray-300 text-xs mt-3">
                      Need different permissions? Ask your admin.
                    </p>
                  </div>

                  {/* User Guides */}
                  <div className="glass-element rounded-lg p-6 mb-6">
                    <h3 className="text-xl font-bold text-white mb-4">
                      üìö Full Documentation
                    </h3>
                    <p className="text-gray-200 mb-4">
                      For detailed guides, see these files in the{" "}
                      <code className="bg-gray-900 px-2 py-1 rounded">
                        docs/
                      </code>{" "}
                      folder:
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div className="glass-panel p-3 rounded">
                        <strong className="text-blue-400">
                          USER_GUIDE_EMPLOYEES.md
                        </strong>
                        <p className="text-gray-300 text-sm">
                          Discord bot usage for employees
                        </p>
                      </div>
                      <div className="glass-panel p-3 rounded">
                        <strong className="text-green-400">
                          USER_GUIDE_DASHBOARD.md
                        </strong>
                        <p className="text-gray-300 text-sm">
                          Complete Dashboard guide
                        </p>
                      </div>
                      <div className="glass-panel p-3 rounded">
                        <strong className="text-yellow-400">
                          USER_GUIDE_MANAGERS.md
                        </strong>
                        <p className="text-gray-300 text-sm">
                          Manager features & workflows
                        </p>
                      </div>
                      <div className="glass-panel p-3 rounded">
                        <strong className="text-purple-400">
                          USER_GUIDE_ADMINS.md
                        </strong>
                        <p className="text-gray-300 text-sm">
                          System administration guide
                        </p>
                      </div>
                      <div className="glass-panel p-3 rounded">
                        <strong className="text-pink-400">
                          REPORTS_GUIDE.md
                        </strong>
                        <p className="text-gray-300 text-sm">
                          Available reports & analytics
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Keyboard Shortcuts */}
                  <div className="glass-element rounded-lg p-6 mb-6">
                    <h3 className="text-xl font-bold text-white mb-4">
                      ‚å®Ô∏è Tips & Shortcuts
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                      <div className="text-gray-200">
                        <strong className="text-white">
                          üíæ Backup Regularly:
                        </strong>{" "}
                        Export weekly to avoid data loss
                      </div>
                      <div className="text-gray-200">
                        <strong className="text-white">
                          ‚≠ê Star Important:
                        </strong>{" "}
                        Quick access to critical tasks
                      </div>
                      <div className="text-gray-200">
                        <strong className="text-white">üîç Use Search:</strong>{" "}
                        Find tasks by name or content
                      </div>
                      <div className="text-gray-200">
                        <strong className="text-white">üîÑ Sync Often:</strong>{" "}
                        Keep Dashboard updated with Discord
                      </div>
                      <div className="text-gray-200">
                        <strong className="text-white">@Mention:</strong> Use
                        @name in notes to notify teammates
                      </div>
                      <div className="text-gray-200">
                        <strong className="text-white">
                          üóëÔ∏è Trash Recovery:
                        </strong>{" "}
                        Deleted by mistake? Restore from Trash
                      </div>
                    </div>
                  </div>

                  {/* Contact Support */}
                  <div className="bg-red-900 bg-opacity-20 rounded-lg p-6 border border-red-500 border-opacity-30">
                    <h3 className="text-xl font-bold text-white mb-3">
                      üÜò Need More Help?
                    </h3>
                    <div className="text-gray-200 space-y-2">
                      <p>
                        <strong>Questions?</strong> Ask your manager
                      </p>
                      <p>
                        <strong>Permission Changes?</strong> Contact your admin
                      </p>
                      <p>
                        <strong>Technical Issues?</strong> Report to system
                        administrator
                      </p>
                      <p>
                        <strong>Documentation:</strong> Check the{" "}
                        <code className="bg-gray-900 px-2 py-1 rounded">
                          docs/
                        </code>{" "}
                        folder for detailed guides
                      </p>
                    </div>
                  </div>

                  {/* Close Button */}
                  <button
                    onClick={() => setShowHelp(false)}
                    className="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition-all"
                  >
                    Got It!
                  </button>
                </div>
              </div>
            )}

            {/* Notifications */}
            {notification && (
              <Notification
                message={notification.message}
                type={notification.type}
                onClose={() => setNotification(null)}
              />
            )}

            {/* Backup Reminder (FIXED - only once per session) */}
            {showBackupReminder && (
              <BackupReminder
                onExport={exportTasks}
                onDismiss={() => setShowBackupReminder(false)}
              />
            )}

            {/* Toast Notification */}
            {toastMessage && (
              <div className="toast-notification">
                <div className="flex items-center gap-2">
                  <span className="text-lg">‚ú®</span>
                  <p className="font-medium">{toastMessage}</p>
                </div>
              </div>
            )}

            {/* Important Messages Widget */}
            {importantMessages.length > 0 &&
              (() => {
                const unreadCount = importantMessages.reduce((count, msg) => {
                  const readCount = msg.reactions ? msg.reactions.length : 0;
                  return count + (readCount === 0 ? 1 : 0);
                }, 0);

                if (unreadCount === 0) return null;

                return (
                  <div className="fixed bottom-6 right-6 z-40 max-w-sm">
                    <div className="glass-panel rounded-xl p-4 border-2 border-yellow-500 border-opacity-50 shadow-2xl">
                      <div className="flex items-start justify-between gap-3 mb-3">
                        <div className="flex items-center gap-2">
                          <span className="text-2xl animate-pulse">‚ö†Ô∏è</span>
                          <h3 className="text-lg font-bold text-white">
                            Important Messages
                          </h3>
                        </div>
                        <span className="px-2 py-1 bg-yellow-500 text-white text-xs rounded-full font-bold">
                          {unreadCount}
                        </span>
                      </div>
                      <p className="text-gray-300 text-sm mb-3">
                        You have {unreadCount} unread important message
                        {unreadCount !== 1 ? "s" : ""} that require
                        acknowledgment.
                      </p>
                      <div className="space-y-2 max-h-64 overflow-y-auto scrollbar-hide">
                        {importantMessages
                          .filter((msg) => {
                            const readCount = msg.reactions
                              ? msg.reactions.length
                              : 0;
                            return readCount === 0;
                          })
                          .map((msg, idx) => (
                            <div
                              key={idx}
                              className="glass-panel p-3 rounded-lg border-l-4 border-yellow-500"
                            >
                              <div className="flex items-start justify-between gap-2 mb-1">
                                <span className="text-xs font-semibold text-yellow-400">
                                  From {msg.author_name}
                                </span>
                                <span className="text-xs text-gray-500">
                                  {new Date(msg.posted_at).toLocaleDateString()}
                                </span>
                              </div>
                              <p className="text-gray-200 text-sm mb-2 line-clamp-2">
                                {msg.content_preview}
                              </p>
                              <button
                                onClick={() => {
                                  fetch(
                                    `http://localhost:5000/api/important-messages/${msg.message_id}/react`,
                                    {
                                      method: "POST",
                                      headers: {
                                        "Content-Type": "application/json",
                                      },
                                      body: JSON.stringify({
                                        user_name:
                                          currentUser?.name || "Unknown",
                                        user_id: currentUser?.id || 0,
                                      }),
                                    },
                                  )
                                    .then((res) => res.json())
                                    .then((data) => {
                                      if (data.success) {
                                        showNotification(
                                          "‚úÖ Message acknowledged!",
                                          "success",
                                        );
                                        // Refresh important messages
                                        fetch(
                                          "http://localhost:5000/api/important-messages",
                                        )
                                          .then((res) => res.json())
                                          .then((data) =>
                                            setImportantMessages(
                                              data.messages || [],
                                            ),
                                          )
                                          .catch((err) =>
                                            console.error(
                                              "Error refreshing messages:",
                                              err,
                                            ),
                                          );
                                      }
                                    })
                                    .catch((err) =>
                                      console.error(
                                        "Error acknowledging message:",
                                        err,
                                      ),
                                    );
                                }}
                                className="text-xs px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded transition-all font-medium"
                              >
                                üëÅÔ∏è Acknowledge
                              </button>
                            </div>
                          ))}
                      </div>
                    </div>
                  </div>
                );
              })()}

            {/* Refresh Overlay - Subtle indicator when content is updating */}
            {isRefreshing && <div className="refresh-overlay" />}
          </div>
        );
      }

      // Sticky Notes Component
      function StickyNotes() {
        const [isOpen, setIsOpen] = useState(false);
        const [notes, setNotes] = useState(() => {
          const saved = localStorage.getItem('bottyotty-sticky-notes');
          return saved ? JSON.parse(saved) : [];
        });
        const [draggedNote, setDraggedNote] = useState(null);
        const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

        const colors = ['yellow', 'pink', 'blue', 'green', 'purple', 'orange'];

        // Save notes to localStorage whenever they change
        useEffect(() => {
          localStorage.setItem('bottyotty-sticky-notes', JSON.stringify(notes));
        }, [notes]);

        // Add new note
        const addNote = (color) => {
          const newNote = {
            id: Date.now(),
            content: '',
            color: color,
            position: { x: 20 + (notes.length * 20) % 300, y: 20 + (notes.length * 20) % 400 },
            createdAt: new Date().toISOString()
          };
          setNotes([...notes, newNote]);
        };

        // Delete note
        const deleteNote = (id) => {
          setNotes(notes.filter(note => note.id !== id));
        };

        // Update note content
        const updateNote = (id, content) => {
          setNotes(notes.map(note =>
            note.id === id ? { ...note, content, updatedAt: new Date().toISOString() } : note
          ));
        };

        // Start dragging
        const handleMouseDown = (e, note) => {
          if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON') return;

          setDraggedNote(note);
          const rect = e.currentTarget.getBoundingClientRect();
          setDragOffset({
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
          });
        };

        // Handle drag
        const handleMouseMove = (e) => {
          if (!draggedNote) return;

          const container = document.querySelector('.sticky-notes-container');
          if (!container) return;

          const containerRect = container.getBoundingClientRect();
          const newX = e.clientX - containerRect.left - dragOffset.x;
          const newY = e.clientY - containerRect.top - dragOffset.y;

          setNotes(notes.map(note =>
            note.id === draggedNote.id
              ? { ...note, position: { x: Math.max(0, newX), y: Math.max(0, newY) } }
              : note
          ));
        };

        // End dragging
        const handleMouseUp = () => {
          setDraggedNote(null);
        };

        // Keyboard shortcuts
        useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.key === 'Escape' && isOpen) {
              setIsOpen(false);
            }
          };

          document.addEventListener('keydown', handleKeyDown);
          return () => document.removeEventListener('keydown', handleKeyDown);
        }, [isOpen]);

        // Add mouse event listeners for dragging
        useEffect(() => {
          if (draggedNote) {
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            return () => {
              document.removeEventListener('mousemove', handleMouseMove);
              document.removeEventListener('mouseup', handleMouseUp);
            };
          }
        }, [draggedNote, dragOffset, notes]);

        return (
          <>
            {/* Floating Toggle Button */}
            <button
              className="sticky-notes-toggle"
              onClick={() => setIsOpen(!isOpen)}
              title="Open Sticky Notes"
            >
              üìù
            </button>

            {/* Slide-out Panel */}
            <div className={`sticky-notes-panel ${isOpen ? 'open' : ''}`}>
              {/* Header */}
              <div className="sticky-notes-header">
                <h2>üìù Personal Notes</h2>
                <button
                  className="sticky-notes-close"
                  onClick={() => setIsOpen(false)}
                  title="Close"
                >
                  ‚úñ
                </button>
              </div>

              {/* Notes Container */}
              <div className="sticky-notes-container">
                {notes.map(note => (
                  <div
                    key={note.id}
                    className={`sticky-note ${note.color} ${draggedNote?.id === note.id ? 'dragging' : ''}`}
                    style={{
                      left: `${note.position.x}px`,
                      top: `${note.position.y}px`
                    }}
                    onMouseDown={(e) => handleMouseDown(e, note)}
                  >
                    <div className="sticky-note-header">
                      <span className="sticky-note-drag-handle">‚ãÆ‚ãÆ</span>
                      <button
                        className="sticky-note-delete"
                        onClick={() => deleteNote(note.id)}
                        title="Delete note"
                      >
                        ‚úñ
                      </button>
                    </div>
                    <textarea
                      className="sticky-note-content"
                      value={note.content}
                      onChange={(e) => updateNote(note.id, e.target.value)}
                      placeholder="Type your note here..."
                      rows={4}
                    />
                    <div className="sticky-note-timestamp">
                      {new Date(note.updatedAt || note.createdAt).toLocaleString(undefined, {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </div>
                  </div>
                ))}
                {notes.length === 0 && (
                  <div style={{ textAlign: 'center', color: '#999', padding: '40px', fontSize: '14px' }}>
                    Click a color below to add your first note!
                  </div>
                )}
              </div>

              {/* Add Note Buttons */}
              <div className="sticky-notes-add">
                {colors.map(color => (
                  <button
                    key={color}
                    onClick={() => addNote(color)}
                    style={{
                      background: color === 'yellow' ? '#ffd700' :
                                 color === 'pink' ? '#ff6b9d' :
                                 color === 'blue' ? '#4facfe' :
                                 color === 'green' ? '#43e97b' :
                                 color === 'purple' ? '#667eea' :
                                 '#fa709a',
                      color: color === 'yellow' || color === 'green' || color === 'orange' ? '#333' : '#fff'
                    }}
                    title={`Add ${color} note`}
                  >
                    + {color.charAt(0).toUpperCase() + color.slice(1)}
                  </button>
                ))}
              </div>
            </div>
          </>
        );
      }

      // Render
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<TaskManager />);

      // Render Sticky Notes separately
      const stickyNotesRoot = ReactDOM.createRoot(document.getElementById("sticky-notes-root"));
      stickyNotesRoot.render(<StickyNotes />);
    </script>
  </body>
</html>
